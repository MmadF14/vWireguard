{{define "title"}}
<span data-translate="Wireguard Clients">Wireguard Clients</span>
{{end}}

{{define "top_css"}}
<style>
    .paused-client {
        transition: transform .2s;
        cursor: pointer;
    }
    i[class^="paused-client"]:hover { transform: scale(1.5); }
</style>
{{end}}

{{define "username"}}
{{ .username }}
{{end}}

{{define "page_title"}}
<span data-translate="Wireguard Clients">Wireguard Clients</span>
{{end}}

{{define "page_content"}}
<section class="content">
    <div class="container-fluid">
        <!-- <h5 class="mt-4 mb-2">Wireguard Clients</h5> -->
        <div class="row mb-2">
            <div class="col-12 d-flex justify-content-end align-items-center">
                <div class="mr-3">
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="auto-refresh-toggle">
                        <label class="custom-control-label" for="auto-refresh-toggle" data-translate="Auto Refresh">Auto Refresh</label>
                    </div>
                </div>
                <select id="refresh-interval" class="form-control mr-2" style="width: auto;" disabled>
                    <option value="5" data-translate="5 seconds">5 seconds</option>
                    <option value="10" data-translate="10 seconds">10 seconds</option>
                    <option value="30" data-translate="30 seconds">30 seconds</option>
                    <option value="60" data-translate="60 seconds">60 seconds</option>
                </select>
                <button type="button" id="refresh-status-btn" class="btn btn-outline-secondary">
                    <i class="fas fa-sync-alt"></i> <span data-translate="Refresh Status">Refresh Status</span>
                </button>
            </div>
        </div>
        <div class="row" id="client-list">
        </div>
        <!-- /.row -->
    </div>
</section>

<div class="modal fade" id="modal_email_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Email Configuration">Email Configuration</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_email_client" id="frm_email_client">
                <div class="modal-body">
                    <input type="hidden" id="e_client_id" name="e_client_id">
                    <div class="form-group">
                        <label for="e_client_email" class="control-label" data-translate="Email address">Email address</label>
                        <input type="text" class="form-control" id="e_client_email" name="e_client_email">
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Send">Send</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_qr_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="QR Code">QR Code</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="qr_client_id" name="qr_client_id">
                <img id="qr_code" class="w-100" style="image-rendering: pixelated;" src="" alt="QR code" />
                <!-- do not include FwMark in any client configs: it is INVALID. -->
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_telegram_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Telegram Configuration">Telegram Configuration</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_telegram_client" id="frm_telegram_client">
                <div class="modal-body">
                    <input type="hidden" id="tg_client_id" name="tg_client_id">
                    <div class="form-group">
                        <label for="tg_client_userid" class="control-label" data-translate="Telegram userid">Telegram userid</label>
                        <input type="text" class="form-control" id="tg_client_userid" name="tg_client_userid">
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Send">Send</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_edit_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Edit Client">Edit Client</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_edit_client" id="frm_edit_client">
                <div class="modal-body">
                    <input type="hidden" id="_client_id" name="_client_id">
                    <div class="form-group">
                        <label for="_client_name" class="control-label" data-translate="Name">Name</label>
                        <input type="text" class="form-control" id="_client_name" name="_client_name">
                    </div>
                    <div class="form-group">
                        <label for="_client_email" class="control-label" data-translate="Email">Email</label>
                        <input type="text" class="form-control" id="_client_email" name="client_email">
                    </div>
                    <div class="form-group">
                        <label for="_client_quota" class="control-label" data-translate="Quota">Quota</label>
                        <select class="form-control" id="_quota_preset" onchange="updateQuotaInput()">
                            <option value="" data-translate="Select Quota">Select Quota</option>
                            <option value="10">10 GB</option>
                            <option value="20">20 GB</option>
                            <option value="30">30 GB</option>
                            <option value="40">40 GB</option>
                            <option value="50">50 GB</option>
                            <option value="100">100 GB</option>
                            <option value="200">200 GB</option>
                            <option value="500">500 GB</option>
                            <option value="1000">1 TB</option>
                            <option value="custom" data-translate="Custom">Custom</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="number" class="form-control" id="_client_quota" name="_client_quota" data-translate-placeholder="Enter custom quota in GB" placeholder="Enter custom quota in GB" step="0.1" min="0" />
                    </div>

                    <div class="form-group">
                        <label for="_client_expiration_days" class="control-label" data-translate="Expiration Days">Expiration Days</label>
                        <input type="number" class="form-control" id="_client_expiration_days" name="_client_expiration_days" placeholder="e.g. 30" min="0" />
                    </div>

                    <div class="form-group">
                        <label for="_client_allocated_ips" class="control-label" data-translate="IP Allocation">IP Allocation</label>
                        <input type="text" data-role="tagsinput" class="form-control" id="_client_allocated_ips">
                    </div>
                    <div class="form-group">
                        <label for="_client_endpoint" class="control-label" data-translate="Endpoint">Endpoint</label>
                        <input type="text" class="form-control" id="_client_endpoint" name="client_endpoint">
                    </div>
                    <div class="form-group" style="margin-top: 0.5rem;">
                        <label for="_client_telegram_userid" class="control-label" data-translate="Telegram userid">Telegram userid</label>
                        <input type="text" class="form-control" id="_client_telegram_userid" name="_client_telegram_userid">
                    </div>
                    <div class="form-group">
                        <label for="_additional_notes" class="control-label" data-translate="Notes">Notes</label>
                        <textarea class="form-control" style="min-height: 6rem;" id="_additional_notes" name="_additional_notes" data-translate-placeholder="Additional notes about this client" placeholder="Additional notes about this client"></textarea>
                    </div>
                    <div class="form-group">
                        <div class="icheck-primary d-inline">
                            <input type="checkbox" id="_use_server_dns">
                            <label for="_use_server_dns" data-translate="Use server DNS">
                                Use server DNS
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="icheck-primary d-inline">
                            <input type="checkbox" id="_enabled">
                            <label for="_enabled" data-translate="Enable this client">
                                Enable this client
                            </label>
                        </div>
                    </div>
                    <details>
                        <summary>
                            <strong data-translate="Public and Preshared Keys">Public and Preshared Keys</strong>
                            <i class="fas fa-info-circle" data-toggle="tooltip"
                               data-translate-title="Update the server stored client Public and Preshared keys."
                               data-original-title="Update the server stored client Public and Preshared keys.">
                            </i>
                        </summary>
                        <div class="form-group" style="margin-top: 1rem">
                            <label for="_client_public_key" class="control-label" data-translate="Public Key">
                                Public Key
                            </label>
                            <input type="text" class="form-control" id="_client_public_key" name="_client_public_key" aria-invalid="false">
                        </div>
                        <div class="form-group">
                            <label for="_client_preshared_key" class="control-label" data-translate="Preshared Key">
                                Preshared Key
                            </label>
                            <input type="text" class="form-control" id="_client_preshared_key" name="_client_preshared_key">
                        </div>
                    </details>
                    <details style="margin-top: 0.5rem;">
                        <summary>
                            <strong data-translate="Additional configuration">Additional configuration</strong>
                        </summary>
                        <div class="form-group">
                            <label for="_client_allowed_ips" class="control-label" data-translate="Allowed IPs">Allowed IPs</label>
                            <input type="text" data-role="tagsinput" class="form-control" id="_client_allowed_ips">
                        </div>
                        <div class="form-group">
                            <label for="_client_extra_allowed_ips" class="control-label" data-translate="Extra Allowed IPs">Extra Allowed IPs</label>
                            <input type="text" data-role="tagsinput" class="form-control"
                                   id="_client_extra_allowed_ips">
                        </div>
                        <div class="form-group">
                            <label for="_subnet_ranges" class="control-label" data-translate="Subnet range">Subnet range</label>
                            <select id="_subnet_ranges" class="select2"
                                    data-translate-placeholder="Select a subnet range"
                                    data-placeholder="Select a subnet range" style="width: 100%;">
                            </select>
                        </div>
                    </details>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Save">Save</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_pause_client">
    <div class="modal-dialog">
        <div class="modal-content bg-warning">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Disable">Disable</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-dark" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                <button type="button" class="btn btn-outline-dark" id="pause_client_confirm" data-translate="Apply">Apply</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_remove_client">
    <div class="modal-dialog">
        <div class="modal-content bg-danger">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Remove">Remove</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-dark" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                <button type="button" class="btn btn-outline-dark" id="remove_client_confirm" data-translate="Apply">Apply</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->
{{end}}

{{define "bottom_js"}}
    <script>
        function populateClientList() {
            console.log('Fetching clients list...');
            $("#client-list").empty();
            
            const tryFetchClients = (retryCount = 0) => {
                $.ajax({
                    cache: false,
                    method: 'GET',
                    url: '{{.basePath}}/api/clients',
                    dataType: 'json',
                    contentType: "application/json",
                    success: function(response) {
                        console.log('Raw server response:', response);
                        
                        if (!response) {
                            console.log('No response from server');
                            $("#client-list").html('<div class="col-12 text-center"><p>No clients found</p></div>');
                            return;
                        }

                        // اگر پاسخ به صورت رشته JSON باشد، آن را پارس کنیم
                        let data = response;
                        if (typeof response === 'string') {
                            try {
                                data = JSON.parse(response);
                            } catch (e) {
                                console.error('Error parsing JSON response:', e);
                                toastr.error('Error processing server response');
                                return;
                            }
                        }

                        // اگر داده‌ها آرایه باشند، مستقیماً آنها را رندر کنیم
                        if (Array.isArray(data)) {
                            console.log('Rendering array of clients:', data);
                            renderClientList(data);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        // اگر داده‌ها یک آبجکت باشند که شامل آرایه clients است
                        if (data.clients && Array.isArray(data.clients)) {
                            console.log('Rendering clients from data.clients:', data.clients);
                            renderClientList(data.clients);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        // اگر داده‌ها یک آبجکت باشند که شامل آرایه data است
                        if (data.data && Array.isArray(data.data)) {
                            console.log('Rendering clients from data.data:', data.data);
                            renderClientList(data.data);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        // اگر داده‌ها یک کلاینت منفرد باشند
                        if (data.Client || (data.name && data.id)) {
                            console.log('Rendering single client:', data);
                            renderClientList([data]);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        console.log('No valid client data found in response');
                        $("#client-list").html('<div class="col-12 text-center"><p>No clients found</p></div>');
                    },
                    error: function(jqXHR) {
                        console.error('Error fetching clients:', {
                            status: jqXHR.status,
                            statusText: jqXHR.statusText,
                            responseText: jqXHR.responseText
                        });
                        
                        if (retryCount < 3 && (jqXHR.status === 0 || jqXHR.status === 500)) {
                            setTimeout(() => tryFetchClients(retryCount + 1), 1000 * (retryCount + 1));
                            return;
                        }

                        let errorMessage = 'Failed to fetch clients';
                        if (jqXHR.responseText) {
                            try {
                                const responseJson = JSON.parse(jqXHR.responseText);
                                errorMessage = responseJson.message || errorMessage;
                            } catch (e) {
                                console.error('Error parsing error response:', e);
                            }
                        }
                        
                        toastr.error(errorMessage);
                        $("#client-list").html('<div class="col-12 text-center"><p>Error loading clients</p></div>');
                    }
                });
            };

            tryFetchClients();
        }

        function autoApplyConfig() {
            $("#apply_config_confirm").click();
        }

        let disableInProgress = false;

        function setClientStatus(clientID, status, isAutomatic = false) {
            if (!clientID) {
                console.error('Invalid client ID');
                return;
            }

            if (disableInProgress) {
                console.log('Status change already in progress, skipping');
                return;
            }

            disableInProgress = true;
            const trySetStatus = (retryCount = 0) => {
                $.ajax({
                    cache: false,
                    method: 'POST',
                    url: '{{.basePath}}/api/client/' + clientID + '/status/' + status,
                    dataType: 'json',
                    contentType: "application/json",
                    data: JSON.stringify({ 
                        enabled: status,
                        automatic: isAutomatic 
                    }),
                    success: function(data) {
                        console.log("Set client " + clientID + " status to " + status);
                        toastr.success('Client ' + (status ? 'enabled' : 'disabled') + ' successfully');
                        
                        const divElement = document.getElementById("paused_" + clientID);
                        if (divElement) {
                            divElement.style.visibility = status ? "hidden" : "visible";
                        }

                        if (!status && isAutomatic) {
                            applyWireGuardConfig();
                        }

                        populateClientList();
                        disableInProgress = false;
                    },
                    error: function(jqXHR) {
                        console.error('Error setting client status:', jqXHR.status);
                        if (retryCount < 3 && (jqXHR.status === 500 || jqXHR.status === 0)) {
                            setTimeout(() => trySetStatus(retryCount + 1), 1000 * (retryCount + 1));
                        } else {
                            let errorMessage = 'Error changing client status';
                            try {
                                const responseJson = jQuery.parseJSON(jqXHR.responseText);
                                errorMessage = responseJson.message || errorMessage;
                            } catch (e) {
                                console.error('Error parsing error response:', e);
                            }
                            toastr.error(errorMessage);
                            disableInProgress = false;
                        }
                    }
                });
            };

            trySetStatus();
        }

        function applyWireGuardConfig(retryCount = 0) {
            $.ajax({
                cache: false,
                method: 'POST',
                url: '{{.basePath}}/api/apply-wg-config',
                dataType: 'json',
                contentType: "application/json",
                success: function(data) {
                    toastr.success('Configuration applied successfully');
                    populateClientList();
                },
                error: function(jqXHR) {
                    console.error('Error applying config:', jqXHR.status);
                    if (retryCount < 3 && (jqXHR.status === 500 || jqXHR.status === 0)) {
                        setTimeout(() => applyWireGuardConfig(retryCount + 1), 1000 * (retryCount + 1));
                    } else {
                        let errorMessage = 'Error applying configuration';
                        try {
                            const responseJson = jQuery.parseJSON(jqXHR.responseText);
                            errorMessage = responseJson.message || errorMessage;
                        } catch (e) {
                            console.error('Error parsing error response:', e);
                        }
                        toastr.error(errorMessage);
                    }
                }
            });
        }

        function pauseClient(clientID) {
            setClientStatus(clientID, false);
        }

        function resumeClient(clientID) {
            setClientStatus(clientID, true);
        }

        function updateIPAllocationSuggestion() {
            const selectedSubnet = $('#subnet_ranges').val() || '__default_any__';
            
            // اگر درخواست قبلی هنوز در حال اجراست، از درخواست جدید جلوگیری کن
            if (updateIPAllocationSuggestion.isRunning) {
                console.log('Previous request is still running, skipping...');
                return;
            }

            console.log('Getting IP suggestions for subnet:', selectedSubnet);

            // Clear previous IPs
            $('#client_allocated_ips').importTags('');

            // تنظیم وضعیت درخواست
            updateIPAllocationSuggestion.isRunning = true;

            // Get IP suggestion from API with retry logic
            const tryGetSuggestions = (retryCount = 0) => {
                $.ajax({
                    cache: false,
                    method: 'GET',
                    url: '{{.basePath}}/api/suggest-client-ips',
                    data: { sr: selectedSubnet },
                    dataType: 'json',
                    contentType: "application/json",
                    success: function(response) {
                        console.log('Received IP suggestions:', response);
                        if (response && Array.isArray(response)) {
                            response.forEach(function(ip) {
                                if (ip) {
                                    $('#client_allocated_ips').addTag(ip);
                                }
                            });
                        } else {
                            console.warn('Invalid response format or no IPs available');
                        }
                        // پایان درخواست
                        updateIPAllocationSuggestion.isRunning = false;
                    },
                    error: function(jqXHR) {
                        console.error('Error getting IP suggestions:', jqXHR.status);
                        if (retryCount < 3 && (jqXHR.status === 503 || jqXHR.status === 0)) {
                            setTimeout(() => tryGetSuggestions(retryCount + 1), 1000 * (retryCount + 1));
                        } else {
                            let errorMessage = 'Failed to get IP suggestions';
                            try {
                                const responseJson = jQuery.parseJSON(jqXHR.responseText);
                                errorMessage = responseJson.message || errorMessage;
                            } catch (e) {
                                console.error('Error parsing error response:', e);
                            }
                            toastr.error(errorMessage);
                            // پایان درخواست در صورت خطا
                            updateIPAllocationSuggestion.isRunning = false;
                        }
                    }
                });
            };

            tryGetSuggestions();
        }

        // مقداردهی اولیه وضعیت درخواست
        updateIPAllocationSuggestion.isRunning = false;

        function updateSubnetRangesList(elementID, preselectedVal) {
            $.getJSON("{{.basePath}}/api/subnet-ranges", null, function(data) {
                $(`${elementID} option`).remove();
                $(elementID).append(
                    $("<option></option>")
                        .text("Any")
                        .val("__default_any__")
                );
                $.each(data, function(index, item) {
                    $(elementID).append(
                        $("<option></option>")
                            .text(item)
                            .val(item)
                    );
                    if (item === preselectedVal) {
                        console.log(preselectedVal);
                        $(elementID).val(preselectedVal).trigger('change')
                    }
                });
            });
        }

        function updateSearchList() {
            $.getJSON("{{.basePath}}/api/subnet-ranges", null, function(data) {
                $("#status-selector option").remove();
                $("#status-selector").append(
                    $("<option></option>")
                        .text("All")
                        .val("All"),
                    $("<option></option>")
                        .text("Enabled")
                        .val("Enabled"),
                    $("<option></option>")
                        .text("Disabled")
                        .val("Disabled"),
                    $("<option></option>")
                        .text("Connected")
                        .val("Connected"),
                    $("<option></option>")
                        .text("Disconnected")
                        .val("Disconnected")
                );
                $.each(data, function(index, item) {
                    $("#status-selector").append(
                        $("<option></option>")
                            .text(item)
                            .val(item)
                    );
                });
            });
        }
    </script>
</code_block_to_apply_changes_from>
</edit_instructions>


Assistant: <rewritten_file>
```
{{define "title"}}
<span data-translate="Wireguard Clients">Wireguard Clients</span>
{{end}}

{{define "top_css"}}
<style>
    .paused-client {
        transition: transform .2s;
        cursor: pointer;
    }
    i[class^="paused-client"]:hover { transform: scale(1.5); }
</style>
{{end}}

{{define "username"}}
{{ .username }}
{{end}}

{{define "page_title"}}
<span data-translate="Wireguard Clients">Wireguard Clients</span>
{{end}}

{{define "page_content"}}
<section class="content">
    <div class="container-fluid">
        <!-- <h5 class="mt-4 mb-2">Wireguard Clients</h5> -->
        <div class="row mb-2">
            <div class="col-12 d-flex justify-content-end align-items-center">
                <div class="mr-3">
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="auto-refresh-toggle">
                        <label class="custom-control-label" for="auto-refresh-toggle" data-translate="Auto Refresh">Auto Refresh</label>
                    </div>
                </div>
                <select id="refresh-interval" class="form-control mr-2" style="width: auto;" disabled>
                    <option value="5" data-translate="5 seconds">5 seconds</option>
                    <option value="10" data-translate="10 seconds">10 seconds</option>
                    <option value="30" data-translate="30 seconds">30 seconds</option>
                    <option value="60" data-translate="60 seconds">60 seconds</option>
                </select>
                <button type="button" id="refresh-status-btn" class="btn btn-outline-secondary">
                    <i class="fas fa-sync-alt"></i> <span data-translate="Refresh Status">Refresh Status</span>
                </button>
            </div>
        </div>
        <div class="row" id="client-list">
        </div>
        <!-- /.row -->
    </div>
</section>

<div class="modal fade" id="modal_email_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Email Configuration">Email Configuration</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_email_client" id="frm_email_client">
                <div class="modal-body">
                    <input type="hidden" id="e_client_id" name="e_client_id">
                    <div class="form-group">
                        <label for="e_client_email" class="control-label" data-translate="Email address">Email address</label>
                        <input type="text" class="form-control" id="e_client_email" name="e_client_email">
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Send">Send</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_qr_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="QR Code">QR Code</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="qr_client_id" name="qr_client_id">
                <img id="qr_code" class="w-100" style="image-rendering: pixelated;" src="" alt="QR code" />
                <!-- do not include FwMark in any client configs: it is INVALID. -->
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_telegram_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Telegram Configuration">Telegram Configuration</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_telegram_client" id="frm_telegram_client">
                <div class="modal-body">
                    <input type="hidden" id="tg_client_id" name="tg_client_id">
                    <div class="form-group">
                        <label for="tg_client_userid" class="control-label" data-translate="Telegram userid">Telegram userid</label>
                        <input type="text" class="form-control" id="tg_client_userid" name="tg_client_userid">
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Send">Send</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_edit_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Edit Client">Edit Client</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_edit_client" id="frm_edit_client">
                <div class="modal-body">
                    <input type="hidden" id="_client_id" name="_client_id">
                    <div class="form-group">
                        <label for="_client_name" class="control-label" data-translate="Name">Name</label>
                        <input type="text" class="form-control" id="_client_name" name="_client_name">
                    </div>
                    <div class="form-group">
                        <label for="_client_email" class="control-label" data-translate="Email">Email</label>
                        <input type="text" class="form-control" id="_client_email" name="client_email">
                    </div>
                    <div class="form-group">
                        <label for="_client_quota" class="control-label" data-translate="Quota">Quota</label>
                        <select class="form-control" id="_quota_preset" onchange="updateQuotaInput()">
                            <option value="" data-translate="Select Quota">Select Quota</option>
                            <option value="10">10 GB</option>
                            <option value="20">20 GB</option>
                            <option value="30">30 GB</option>
                            <option value="40">40 GB</option>
                            <option value="50">50 GB</option>
                            <option value="100">100 GB</option>
                            <option value="200">200 GB</option>
                            <option value="500">500 GB</option>
                            <option value="1000">1 TB</option>
                            <option value="custom" data-translate="Custom">Custom</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="number" class="form-control" id="_client_quota" name="_client_quota" data-translate-placeholder="Enter custom quota in GB" placeholder="Enter custom quota in GB" step="0.1" min="0" />
                    </div>

                    <div class="form-group">
                        <label for="_client_expiration_days" class="control-label" data-translate="Expiration Days">Expiration Days</label>
                        <input type="number" class="form-control" id="_client_expiration_days" name="_client_expiration_days" placeholder="e.g. 30" min="0" />
                    </div>

                    <div class="form-group">
                        <label for="_client_allocated_ips" class="control-label" data-translate="IP Allocation">IP Allocation</label>
                        <input type="text" data-role="tagsinput" class="form-control" id="_client_allocated_ips">
                    </div>
                    <div class="form-group">
                        <label for="_client_endpoint" class="control-label" data-translate="Endpoint">Endpoint</label>
                        <input type="text" class="form-control" id="_client_endpoint" name="client_endpoint">
                    </div>
                    <div class="form-group" style="margin-top: 0.5rem;">
                        <label for="_client_telegram_userid" class="control-label" data-translate="Telegram userid">Telegram userid</label>
                        <input type="text" class="form-control" id="_client_telegram_userid" name="_client_telegram_userid">
                    </div>
                    <div class="form-group">
                        <label for="_additional_notes" class="control-label" data-translate="Notes">Notes</label>
                        <textarea class="form-control" style="min-height: 6rem;" id="_additional_notes" name="_additional_notes" data-translate-placeholder="Additional notes about this client" placeholder="Additional notes about this client"></textarea>
                    </div>
                    <div class="form-group">
                        <div class="icheck-primary d-inline">
                            <input type="checkbox" id="_use_server_dns">
                            <label for="_use_server_dns" data-translate="Use server DNS">
                                Use server DNS
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="icheck-primary d-inline">
                            <input type="checkbox" id="_enabled">
                            <label for="_enabled" data-translate="Enable this client">
                                Enable this client
                            </label>
                        </div>
                    </div>
                    <details>
                        <summary>
                            <strong data-translate="Public and Preshared Keys">Public and Preshared Keys</strong>
                            <i class="fas fa-info-circle" data-toggle="tooltip"
                               data-translate-title="Update the server stored client Public and Preshared keys."
                               data-original-title="Update the server stored client Public and Preshared keys.">
                            </i>
                        </summary>
                        <div class="form-group" style="margin-top: 1rem">
                            <label for="_client_public_key" class="control-label" data-translate="Public Key">
                                Public Key
                            </label>
                            <input type="text" class="form-control" id="_client_public_key" name="_client_public_key" aria-invalid="false">
                        </div>
                        <div class="form-group">
                            <label for="_client_preshared_key" class="control-label" data-translate="Preshared Key">
                                Preshared Key
                            </label>
                            <input type="text" class="form-control" id="_client_preshared_key" name="_client_preshared_key">
                        </div>
                    </details>
                    <details style="margin-top: 0.5rem;">
                        <summary>
                            <strong data-translate="Additional configuration">Additional configuration</strong>
                        </summary>
                        <div class="form-group">
                            <label for="_client_allowed_ips" class="control-label" data-translate="Allowed IPs">Allowed IPs</label>
                            <input type="text" data-role="tagsinput" class="form-control" id="_client_allowed_ips">
                        </div>
                        <div class="form-group">
                            <label for="_client_extra_allowed_ips" class="control-label" data-translate="Extra Allowed IPs">Extra Allowed IPs</label>
                            <input type="text" data-role="tagsinput" class="form-control"
                                   id="_client_extra_allowed_ips">
                        </div>
                        <div class="form-group">
                            <label for="_subnet_ranges" class="control-label" data-translate="Subnet range">Subnet range</label>
                            <select id="_subnet_ranges" class="select2"
                                    data-translate-placeholder="Select a subnet range"
                                    data-placeholder="Select a subnet range" style="width: 100%;">
                            </select>
                        </div>
                    </details>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Save">Save</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_pause_client">
    <div class="modal-dialog">
        <div class="modal-content bg-warning">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Disable">Disable</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-dark" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                <button type="button" class="btn btn-outline-dark" id="pause_client_confirm" data-translate="Apply">Apply</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_remove_client">
    <div class="modal-dialog">
        <div class="modal-content bg-danger">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Remove">Remove</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-dark" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                <button type="button" class="btn btn-outline-dark" id="remove_client_confirm" data-translate="Apply">Apply</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->
{{end}}

{{define "bottom_js"}}
    <script>
        function populateClientList() {
            console.log('Fetching clients list...');
            $("#client-list").empty();
            
            const tryFetchClients = (retryCount = 0) => {
                $.ajax({
                    cache: false,
                    method: 'GET',
                    url: '{{.basePath}}/api/clients',
                    dataType: 'json',
                    contentType: "application/json",
                    success: function(response) {
                        console.log('Raw server response:', response);
                        
                        if (!response) {
                            console.log('No response from server');
                            $("#client-list").html('<div class="col-12 text-center"><p>No clients found</p></div>');
                            return;
                        }

                        // اگر پاسخ به صورت رشته JSON باشد، آن را پارس کنیم
                        let data = response;
                        if (typeof response === 'string') {
                            try {
                                data = JSON.parse(response);
                            } catch (e) {
                                console.error('Error parsing JSON response:', e);
                                toastr.error('Error processing server response');
                                return;
                            }
                        }

                        // اگر داده‌ها آرایه باشند، مستقیماً آنها را رندر کنیم
                        if (Array.isArray(data)) {
                            console.log('Rendering array of clients:', data);
                            renderClientList(data);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        // اگر داده‌ها یک آبجکت باشند که شامل آرایه clients است
                        if (data.clients && Array.isArray(data.clients)) {
                            console.log('Rendering clients from data.clients:', data.clients);
                            renderClientList(data.clients);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        // اگر داده‌ها یک آبجکت باشند که شامل آرایه data است
                        if (data.data && Array.isArray(data.data)) {
                            console.log('Rendering clients from data.data:', data.data);
                            renderClientList(data.data);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        // اگر داده‌ها یک کلاینت منفرد باشند
                        if (data.Client || (data.name && data.id)) {
                            console.log('Rendering single client:', data);
                            renderClientList([data]);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        console.log('No valid client data found in response');
                        $("#client-list").html('<div class="col-12 text-center"><p>No clients found</p></div>');
                    },
                    error: function(jqXHR) {
                        console.error('Error fetching clients:', {
                            status: jqXHR.status,
                            statusText: jqXHR.statusText,
                            responseText: jqXHR.responseText
                        });
                        
                        if (retryCount < 3 && (jqXHR.status === 0 || jqXHR.status === 500)) {
                            setTimeout(() => tryFetchClients(retryCount + 1), 1000 * (retryCount + 1));
                            return;
                        }

                        let errorMessage = 'Failed to fetch clients';
                        if (jqXHR.responseText) {
                            try {
                                const responseJson = JSON.parse(jqXHR.responseText);
                                errorMessage = responseJson.message || errorMessage;
                            } catch (e) {
                                console.error('Error parsing error response:', e);
                            }
                        }
                        
                        toastr.error(errorMessage);
                        $("#client-list").html('<div class="col-12 text-center"><p>Error loading clients</p></div>');
                    }
                });
            };

            tryFetchClients();
        }

        function autoApplyConfig() {
            $("#apply_config_confirm").click();
        }

        let disableInProgress = false;

        function setClientStatus(clientID, status, isAutomatic = false) {
            if (!clientID) {
                console.error('Invalid client ID');
                return;
            }

            if (disableInProgress) {
                console.log('Status change already in progress, skipping');
                return;
            }

            disableInProgress = true;
            const trySetStatus = (retryCount = 0) => {
                $.ajax({
                    cache: false,
                    method: 'POST',
                    url: '{{.basePath}}/api/client/' + clientID + '/status/' + status,
                    dataType: 'json',
                    contentType: "application/json",
                    data: JSON.stringify({ 
                        enabled: status,
                        automatic: isAutomatic 
                    }),
                    success: function(data) {
                        console.log("Set client " + clientID + " status to " + status);
                        toastr.success('Client ' + (status ? 'enabled' : 'disabled') + ' successfully');
                        
                        const divElement = document.getElementById("paused_" + clientID);
                        if (divElement) {
                            divElement.style.visibility = status ? "hidden" : "visible";
                        }

                        if (!status && isAutomatic) {
                            applyWireGuardConfig();
                        }

                        populateClientList();
                        disableInProgress = false;
                    },
                    error: function(jqXHR) {
                        console.error('Error setting client status:', jqXHR.status);
                        if (retryCount < 3 && (jqXHR.status === 500 || jqXHR.status === 0)) {
                            setTimeout(() => trySetStatus(retryCount + 1), 1000 * (retryCount + 1));
                        } else {
                            let errorMessage = 'Error changing client status';
                            try {
                                const responseJson = jQuery.parseJSON(jqXHR.responseText);
                                errorMessage = responseJson.message || errorMessage;
                            } catch (e) {
                                console.error('Error parsing error response:', e);
                            }
                            toastr.error(errorMessage);
                            disableInProgress = false;
                        }
                    }
                });
            };

            trySetStatus();
        }

        function applyWireGuardConfig(retryCount = 0) {
            $.ajax({
                cache: false,
                method: 'POST',
                url: '{{.basePath}}/api/apply-wg-config',
                dataType: 'json',
                contentType: "application/json",
                success: function(data) {
                    toastr.success('Configuration applied successfully');
                    populateClientList();
                },
                error: function(jqXHR) {
                    console.error('Error applying config:', jqXHR.status);
                    if (retryCount < 3 && (jqXHR.status === 500 || jqXHR.status === 0)) {
                        setTimeout(() => applyWireGuardConfig(retryCount + 1), 1000 * (retryCount + 1));
                    } else {
                        let errorMessage = 'Error applying configuration';
                        try {
                            const responseJson = jQuery.parseJSON(jqXHR.responseText);
                            errorMessage = responseJson.message || errorMessage;
                        } catch (e) {
                            console.error('Error parsing error response:', e);
                        }
                        toastr.error(errorMessage);
                    }
                }
            });
        }

        function pauseClient(clientID) {
            setClientStatus(clientID, false);
        }

        function resumeClient(clientID) {
            setClientStatus(clientID, true);
        }

        function updateIPAllocationSuggestion() {
            const selectedSubnet = $('#subnet_ranges').val() || '__default_any__';
            
            // اگر درخواست قبلی هنوز در حال اجراست، از درخواست جدید جلوگیری کن
            if (updateIPAllocationSuggestion.isRunning) {
                console.log('Previous request is still running, skipping...');
                return;
            }

            console.log('Getting IP suggestions for subnet:', selectedSubnet);

            // Clear previous IPs
            $('#client_allocated_ips').importTags('');

            // تنظیم وضعیت درخواست
            updateIPAllocationSuggestion.isRunning = true;

            // Get IP suggestion from API with retry logic
            const tryGetSuggestions = (retryCount = 0) => {
                $.ajax({
                    cache: false,
                    method: 'GET',
                    url: '{{.basePath}}/api/suggest-client-ips',
                    data: { sr: selectedSubnet },
                    dataType: 'json',
                    contentType: "application/json",
                    success: function(response) {
                        console.log('Received IP suggestions:', response);
                        if (response && Array.isArray(response)) {
                            response.forEach(function(ip) {
                                if (ip) {
                                    $('#client_allocated_ips').addTag(ip);
                                }
                            });
                        } else {
                            console.warn('Invalid response format or no IPs available');
                        }
                        // پایان درخواست
                        updateIPAllocationSuggestion.isRunning = false;
                    },
                    error: function(jqXHR) {
                        console.error('Error getting IP suggestions:', jqXHR.status);
                        if (retryCount < 3 && (jqXHR.status === 503 || jqXHR.status === 0)) {
                            setTimeout(() => tryGetSuggestions(retryCount + 1), 1000 * (retryCount + 1));
                        } else {
                            let errorMessage = 'Failed to get IP suggestions';
                            try {
                                const responseJson = jQuery.parseJSON(jqXHR.responseText);
                                errorMessage = responseJson.message || errorMessage;
                            } catch (e) {
                                console.error('Error parsing error response:', e);
                            }
                            toastr.error(errorMessage);
                            // پایان درخواست در صورت خطا
                            updateIPAllocationSuggestion.isRunning = false;
                        }
                    }
                });
            };

            tryGetSuggestions();
        }

        // مقداردهی اولیه وضعیت درخواست
        updateIPAllocationSuggestion.isRunning = false;

        function updateSubnetRangesList(elementID, preselectedVal) {
            $.getJSON("{{.basePath}}/api/subnet-ranges", null, function(data) {
                $(`${elementID} option`).remove();
                $(elementID).append(
                    $("<option></option>")
                        .text("Any")
                        .val("__default_any__")
                );
                $.each(data, function(index, item) {
                    $(elementID).append(
                        $("<option></option>")
                            .text(item)
                            .val(item)
                    );
                    if (item === preselectedVal) {
                        console.log(preselectedVal);
                        $(elementID).val(preselectedVal).trigger('change')
                    }
                });
            });
        }

        function updateSearchList() {
            $.getJSON("{{.basePath}}/api/subnet-ranges", null, function(data) {
                $("#status-selector option").remove();
                $("#status-selector").append(
                    $("<option></option>")
                        .text("All")
                        .val("All"),
                    $("<option></option>")
                        .text("Enabled")
                        .val("Enabled"),
                    $("<option></option>")
                        .text("Disabled")
                        .val("Disabled"),
                    $("<option></option>")
                        .text("Connected")
                        .val("Connected"),
                    $("<option></option>")
                        .text("Disconnected")
                        .val("Disconnected")
                );
                $.each(data, function(index, item) {
                    $("#status-selector").append(
                        $("<option></option>")
                            .text(item)
                            .val(item)
                    );
                });
            });
        }
    </script>
</code_block_to_apply_changes_from>
</edit_instructions>


Assistant: <rewritten_file>
```
{{define "title"}}
<span data-translate="Wireguard Clients">Wireguard Clients</span>
{{end}}

{{define "top_css"}}
<style>
    .paused-client {
        transition: transform .2s;
        cursor: pointer;
    }
    i[class^="paused-client"]:hover { transform: scale(1.5); }
</style>
{{end}}

{{define "username"}}
{{ .username }}
{{end}}

{{define "page_title"}}
<span data-translate="Wireguard Clients">Wireguard Clients</span>
{{end}}

{{define "page_content"}}
<section class="content">
    <div class="container-fluid">
        <!-- <h5 class="mt-4 mb-2">Wireguard Clients</h5> -->
        <div class="row mb-2">
            <div class="col-12 d-flex justify-content-end align-items-center">
                <div class="mr-3">
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="auto-refresh-toggle">
                        <label class="custom-control-label" for="auto-refresh-toggle" data-translate="Auto Refresh">Auto Refresh</label>
                    </div>
                </div>
                <select id="refresh-interval" class="form-control mr-2" style="width: auto;" disabled>
                    <option value="5" data-translate="5 seconds">5 seconds</option>
                    <option value="10" data-translate="10 seconds">10 seconds</option>
                    <option value="30" data-translate="30 seconds">30 seconds</option>
                    <option value="60" data-translate="60 seconds">60 seconds</option>
                </select>
                <button type="button" id="refresh-status-btn" class="btn btn-outline-secondary">
                    <i class="fas fa-sync-alt"></i> <span data-translate="Refresh Status">Refresh Status</span>
                </button>
            </div>
        </div>
        <div class="row" id="client-list">
        </div>
        <!-- /.row -->
    </div>
</section>

<div class="modal fade" id="modal_email_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Email Configuration">Email Configuration</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_email_client" id="frm_email_client">
                <div class="modal-body">
                    <input type="hidden" id="e_client_id" name="e_client_id">
                    <div class="form-group">
                        <label for="e_client_email" class="control-label" data-translate="Email address">Email address</label>
                        <input type="text" class="form-control" id="e_client_email" name="e_client_email">
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Send">Send</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_qr_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="QR Code">QR Code</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="qr_client_id" name="qr_client_id">
                <img id="qr_code" class="w-100" style="image-rendering: pixelated;" src="" alt="QR code" />
                <!-- do not include FwMark in any client configs: it is INVALID. -->
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_telegram_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Telegram Configuration">Telegram Configuration</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_telegram_client" id="frm_telegram_client">
                <div class="modal-body">
                    <input type="hidden" id="tg_client_id" name="tg_client_id">
                    <div class="form-group">
                        <label for="tg_client_userid" class="control-label" data-translate="Telegram userid">Telegram userid</label>
                        <input type="text" class="form-control" id="tg_client_userid" name="tg_client_userid">
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Send">Send</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_edit_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Edit Client">Edit Client</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_edit_client" id="frm_edit_client">
                <div class="modal-body">
                    <input type="hidden" id="_client_id" name="_client_id">
                    <div class="form-group">
                        <label for="_client_name" class="control-label" data-translate="Name">Name</label>
                        <input type="text" class="form-control" id="_client_name" name="_client_name">
                    </div>
                    <div class="form-group">
                        <label for="_client_email" class="control-label" data-translate="Email">Email</label>
                        <input type="text" class="form-control" id="_client_email" name="client_email">
                    </div>
                    <div class="form-group">
                        <label for="_client_quota" class="control-label" data-translate="Quota">Quota</label>
                        <select class="form-control" id="_quota_preset" onchange="updateQuotaInput()">
                            <option value="" data-translate="Select Quota">Select Quota</option>
                            <option value="10">10 GB</option>
                            <option value="20">20 GB</option>
                            <option value="30">30 GB</option>
                            <option value="40">40 GB</option>
                            <option value="50">50 GB</option>
                            <option value="100">100 GB</option>
                            <option value="200">200 GB</option>
                            <option value="500">500 GB</option>
                            <option value="1000">1 TB</option>
                            <option value="custom" data-translate="Custom">Custom</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="number" class="form-control" id="_client_quota" name="_client_quota" data-translate-placeholder="Enter custom quota in GB" placeholder="Enter custom quota in GB" step="0.1" min="0" />
                    </div>

                    <div class="form-group">
                        <label for="_client_expiration_days" class="control-label" data-translate="Expiration Days">Expiration Days</label>
                        <input type="number" class="form-control" id="_client_expiration_days" name="_client_expiration_days" placeholder="e.g. 30" min="0" />
                    </div>

                    <div class="form-group">
                        <label for="_client_allocated_ips" class="control-label" data-translate="IP Allocation">IP Allocation</label>
                        <input type="text" data-role="tagsinput" class="form-control" id="_client_allocated_ips">
                    </div>
                    <div class="form-group">
                        <label for="_client_endpoint" class="control-label" data-translate="Endpoint">Endpoint</label>
                        <input type="text" class="form-control" id="_client_endpoint" name="client_endpoint">
                    </div>
                    <div class="form-group" style="margin-top: 0.5rem;">
                        <label for="_client_telegram_userid" class="control-label" data-translate="Telegram userid">Telegram userid</label>
                        <input type="text" class="form-control" id="_client_telegram_userid" name="_client_telegram_userid">
                    </div>
                    <div class="form-group">
                        <label for="_additional_notes" class="control-label" data-translate="Notes">Notes</label>
                        <textarea class="form-control" style="min-height: 6rem;" id="_additional_notes" name="_additional_notes" data-translate-placeholder="Additional notes about this client" placeholder="Additional notes about this client"></textarea>
                    </div>
                    <div class="form-group">
                        <div class="icheck-primary d-inline">
                            <input type="checkbox" id="_use_server_dns">
                            <label for="_use_server_dns" data-translate="Use server DNS">
                                Use server DNS
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="icheck-primary d-inline">
                            <input type="checkbox" id="_enabled">
                            <label for="_enabled" data-translate="Enable this client">
                                Enable this client
                            </label>
                        </div>
                    </div>
                    <details>
                        <summary>
                            <strong data-translate="Public and Preshared Keys">Public and Preshared Keys</strong>
                            <i class="fas fa-info-circle" data-toggle="tooltip"
                               data-translate-title="Update the server stored client Public and Preshared keys."
                               data-original-title="Update the server stored client Public and Preshared keys.">
                            </i>
                        </summary>
                        <div class="form-group" style="margin-top: 1rem">
                            <label for="_client_public_key" class="control-label" data-translate="Public Key">
                                Public Key
                            </label>
                            <input type="text" class="form-control" id="_client_public_key" name="_client_public_key" aria-invalid="false">
                        </div>
                        <div class="form-group">
                            <label for="_client_preshared_key" class="control-label" data-translate="Preshared Key">
                                Preshared Key
                            </label>
                            <input type="text" class="form-control" id="_client_preshared_key" name="_client_preshared_key">
                        </div>
                    </details>
                    <details style="margin-top: 0.5rem;">
                        <summary>
                            <strong data-translate="Additional configuration">Additional configuration</strong>
                        </summary>
                        <div class="form-group">
                            <label for="_client_allowed_ips" class="control-label" data-translate="Allowed IPs">Allowed IPs</label>
                            <input type="text" data-role="tagsinput" class="form-control" id="_client_allowed_ips">
                        </div>
                        <div class="form-group">
                            <label for="_client_extra_allowed_ips" class="control-label" data-translate="Extra Allowed IPs">Extra Allowed IPs</label>
                            <input type="text" data-role="tagsinput" class="form-control"
                                   id="_client_extra_allowed_ips">
                        </div>
                        <div class="form-group">
                            <label for="_subnet_ranges" class="control-label" data-translate="Subnet range">Subnet range</label>
                            <select id="_subnet_ranges" class="select2"
                                    data-translate-placeholder="Select a subnet range"
                                    data-placeholder="Select a subnet range" style="width: 100%;">
                            </select>
                        </div>
                    </details>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Save">Save</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_pause_client">
    <div class="modal-dialog">
        <div class="modal-content bg-warning">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Disable">Disable</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-dark" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                <button type="button" class="btn btn-outline-dark" id="pause_client_confirm" data-translate="Apply">Apply</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_remove_client">
    <div class="modal-dialog">
        <div class="modal-content bg-danger">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Remove">Remove</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-dark" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                <button type="button" class="btn btn-outline-dark" id="remove_client_confirm" data-translate="Apply">Apply</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->
{{end}}

{{define "bottom_js"}}
    <script>
        function populateClientList() {
            console.log('Fetching clients list...');
            $("#client-list").empty();
            
            const tryFetchClients = (retryCount = 0) => {
                $.ajax({
                    cache: false,
                    method: 'GET',
                    url: '{{.basePath}}/api/clients',
                    dataType: 'json',
                    contentType: "application/json",
                    success: function(response) {
                        console.log('Raw server response:', response);
                        
                        if (!response) {
                            console.log('No response from server');
                            $("#client-list").html('<div class="col-12 text-center"><p>No clients found</p></div>');
                            return;
                        }

                        // اگر پاسخ به صورت رشته JSON باشد، آن را پارس کنیم
                        let data = response;
                        if (typeof response === 'string') {
                            try {
                                data = JSON.parse(response);
                            } catch (e) {
                                console.error('Error parsing JSON response:', e);
                                toastr.error('Error processing server response');
                                return;
                            }
                        }

                        // اگر داده‌ها آرایه باشند، مستقیماً آنها را رندر کنیم
                        if (Array.isArray(data)) {
                            console.log('Rendering array of clients:', data);
                            renderClientList(data);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        // اگر داده‌ها یک آبجکت باشند که شامل آرایه clients است
                        if (data.clients && Array.isArray(data.clients)) {
                            console.log('Rendering clients from data.clients:', data.clients);
                            renderClientList(data.clients);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        // اگر داده‌ها یک آبجکت باشند که شامل آرایه data است
                        if (data.data && Array.isArray(data.data)) {
                            console.log('Rendering clients from data.data:', data.data);
                            renderClientList(data.data);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        // اگر داده‌ها یک کلاینت منفرد باشند
                        if (data.Client || (data.name && data.id)) {
                            console.log('Rendering single client:', data);
                            renderClientList([data]);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        console.log('No valid client data found in response');
                        $("#client-list").html('<div class="col-12 text-center"><p>No clients found</p></div>');
                    },
                    error: function(jqXHR) {
                        console.error('Error fetching clients:', {
                            status: jqXHR.status,
                            statusText: jqXHR.statusText,
                            responseText: jqXHR.responseText
                        });
                        
                        if (retryCount < 3 && (jqXHR.status === 0 || jqXHR.status === 500)) {
                            setTimeout(() => tryFetchClients(retryCount + 1), 1000 * (retryCount + 1));
                            return;
                        }

                        let errorMessage = 'Failed to fetch clients';
                        if (jqXHR.responseText) {
                            try {
                                const responseJson = JSON.parse(jqXHR.responseText);
                                errorMessage = responseJson.message || errorMessage;
                            } catch (e) {
                                console.error('Error parsing error response:', e);
                            }
                        }
                        
                        toastr.error(errorMessage);
                        $("#client-list").html('<div class="col-12 text-center"><p>Error loading clients</p></div>');
                    }
                });
            };

            tryFetchClients();
        }

        function autoApplyConfig() {
            $("#apply_config_confirm").click();
        }

        let disableInProgress = false;

        function setClientStatus(clientID, status, isAutomatic = false) {
            if (!clientID) {
                console.error('Invalid client ID');
                return;
            }

            if (disableInProgress) {
                console.log('Status change already in progress, skipping');
                return;
            }

            disableInProgress = true;
            const trySetStatus = (retryCount = 0) => {
                $.ajax({
                    cache: false,
                    method: 'POST',
                    url: '{{.basePath}}/api/client/' + clientID + '/status/' + status,
                    dataType: 'json',
                    contentType: "application/json",
                    data: JSON.stringify({ 
                        enabled: status,
                        automatic: isAutomatic 
                    }),
                    success: function(data) {
                        console.log("Set client " + clientID + " status to " + status);
                        toastr.success('Client ' + (status ? 'enabled' : 'disabled') + ' successfully');
                        
                        const divElement = document.getElementById("paused_" + clientID);
                        if (divElement) {
                            divElement.style.visibility = status ? "hidden" : "visible";
                        }

                        if (!status && isAutomatic) {
                            applyWireGuardConfig();
                        }

                        populateClientList();
                        disableInProgress = false;
                    },
                    error: function(jqXHR) {
                        console.error('Error setting client status:', jqXHR.status);
                        if (retryCount < 3 && (jqXHR.status === 500 || jqXHR.status === 0)) {
                            setTimeout(() => trySetStatus(retryCount + 1), 1000 * (retryCount + 1));
                        } else {
                            let errorMessage = 'Error changing client status';
                            try {
                                const responseJson = jQuery.parseJSON(jqXHR.responseText);
                                errorMessage = responseJson.message || errorMessage;
                            } catch (e) {
                                console.error('Error parsing error response:', e);
                            }
                            toastr.error(errorMessage);
                            disableInProgress = false;
                        }
                    }
                });
            };

            trySetStatus();
        }

        function applyWireGuardConfig(retryCount = 0) {
            $.ajax({
                cache: false,
                method: 'POST',
                url: '{{.basePath}}/api/apply-wg-config',
                dataType: 'json',
                contentType: "application/json",
                success: function(data) {
                    toastr.success('Configuration applied successfully');
                    populateClientList();
                },
                error: function(jqXHR) {
                    console.error('Error applying config:', jqXHR.status);
                    if (retryCount < 3 && (jqXHR.status === 500 || jqXHR.status === 0)) {
                        setTimeout(() => applyWireGuardConfig(retryCount + 1), 1000 * (retryCount + 1));
                    } else {
                        let errorMessage = 'Error applying configuration';
                        try {
                            const responseJson = jQuery.parseJSON(jqXHR.responseText);
                            errorMessage = responseJson.message || errorMessage;
                        } catch (e) {
                            console.error('Error parsing error response:', e);
                        }
                        toastr.error(errorMessage);
                    }
                }
            });
        }

        function pauseClient(clientID) {
            setClientStatus(clientID, false);
        }

        function resumeClient(clientID) {
            setClientStatus(clientID, true);
        }

        function updateIPAllocationSuggestion() {
            const selectedSubnet = $('#subnet_ranges').val() || '__default_any__';
            
            // اگر درخواست قبلی هنوز در حال اجراست، از درخواست جدید جلوگیری کن
            if (updateIPAllocationSuggestion.isRunning) {
                console.log('Previous request is still running, skipping...');
                return;
            }

            console.log('Getting IP suggestions for subnet:', selectedSubnet);

            // Clear previous IPs
            $('#client_allocated_ips').importTags('');

            // تنظیم وضعیت درخواست
            updateIPAllocationSuggestion.isRunning = true;

            // Get IP suggestion from API with retry logic
            const tryGetSuggestions = (retryCount = 0) => {
                $.ajax({
                    cache: false,
                    method: 'GET',
                    url: '{{.basePath}}/api/suggest-client-ips',
                    data: { sr: selectedSubnet },
                    dataType: 'json',
                    contentType: "application/json",
                    success: function(response) {
                        console.log('Received IP suggestions:', response);
                        if (response && Array.isArray(response)) {
                            response.forEach(function(ip) {
                                if (ip) {
                                    $('#client_allocated_ips').addTag(ip);
                                }
                            });
                        } else {
                            console.warn('Invalid response format or no IPs available');
                        }
                        // پایان درخواست
                        updateIPAllocationSuggestion.isRunning = false;
                    },
                    error: function(jqXHR) {
                        console.error('Error getting IP suggestions:', jqXHR.status);
                        if (retryCount < 3 && (jqXHR.status === 503 || jqXHR.status === 0)) {
                            setTimeout(() => tryGetSuggestions(retryCount + 1), 1000 * (retryCount + 1));
                        } else {
                            let errorMessage = 'Failed to get IP suggestions';
                            try {
                                const responseJson = jQuery.parseJSON(jqXHR.responseText);
                                errorMessage = responseJson.message || errorMessage;
                            } catch (e) {
                                console.error('Error parsing error response:', e);
                            }
                            toastr.error(errorMessage);
                            // پایان درخواست در صورت خطا
                            updateIPAllocationSuggestion.isRunning = false;
                        }
                    }
                });
            };

            tryGetSuggestions();
        }

        // مقداردهی اولیه وضعیت درخواست
        updateIPAllocationSuggestion.isRunning = false;

        function updateSubnetRangesList(elementID, preselectedVal) {
            $.getJSON("{{.basePath}}/api/subnet-ranges", null, function(data) {
                $(`${elementID} option`).remove();
                $(elementID).append(
                    $("<option></option>")
                        .text("Any")
                        .val("__default_any__")
                );
                $.each(data, function(index, item) {
                    $(elementID).append(
                        $("<option></option>")
                            .text(item)
                            .val(item)
                    );
                    if (item === preselectedVal) {
                        console.log(preselectedVal);
                        $(elementID).val(preselectedVal).trigger('change')
                    }
                });
            });
        }

        function updateSearchList() {
            $.getJSON("{{.basePath}}/api/subnet-ranges", null, function(data) {
                $("#status-selector option").remove();
                $("#status-selector").append(
                    $("<option></option>")
                        .text("All")
                        .val("All"),
                    $("<option></option>")
                        .text("Enabled")
                        .val("Enabled"),
                    $("<option></option>")
                        .text("Disabled")
                        .val("Disabled"),
                    $("<option></option>")
                        .text("Connected")
                        .val("Connected"),
                    $("<option></option>")
                        .text("Disconnected")
                        .val("Disconnected")
                );
                $.each(data, function(index, item) {
                    $("#status-selector").append(
                        $("<option></option>")
                            .text(item)
                            .val(item)
                    );
                });
            });
        }
    </script>
</code_block_to_apply_changes_from>
</edit_instructions>


Assistant: <rewritten_file>
```
{{define "title"}}
<span data-translate="Wireguard Clients">Wireguard Clients</span>
{{end}}

{{define "top_css"}}
<style>
    .paused-client {
        transition: transform .2s;
        cursor: pointer;
    }
    i[class^="paused-client"]:hover { transform: scale(1.5); }
</style>
{{end}}

{{define "username"}}
{{ .username }}
{{end}}

{{define "page_title"}}
<span data-translate="Wireguard Clients">Wireguard Clients</span>
{{end}}

{{define "page_content"}}
<section class="content">
    <div class="container-fluid">
        <!-- <h5 class="mt-4 mb-2">Wireguard Clients</h5> -->
        <div class="row mb-2">
            <div class="col-12 d-flex justify-content-end align-items-center">
                <div class="mr-3">
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="auto-refresh-toggle">
                        <label class="custom-control-label" for="auto-refresh-toggle" data-translate="Auto Refresh">Auto Refresh</label>
                    </div>
                </div>
                <select id="refresh-interval" class="form-control mr-2" style="width: auto;" disabled>
                    <option value="5" data-translate="5 seconds">5 seconds</option>
                    <option value="10" data-translate="10 seconds">10 seconds</option>
                    <option value="30" data-translate="30 seconds">30 seconds</option>
                    <option value="60" data-translate="60 seconds">60 seconds</option>
                </select>
                <button type="button" id="refresh-status-btn" class="btn btn-outline-secondary">
                    <i class="fas fa-sync-alt"></i> <span data-translate="Refresh Status">Refresh Status</span>
                </button>
            </div>
        </div>
        <div class="row" id="client-list">
        </div>
        <!-- /.row -->
    </div>
</section>

<div class="modal fade" id="modal_email_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Email Configuration">Email Configuration</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_email_client" id="frm_email_client">
                <div class="modal-body">
                    <input type="hidden" id="e_client_id" name="e_client_id">
                    <div class="form-group">
                        <label for="e_client_email" class="control-label" data-translate="Email address">Email address</label>
                        <input type="text" class="form-control" id="e_client_email" name="e_client_email">
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Send">Send</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_qr_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="QR Code">QR Code</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="qr_client_id" name="qr_client_id">
                <img id="qr_code" class="w-100" style="image-rendering: pixelated;" src="" alt="QR code" />
                <!-- do not include FwMark in any client configs: it is INVALID. -->
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_telegram_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Telegram Configuration">Telegram Configuration</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_telegram_client" id="frm_telegram_client">
                <div class="modal-body">
                    <input type="hidden" id="tg_client_id" name="tg_client_id">
                    <div class="form-group">
                        <label for="tg_client_userid" class="control-label" data-translate="Telegram userid">Telegram userid</label>
                        <input type="text" class="form-control" id="tg_client_userid" name="tg_client_userid">
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Send">Send</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_edit_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Edit Client">Edit Client</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_edit_client" id="frm_edit_client">
                <div class="modal-body">
                    <input type="hidden" id="_client_id" name="_client_id">
                    <div class="form-group">
                        <label for="_client_name" class="control-label" data-translate="Name">Name</label>
                        <input type="text" class="form-control" id="_client_name" name="_client_name">
                    </div>
                    <div class="form-group">
                        <label for="_client_email" class="control-label" data-translate="Email">Email</label>
                        <input type="text" class="form-control" id="_client_email" name="client_email">
                    </div>
                    <div class="form-group">
                        <label for="_client_quota" class="control-label" data-translate="Quota">Quota</label>
                        <select class="form-control" id="_quota_preset" onchange="updateQuotaInput()">
                            <option value="" data-translate="Select Quota">Select Quota</option>
                            <option value="10">10 GB</option>
                            <option value="20">20 GB</option>
                            <option value="30">30 GB</option>
                            <option value="40">40 GB</option>
                            <option value="50">50 GB</option>
                            <option value="100">100 GB</option>
                            <option value="200">200 GB</option>
                            <option value="500">500 GB</option>
                            <option value="1000">1 TB</option>
                            <option value="custom" data-translate="Custom">Custom</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="number" class="form-control" id="_client_quota" name="_client_quota" data-translate-placeholder="Enter custom quota in GB" placeholder="Enter custom quota in GB" step="0.1" min="0" />
                    </div>

                    <div class="form-group">
                        <label for="_client_expiration_days" class="control-label" data-translate="Expiration Days">Expiration Days</label>
                        <input type="number" class="form-control" id="_client_expiration_days" name="_client_expiration_days" placeholder="e.g. 30" min="0" />
                    </div>

                    <div class="form-group">
                        <label for="_client_allocated_ips" class="control-label" data-translate="IP Allocation">IP Allocation</label>
                        <input type="text" data-role="tagsinput" class="form-control" id="_client_allocated_ips">
                    </div>
                    <div class="form-group">
                        <label for="_client_endpoint" class="control-label" data-translate="Endpoint">Endpoint</label>
                        <input type="text" class="form-control" id="_client_endpoint" name="client_endpoint">
                    </div>
                    <div class="form-group" style="margin-top: 0.5rem;">
                        <label for="_client_telegram_userid" class="control-label" data-translate="Telegram userid">Telegram userid</label>
                        <input type="text" class="form-control" id="_client_telegram_userid" name="_client_telegram_userid">
                    </div>
                    <div class="form-group">
                        <label for="_additional_notes" class="control-label" data-translate="Notes">Notes</label>
                        <textarea class="form-control" style="min-height: 6rem;" id="_additional_notes" name="_additional_notes" data-translate-placeholder="Additional notes about this client" placeholder="Additional notes about this client"></textarea>
                    </div>
                    <div class="form-group">
                        <div class="icheck-primary d-inline">
                            <input type="checkbox" id="_use_server_dns">
                            <label for="_use_server_dns" data-translate="Use server DNS">
                                Use server DNS
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="icheck-primary d-inline">
                            <input type="checkbox" id="_enabled">
                            <label for="_enabled" data-translate="Enable this client">
                                Enable this client
                            </label>
                        </div>
                    </div>
                    <details>
                        <summary>
                            <strong data-translate="Public and Preshared Keys">Public and Preshared Keys</strong>
                            <i class="fas fa-info-circle" data-toggle="tooltip"
                               data-translate-title="Update the server stored client Public and Preshared keys."
                               data-original-title="Update the server stored client Public and Preshared keys.">
                            </i>
                        </summary>
                        <div class="form-group" style="margin-top: 1rem">
                            <label for="_client_public_key" class="control-label" data-translate="Public Key">
                                Public Key
                            </label>
                            <input type="text" class="form-control" id="_client_public_key" name="_client_public_key" aria-invalid="false">
                        </div>
                        <div class="form-group">
                            <label for="_client_preshared_key" class="control-label" data-translate="Preshared Key">
                                Preshared Key
                            </label>
                            <input type="text" class="form-control" id="_client_preshared_key" name="_client_preshared_key">
                        </div>
                    </details>
                    <details style="margin-top: 0.5rem;">
                        <summary>
                            <strong data-translate="Additional configuration">Additional configuration</strong>
                        </summary>
                        <div class="form-group">
                            <label for="_client_allowed_ips" class="control-label" data-translate="Allowed IPs">Allowed IPs</label>
                            <input type="text" data-role="tagsinput" class="form-control" id="_client_allowed_ips">
                        </div>
                        <div class="form-group">
                            <label for="_client_extra_allowed_ips" class="control-label" data-translate="Extra Allowed IPs">Extra Allowed IPs</label>
                            <input type="text" data-role="tagsinput" class="form-control"
                                   id="_client_extra_allowed_ips">
                        </div>
                        <div class="form-group">
                            <label for="_subnet_ranges" class="control-label" data-translate="Subnet range">Subnet range</label>
                            <select id="_subnet_ranges" class="select2"
                                    data-translate-placeholder="Select a subnet range"
                                    data-placeholder="Select a subnet range" style="width: 100%;">
                            </select>
                        </div>
                    </details>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Save">Save</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_pause_client">
    <div class="modal-dialog">
        <div class="modal-content bg-warning">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Disable">Disable</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-dark" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                <button type="button" class="btn btn-outline-dark" id="pause_client_confirm" data-translate="Apply">Apply</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_remove_client">
    <div class="modal-dialog">
        <div class="modal-content bg-danger">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Remove">Remove</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-dark" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                <button type="button" class="btn btn-outline-dark" id="remove_client_confirm" data-translate="Apply">Apply</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->
{{end}}

{{define "bottom_js"}}
    <script>
        function populateClientList() {
            console.log('Fetching clients list...');
            $("#client-list").empty();
            
            const tryFetchClients = (retryCount = 0) => {
                $.ajax({
                    cache: false,
                    method: 'GET',
                    url: '{{.basePath}}/api/clients',
                    dataType: 'json',
                    contentType: "application/json",
                    success: function(response) {
                        console.log('Raw server response:', response);
                        
                        if (!response) {
                            console.log('No response from server');
                            $("#client-list").html('<div class="col-12 text-center"><p>No clients found</p></div>');
                            return;
                        }

                        // اگر پاسخ به صورت رشته JSON باشد، آن را پارس کنیم
                        let data = response;
                        if (typeof response === 'string') {
                            try {
                                data = JSON.parse(response);
                            } catch (e) {
                                console.error('Error parsing JSON response:', e);
                                toastr.error('Error processing server response');
                                return;
                            }
                        }

                        // اگر داده‌ها آرایه باشند، مستقیماً آنها را رندر کنیم
                        if (Array.isArray(data)) {
                            console.log('Rendering array of clients:', data);
                            renderClientList(data);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        // اگر داده‌ها یک آبجکت باشند که شامل آرایه clients است
                        if (data.clients && Array.isArray(data.clients)) {
                            console.log('Rendering clients from data.clients:', data.clients);
                            renderClientList(data.clients);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        // اگر داده‌ها یک آبجکت باشند که شامل آرایه data است
                        if (data.data && Array.isArray(data.data)) {
                            console.log('Rendering clients from data.data:', data.data);
                            renderClientList(data.data);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        // اگر داده‌ها یک کلاینت منفرد باشند
                        if (data.Client || (data.name && data.id)) {
                            console.log('Rendering single client:', data);
                            renderClientList([data]);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        console.log('No valid client data found in response');
                        $("#client-list").html('<div class="col-12 text-center"><p>No clients found</p></div>');
                    },
                    error: function(jqXHR) {
                        console.error('Error fetching clients:', {
                            status: jqXHR.status,
                            statusText: jqXHR.statusText,
                            responseText: jqXHR.responseText
                        });
                        
                        if (retryCount < 3 && (jqXHR.status === 0 || jqXHR.status === 500)) {
                            setTimeout(() => tryFetchClients(retryCount + 1), 1000 * (retryCount + 1));
                            return;
                        }

                        let errorMessage = 'Failed to fetch clients';
                        if (jqXHR.responseText) {
                            try {
                                const responseJson = JSON.parse(jqXHR.responseText);
                                errorMessage = responseJson.message || errorMessage;
                            } catch (e) {
                                console.error('Error parsing error response:', e);
                            }
                        }
                        
                        toastr.error(errorMessage);
                        $("#client-list").html('<div class="col-12 text-center"><p>Error loading clients</p></div>');
                    }
                });
            };

            tryFetchClients();
        }

        function autoApplyConfig() {
            $("#apply_config_confirm").click();
        }

        let disableInProgress = false;

        function setClientStatus(clientID, status, isAutomatic = false) {
            if (!clientID) {
                console.error('Invalid client ID');
                return;
            }

            if (disableInProgress) {
                console.log('Status change already in progress, skipping');
                return;
            }

            disableInProgress = true;
            const trySetStatus = (retryCount = 0) => {
                $.ajax({
                    cache: false,
                    method: 'POST',
                    url: '{{.basePath}}/api/client/' + clientID + '/status/' + status,
                    dataType: 'json',
                    contentType: "application/json",
                    data: JSON.stringify({ 
                        enabled: status,
                        automatic: isAutomatic 
                    }),
                    success: function(data) {
                        console.log("Set client " + clientID + " status to " + status);
                        toastr.success('Client ' + (status ? 'enabled' : 'disabled') + ' successfully');
                        
                        const divElement = document.getElementById("paused_" + clientID);
                        if (divElement) {
                            divElement.style.visibility = status ? "hidden" : "visible";
                        }

                        if (!status && isAutomatic) {
                            applyWireGuardConfig();
                        }

                        populateClientList();
                        disableInProgress = false;
                    },
                    error: function(jqXHR) {
                        console.error('Error setting client status:', jqXHR.status);
                        if (retryCount < 3 && (jqXHR.status === 500 || jqXHR.status === 0)) {
                            setTimeout(() => trySetStatus(retryCount + 1), 1000 * (retryCount + 1));
                        } else {
                            let errorMessage = 'Error changing client status';
                            try {
                                const responseJson = jQuery.parseJSON(jqXHR.responseText);
                                errorMessage = responseJson.message || errorMessage;
                            } catch (e) {
                                console.error('Error parsing error response:', e);
                            }
                            toastr.error(errorMessage);
                            disableInProgress = false;
                        }
                    }
                });
            };

            trySetStatus();
        }

        function applyWireGuardConfig(retryCount = 0) {
            $.ajax({
                cache: false,
                method: 'POST',
                url: '{{.basePath}}/api/apply-wg-config',
                dataType: 'json',
                contentType: "application/json",
                success: function(data) {
                    toastr.success('Configuration applied successfully');
                    populateClientList();
                },
                error: function(jqXHR) {
                    console.error('Error applying config:', jqXHR.status);
                    if (retryCount < 3 && (jqXHR.status === 500 || jqXHR.status === 0)) {
                        setTimeout(() => applyWireGuardConfig(retryCount + 1), 1000 * (retryCount + 1));
                    } else {
                        let errorMessage = 'Error applying configuration';
                        try {
                            const responseJson = jQuery.parseJSON(jqXHR.responseText);
                            errorMessage = responseJson.message || errorMessage;
                        } catch (e) {
                            console.error('Error parsing error response:', e);
                        }
                        toastr.error(errorMessage);
                    }
                }
            });
        }

        function pauseClient(clientID) {
            setClientStatus(clientID, false);
        }

        function resumeClient(clientID) {
            setClientStatus(clientID, true);
        }

        function updateIPAllocationSuggestion() {
            const selectedSubnet = $('#subnet_ranges').val() || '__default_any__';
            
            // اگر درخواست قبلی هنوز در حال اجراست، از درخواست جدید جلوگیری کن
            if (updateIPAllocationSuggestion.isRunning) {
                console.log('Previous request is still running, skipping...');
                return;
            }

            console.log('Getting IP suggestions for subnet:', selectedSubnet);

            // Clear previous IPs
            $('#client_allocated_ips').importTags('');

            // تنظیم وضعیت درخواست
            updateIPAllocationSuggestion.isRunning = true;

            // Get IP suggestion from API with retry logic
            const tryGetSuggestions = (retryCount = 0) => {
                $.ajax({
                    cache: false,
                    method: 'GET',
                    url: '{{.basePath}}/api/suggest-client-ips',
                    data: { sr: selectedSubnet },
                    dataType: 'json',
                    contentType: "application/json",
                    success: function(response) {
                        console.log('Received IP suggestions:', response);
                        if (response && Array.isArray(response)) {
                            response.forEach(function(ip) {
                                if (ip) {
                                    $('#client_allocated_ips').addTag(ip);
                                }
                            });
                        } else {
                            console.warn('Invalid response format or no IPs available');
                        }
                        // پایان درخواست
                        updateIPAllocationSuggestion.isRunning = false;
                    },
                    error: function(jqXHR) {
                        console.error('Error getting IP suggestions:', jqXHR.status);
                        if (retryCount < 3 && (jqXHR.status === 503 || jqXHR.status === 0)) {
                            setTimeout(() => tryGetSuggestions(retryCount + 1), 1000 * (retryCount + 1));
                        } else {
                            let errorMessage = 'Failed to get IP suggestions';
                            try {
                                const responseJson = jQuery.parseJSON(jqXHR.responseText);
                                errorMessage = responseJson.message || errorMessage;
                            } catch (e) {
                                console.error('Error parsing error response:', e);
                            }
                            toastr.error(errorMessage);
                            // پایان درخواست در صورت خطا
                            updateIPAllocationSuggestion.isRunning = false;
                        }
                    }
                });
            };

            tryGetSuggestions();
        }

        // مقداردهی اولیه وضعیت درخواست
        updateIPAllocationSuggestion.isRunning = false;

        function updateSubnetRangesList(elementID, preselectedVal) {
            $.getJSON("{{.basePath}}/api/subnet-ranges", null, function(data) {
                $(`${elementID} option`).remove();
                $(elementID).append(
                    $("<option></option>")
                        .text("Any")
                        .val("__default_any__")
                );
                $.each(data, function(index, item) {
                    $(elementID).append(
                        $("<option></option>")
                            .text(item)
                            .val(item)
                    );
                    if (item === preselectedVal) {
                        console.log(preselectedVal);
                        $(elementID).val(preselectedVal).trigger('change')
                    }
                });
            });
        }

        function updateSearchList() {
            $.getJSON("{{.basePath}}/api/subnet-ranges", null, function(data) {
                $("#status-selector option").remove();
                $("#status-selector").append(
                    $("<option></option>")
                        .text("All")
                        .val("All"),
                    $("<option></option>")
                        .text("Enabled")
                        .val("Enabled"),
                    $("<option></option>")
                        .text("Disabled")
                        .val("Disabled"),
                    $("<option></option>")
                        .text("Connected")
                        .val("Connected"),
                    $("<option></option>")
                        .text("Disconnected")
                        .val("Disconnected")
                );
                $.each(data, function(index, item) {
                    $("#status-selector").append(
                        $("<option></option>")
                            .text(item)
                            .val(item)
                    );
                });
            });
        }
    </script>
</code_block_to_apply_changes_from>
</edit_instructions>


Assistant: <rewritten_file>
```
{{define "title"}}
<span data-translate="Wireguard Clients">Wireguard Clients</span>
{{end}}

{{define "top_css"}}
<style>
    .paused-client {
        transition: transform .2s;
        cursor: pointer;
    }
    i[class^="paused-client"]:hover { transform: scale(1.5); }
</style>
{{end}}

{{define "username"}}
{{ .username }}
{{end}}

{{define "page_title"}}
<span data-translate="Wireguard Clients">Wireguard Clients</span>
{{end}}

{{define "page_content"}}
<section class="content">
    <div class="container-fluid">
        <!-- <h5 class="mt-4 mb-2">Wireguard Clients</h5> -->
        <div class="row mb-2">
            <div class="col-12 d-flex justify-content-end align-items-center">
                <div class="mr-3">
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="auto-refresh-toggle">
                        <label class="custom-control-label" for="auto-refresh-toggle" data-translate="Auto Refresh">Auto Refresh</label>
                    </div>
                </div>
                <select id="refresh-interval" class="form-control mr-2" style="width: auto;" disabled>
                    <option value="5" data-translate="5 seconds">5 seconds</option>
                    <option value="10" data-translate="10 seconds">10 seconds</option>
                    <option value="30" data-translate="30 seconds">30 seconds</option>
                    <option value="60" data-translate="60 seconds">60 seconds</option>
                </select>
                <button type="button" id="refresh-status-btn" class="btn btn-outline-secondary">
                    <i class="fas fa-sync-alt"></i> <span data-translate="Refresh Status">Refresh Status</span>
                </button>
            </div>
        </div>
        <div class="row" id="client-list">
        </div>
        <!-- /.row -->
    </div>
</section>

<div class="modal fade" id="modal_email_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Email Configuration">Email Configuration</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_email_client" id="frm_email_client">
                <div class="modal-body">
                    <input type="hidden" id="e_client_id" name="e_client_id">
                    <div class="form-group">
                        <label for="e_client_email" class="control-label" data-translate="Email address">Email address</label>
                        <input type="text" class="form-control" id="e_client_email" name="e_client_email">
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Send">Send</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_qr_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="QR Code">QR Code</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="qr_client_id" name="qr_client_id">
                <img id="qr_code" class="w-100" style="image-rendering: pixelated;" src="" alt="QR code" />
                <!-- do not include FwMark in any client configs: it is INVALID. -->
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_telegram_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Telegram Configuration">Telegram Configuration</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_telegram_client" id="frm_telegram_client">
                <div class="modal-body">
                    <input type="hidden" id="tg_client_id" name="tg_client_id">
                    <div class="form-group">
                        <label for="tg_client_userid" class="control-label" data-translate="Telegram userid">Telegram userid</label>
                        <input type="text" class="form-control" id="tg_client_userid" name="tg_client_userid">
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Send">Send</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_edit_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Edit Client">Edit Client</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_edit_client" id="frm_edit_client">
                <div class="modal-body">
                    <input type="hidden" id="_client_id" name="_client_id">
                    <div class="form-group">
                        <label for="_client_name" class="control-label" data-translate="Name">Name</label>
                        <input type="text" class="form-control" id="_client_name" name="_client_name">
                    </div>
                    <div class="form-group">
                        <label for="_client_email" class="control-label" data-translate="Email">Email</label>
                        <input type="text" class="form-control" id="_client_email" name="client_email">
                    </div>
                    <div class="form-group">
                        <label for="_client_quota" class="control-label" data-translate="Quota">Quota</label>
                        <select class="form-control" id="_quota_preset" onchange="updateQuotaInput()">
                            <option value="" data-translate="Select Quota">Select Quota</option>
                            <option value="10">10 GB</option>
                            <option value="20">20 GB</option>
                            <option value="30">30 GB</option>
                            <option value="40">40 GB</option>
                            <option value="50">50 GB</option>
                            <option value="100">100 GB</option>
                            <option value="200">200 GB</option>
                            <option value="500">500 GB</option>
                            <option value="1000">1 TB</option>
                            <option value="custom" data-translate="Custom">Custom</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="number" class="form-control" id="_client_quota" name="_client_quota" data-translate-placeholder="Enter custom quota in GB" placeholder="Enter custom quota in GB" step="0.1" min="0" />
                    </div>

                    <div class="form-group">
                        <label for="_client_expiration_days" class="control-label" data-translate="Expiration Days">Expiration Days</label>
                        <input type="number" class="form-control" id="_client_expiration_days" name="_client_expiration_days" placeholder="e.g. 30" min="0" />
                    </div>

                    <div class="form-group">
                        <label for="_client_allocated_ips" class="control-label" data-translate="IP Allocation">IP Allocation</label>
                        <input type="text" data-role="tagsinput" class="form-control" id="_client_allocated_ips">
                    </div>
                    <div class="form-group">
                        <label for="_client_endpoint" class="control-label" data-translate="Endpoint">Endpoint</label>
                        <input type="text" class="form-control" id="_client_endpoint" name="client_endpoint">
                    </div>
                    <div class="form-group" style="margin-top: 0.5rem;">
                        <label for="_client_telegram_userid" class="control-label" data-translate="Telegram userid">Telegram userid</label>
                        <input type="text" class="form-control" id="_client_telegram_userid" name="_client_telegram_userid">
                    </div>
                    <div class="form-group">
                        <label for="_additional_notes" class="control-label" data-translate="Notes">Notes</label>
                        <textarea class="form-control" style="min-height: 6rem;" id="_additional_notes" name="_additional_notes" data-translate-placeholder="Additional notes about this client" placeholder="Additional notes about this client"></textarea>
                    </div>
                    <div class="form-group">
                        <div class="icheck-primary d-inline">
                            <input type="checkbox" id="_use_server_dns">
                            <label for="_use_server_dns" data-translate="Use server DNS">
                                Use server DNS
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="icheck-primary d-inline">
                            <input type="checkbox" id="_enabled">
                            <label for="_enabled" data-translate="Enable this client">
                                Enable this client
                            </label>
                        </div>
                    </div>
                    <details>
                        <summary>
                            <strong data-translate="Public and Preshared Keys">Public and Preshared Keys</strong>
                            <i class="fas fa-info-circle" data-toggle="tooltip"
                               data-translate-title="Update the server stored client Public and Preshared keys."
                               data-original-title="Update the server stored client Public and Preshared keys.">
                            </i>
                        </summary>
                        <div class="form-group" style="margin-top: 1rem">
                            <label for="_client_public_key" class="control-label" data-translate="Public Key">
                                Public Key
                            </label>
                            <input type="text" class="form-control" id="_client_public_key" name="_client_public_key" aria-invalid="false">
                        </div>
                        <div class="form-group">
                            <label for="_client_preshared_key" class="control-label" data-translate="Preshared Key">
                                Preshared Key
                            </label>
                            <input type="text" class="form-control" id="_client_preshared_key" name="_client_preshared_key">
                        </div>
                    </details>
                    <details style="margin-top: 0.5rem;">
                        <summary>
                            <strong data-translate="Additional configuration">Additional configuration</strong>
                        </summary>
                        <div class="form-group">
                            <label for="_client_allowed_ips" class="control-label" data-translate="Allowed IPs">Allowed IPs</label>
                            <input type="text" data-role="tagsinput" class="form-control" id="_client_allowed_ips">
                        </div>
                        <div class="form-group">
                            <label for="_client_extra_allowed_ips" class="control-label" data-translate="Extra Allowed IPs">Extra Allowed IPs</label>
                            <input type="text" data-role="tagsinput" class="form-control"
                                   id="_client_extra_allowed_ips">
                        </div>
                        <div class="form-group">
                            <label for="_subnet_ranges" class="control-label" data-translate="Subnet range">Subnet range</label>
                            <select id="_subnet_ranges" class="select2"
                                    data-translate-placeholder="Select a subnet range"
                                    data-placeholder="Select a subnet range" style="width: 100%;">
                            </select>
                        </div>
                    </details>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Save">Save</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_pause_client">
    <div class="modal-dialog">
        <div class="modal-content bg-warning">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Disable">Disable</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-dark" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                <button type="button" class="btn btn-outline-dark" id="pause_client_confirm" data-translate="Apply">Apply</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_remove_client">
    <div class="modal-dialog">
        <div class="modal-content bg-danger">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Remove">Remove</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-dark" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                <button type="button" class="btn btn-outline-dark" id="remove_client_confirm" data-translate="Apply">Apply</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->
{{end}}

{{define "bottom_js"}}
    <script>
        function populateClientList() {
            console.log('Fetching clients list...');
            $("#client-list").empty();
            
            const tryFetchClients = (retryCount = 0) => {
                $.ajax({
                    cache: false,
                    method: 'GET',
                    url: '{{.basePath}}/api/clients',
                    dataType: 'json',
                    contentType: "application/json",
                    success: function(response) {
                        console.log('Raw server response:', response);
                        
                        if (!response) {
                            console.log('No response from server');
                            $("#client-list").html('<div class="col-12 text-center"><p>No clients found</p></div>');
                            return;
                        }

                        // اگر پاسخ به صورت رشته JSON باشد، آن را پارس کنیم
                        let data = response;
                        if (typeof response === 'string') {
                            try {
                                data = JSON.parse(response);
                            } catch (e) {
                                console.error('Error parsing JSON response:', e);
                                toastr.error('Error processing server response');
                                return;
                            }
                        }

                        // اگر داده‌ها آرایه باشند، مستقیماً آنها را رندر کنیم
                        if (Array.isArray(data)) {
                            console.log('Rendering array of clients:', data);
                            renderClientList(data);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        // اگر داده‌ها یک آبجکت باشند که شامل آرایه clients است
                        if (data.clients && Array.isArray(data.clients)) {
                            console.log('Rendering clients from data.clients:', data.clients);
                            renderClientList(data.clients);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        // اگر داده‌ها یک آبجکت باشند که شامل آرایه data است
                        if (data.data && Array.isArray(data.data)) {
                            console.log('Rendering clients from data.data:', data.data);
                            renderClientList(data.data);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        // اگر داده‌ها یک کلاینت منفرد باشند
                        if (data.Client || (data.name && data.id)) {
                            console.log('Rendering single client:', data);
                            renderClientList([data]);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        console.log('No valid client data found in response');
                        $("#client-list").html('<div class="col-12 text-center"><p>No clients found</p></div>');
                    },
                    error: function(jqXHR) {
                        console.error('Error fetching clients:', {
                            status: jqXHR.status,
                            statusText: jqXHR.statusText,
                            responseText: jqXHR.responseText
                        });
                        
                        if (retryCount < 3 && (jqXHR.status === 0 || jqXHR.status === 500)) {
                            setTimeout(() => tryFetchClients(retryCount + 1), 1000 * (retryCount + 1));
                            return;
                        }

                        let errorMessage = 'Failed to fetch clients';
                        if (jqXHR.responseText) {
                            try {
                                const responseJson = JSON.parse(jqXHR.responseText);
                                errorMessage = responseJson.message || errorMessage;
                            } catch (e) {
                                console.error('Error parsing error response:', e);
                            }
                        }
                        
                        toastr.error(errorMessage);
                        $("#client-list").html('<div class="col-12 text-center"><p>Error loading clients</p></div>');
                    }
                });
            };

            tryFetchClients();
        }

        function autoApplyConfig() {
            $("#apply_config_confirm").click();
        }

        let disableInProgress = false;

        function setClientStatus(clientID, status, isAutomatic = false) {
            if (!clientID) {
                console.error('Invalid client ID');
                return;
            }

            if (disableInProgress) {
                console.log('Status change already in progress, skipping');
                return;
            }

            disableInProgress = true;
            const trySetStatus = (retryCount = 0) => {
                $.ajax({
                    cache: false,
                    method: 'POST',
                    url: '{{.basePath}}/api/client/' + clientID + '/status/' + status,
                    dataType: 'json',
                    contentType: "application/json",
                    data: JSON.stringify({ 
                        enabled: status,
                        automatic: isAutomatic 
                    }),
                    success: function(data) {
                        console.log("Set client " + clientID + " status to " + status);
                        toastr.success('Client ' + (status ? 'enabled' : 'disabled') + ' successfully');
                        
                        const divElement = document.getElementById("paused_" + clientID);
                        if (divElement) {
                            divElement.style.visibility = status ? "hidden" : "visible";
                        }

                        if (!status && isAutomatic) {
                            applyWireGuardConfig();
                        }

                        populateClientList();
                        disableInProgress = false;
                    },
                    error: function(jqXHR) {
                        console.error('Error setting client status:', jqXHR.status);
                        if (retryCount < 3 && (jqXHR.status === 500 || jqXHR.status === 0)) {
                            setTimeout(() => trySetStatus(retryCount + 1), 1000 * (retryCount + 1));
                        } else {
                            let errorMessage = 'Error changing client status';
                            try {
                                const responseJson = jQuery.parseJSON(jqXHR.responseText);
                                errorMessage = responseJson.message || errorMessage;
                            } catch (e) {
                                console.error('Error parsing error response:', e);
                            }
                            toastr.error(errorMessage);
                            disableInProgress = false;
                        }
                    }
                });
            };

            trySetStatus();
        }

        function applyWireGuardConfig(retryCount = 0) {
            $.ajax({
                cache: false,
                method: 'POST',
                url: '{{.basePath}}/api/apply-wg-config',
                dataType: 'json',
                contentType: "application/json",
                success: function(data) {
                    toastr.success('Configuration applied successfully');
                    populateClientList();
                },
                error: function(jqXHR) {
                    console.error('Error applying config:', jqXHR.status);
                    if (retryCount < 3 && (jqXHR.status === 500 || jqXHR.status === 0)) {
                        setTimeout(() => applyWireGuardConfig(retryCount + 1), 1000 * (retryCount + 1));
                    } else {
                        let errorMessage = 'Error applying configuration';
                        try {
                            const responseJson = jQuery.parseJSON(jqXHR.responseText);
                            errorMessage = responseJson.message || errorMessage;
                        } catch (e) {
                            console.error('Error parsing error response:', e);
                        }
                        toastr.error(errorMessage);
                    }
                }
            });
        }

        function pauseClient(clientID) {
            setClientStatus(clientID, false);
        }

        function resumeClient(clientID) {
            setClientStatus(clientID, true);
        }

        function updateIPAllocationSuggestion() {
            const selectedSubnet = $('#subnet_ranges').val() || '__default_any__';
            
            // اگر درخواست قبلی هنوز در حال اجراست، از درخواست جدید جلوگیری کن
            if (updateIPAllocationSuggestion.isRunning) {
                console.log('Previous request is still running, skipping...');
                return;
            }

            console.log('Getting IP suggestions for subnet:', selectedSubnet);

            // Clear previous IPs
            $('#client_allocated_ips').importTags('');

            // تنظیم وضعیت درخواست
            updateIPAllocationSuggestion.isRunning = true;

            // Get IP suggestion from API with retry logic
            const tryGetSuggestions = (retryCount = 0) => {
                $.ajax({
                    cache: false,
                    method: 'GET',
                    url: '{{.basePath}}/api/suggest-client-ips',
                    data: { sr: selectedSubnet },
                    dataType: 'json',
                    contentType: "application/json",
                    success: function(response) {
                        console.log('Received IP suggestions:', response);
                        if (response && Array.isArray(response)) {
                            response.forEach(function(ip) {
                                if (ip) {
                                    $('#client_allocated_ips').addTag(ip);
                                }
                            });
                        } else {
                            console.warn('Invalid response format or no IPs available');
                        }
                        // پایان درخواست
                        updateIPAllocationSuggestion.isRunning = false;
                    },
                    error: function(jqXHR) {
                        console.error('Error getting IP suggestions:', jqXHR.status);
                        if (retryCount < 3 && (jqXHR.status === 503 || jqXHR.status === 0)) {
                            setTimeout(() => tryGetSuggestions(retryCount + 1), 1000 * (retryCount + 1));
                        } else {
                            let errorMessage = 'Failed to get IP suggestions';
                            try {
                                const responseJson = jQuery.parseJSON(jqXHR.responseText);
                                errorMessage = responseJson.message || errorMessage;
                            } catch (e) {
                                console.error('Error parsing error response:', e);
                            }
                            toastr.error(errorMessage);
                            // پایان درخواست در صورت خطا
                            updateIPAllocationSuggestion.isRunning = false;
                        }
                    }
                });
            };

            tryGetSuggestions();
        }

        // مقداردهی اولیه وضعیت درخواست
        updateIPAllocationSuggestion.isRunning = false;

        function updateSubnetRangesList(elementID, preselectedVal) {
            $.getJSON("{{.basePath}}/api/subnet-ranges", null, function(data) {
                $(`${elementID} option`).remove();
                $(elementID).append(
                    $("<option></option>")
                        .text("Any")
                        .val("__default_any__")
                );
                $.each(data, function(index, item) {
                    $(elementID).append(
                        $("<option></option>")
                            .text(item)
                            .val(item)
                    );
                    if (item === preselectedVal) {
                        console.log(preselectedVal);
                        $(elementID).val(preselectedVal).trigger('change')
                    }
                });
            });
        }

        function updateSearchList() {
            $.getJSON("{{.basePath}}/api/subnet-ranges", null, function(data) {
                $("#status-selector option").remove();
                $("#status-selector").append(
                    $("<option></option>")
                        .text("All")
                        .val("All"),
                    $("<option></option>")
                        .text("Enabled")
                        .val("Enabled"),
                    $("<option></option>")
                        .text("Disabled")
                        .val("Disabled"),
                    $("<option></option>")
                        .text("Connected")
                        .val("Connected"),
                    $("<option></option>")
                        .text("Disconnected")
                        .val("Disconnected")
                );
                $.each(data, function(index, item) {
                    $("#status-selector").append(
                        $("<option></option>")
                            .text(item)
                            .val(item)
                    );
                });
            });
        }
    </script>
</code_block_to_apply_changes_from>
</edit_instructions>


Assistant: <rewritten_file>
```
{{define "title"}}
<span data-translate="Wireguard Clients">Wireguard Clients</span>
{{end}}

{{define "top_css"}}
<style>
    .paused-client {
        transition: transform .2s;
        cursor: pointer;
    }
    i[class^="paused-client"]:hover { transform: scale(1.5); }
</style>
{{end}}

{{define "username"}}
{{ .username }}
{{end}}

{{define "page_title"}}
<span data-translate="Wireguard Clients">Wireguard Clients</span>
{{end}}

{{define "page_content"}}
<section class="content">
    <div class="container-fluid">
        <!-- <h5 class="mt-4 mb-2">Wireguard Clients</h5> -->
        <div class="row mb-2">
            <div class="col-12 d-flex justify-content-end align-items-center">
                <div class="mr-3">
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="auto-refresh-toggle">
                        <label class="custom-control-label" for="auto-refresh-toggle" data-translate="Auto Refresh">Auto Refresh</label>
                    </div>
                </div>
                <select id="refresh-interval" class="form-control mr-2" style="width: auto;" disabled>
                    <option value="5" data-translate="5 seconds">5 seconds</option>
                    <option value="10" data-translate="10 seconds">10 seconds</option>
                    <option value="30" data-translate="30 seconds">30 seconds</option>
                    <option value="60" data-translate="60 seconds">60 seconds</option>
                </select>
                <button type="button" id="refresh-status-btn" class="btn btn-outline-secondary">
                    <i class="fas fa-sync-alt"></i> <span data-translate="Refresh Status">Refresh Status</span>
                </button>
            </div>
        </div>
        <div class="row" id="client-list">
        </div>
        <!-- /.row -->
    </div>
</section>

<div class="modal fade" id="modal_email_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Email Configuration">Email Configuration</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_email_client" id="frm_email_client">
                <div class="modal-body">
                    <input type="hidden" id="e_client_id" name="e_client_id">
                    <div class="form-group">
                        <label for="e_client_email" class="control-label" data-translate="Email address">Email address</label>
                        <input type="text" class="form-control" id="e_client_email" name="e_client_email">
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Send">Send</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_qr_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="QR Code">QR Code</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="qr_client_id" name="qr_client_id">
                <img id="qr_code" class="w-100" style="image-rendering: pixelated;" src="" alt="QR code" />
                <!-- do not include FwMark in any client configs: it is INVALID. -->
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_telegram_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Telegram Configuration">Telegram Configuration</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_telegram_client" id="frm_telegram_client">
                <div class="modal-body">
                    <input type="hidden" id="tg_client_id" name="tg_client_id">
                    <div class="form-group">
                        <label for="tg_client_userid" class="control-label" data-translate="Telegram userid">Telegram userid</label>
                        <input type="text" class="form-control" id="tg_client_userid" name="tg_client_userid">
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Send">Send</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_edit_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Edit Client">Edit Client</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_edit_client" id="frm_edit_client">
                <div class="modal-body">
                    <input type="hidden" id="_client_id" name="_client_id">
                    <div class="form-group">
                        <label for="_client_name" class="control-label" data-translate="Name">Name</label>
                        <input type="text" class="form-control" id="_client_name" name="_client_name">
                    </div>
                    <div class="form-group">
                        <label for="_client_email" class="control-label" data-translate="Email">Email</label>
                        <input type="text" class="form-control" id="_client_email" name="client_email">
                    </div>
                    <div class="form-group">
                        <label for="_client_quota" class="control-label" data-translate="Quota">Quota</label>
                        <select class="form-control" id="_quota_preset" onchange="updateQuotaInput()">
                            <option value="" data-translate="Select Quota">Select Quota</option>
                            <option value="10">10 GB</option>
                            <option value="20">20 GB</option>
                            <option value="30">30 GB</option>
                            <option value="40">40 GB</option>
                            <option value="50">50 GB</option>
                            <option value="100">100 GB</option>
                            <option value="200">200 GB</option>
                            <option value="500">500 GB</option>
                            <option value="1000">1 TB</option>
                            <option value="custom" data-translate="Custom">Custom</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="number" class="form-control" id="_client_quota" name="_client_quota" data-translate-placeholder="Enter custom quota in GB" placeholder="Enter custom quota in GB" step="0.1" min="0" />
                    </div>

                    <div class="form-group">
                        <label for="_client_expiration_days" class="control-label" data-translate="Expiration Days">Expiration Days</label>
                        <input type="number" class="form-control" id="_client_expiration_days" name="_client_expiration_days" placeholder="e.g. 30" min="0" />
                    </div>

                    <div class="form-group">
                        <label for="_client_allocated_ips" class="control-label" data-translate="IP Allocation">IP Allocation</label>
                        <input type="text" data-role="tagsinput" class="form-control" id="_client_allocated_ips">
                    </div>
                    <div class="form-group">
                        <label for="_client_endpoint" class="control-label" data-translate="Endpoint">Endpoint</label>
                        <input type="text" class="form-control" id="_client_endpoint" name="client_endpoint">
                    </div>
                    <div class="form-group" style="margin-top: 0.5rem;">
                        <label for="_client_telegram_userid" class="control-label" data-translate="Telegram userid">Telegram userid</label>
                        <input type="text" class="form-control" id="_client_telegram_userid" name="_client_telegram_userid">
                    </div>
                    <div class="form-group">
                        <label for="_additional_notes" class="control-label" data-translate="Notes">Notes</label>
                        <textarea class="form-control" style="min-height: 6rem;" id="_additional_notes" name="_additional_notes" data-translate-placeholder="Additional notes about this client" placeholder="Additional notes about this client"></textarea>
                    </div>
                    <div class="form-group">
                        <div class="icheck-primary d-inline">
                            <input type="checkbox" id="_use_server_dns">
                            <label for="_use_server_dns" data-translate="Use server DNS">
                                Use server DNS
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="icheck-primary d-inline">
                            <input type="checkbox" id="_enabled">
                            <label for="_enabled" data-translate="Enable this client">
                                Enable this client
                            </label>
                        </div>
                    </div>
                    <details>
                        <summary>
                            <strong data-translate="Public and Preshared Keys">Public and Preshared Keys</strong>
                            <i class="fas fa-info-circle" data-toggle="tooltip"
                               data-translate-title="Update the server stored client Public and Preshared keys."
                               data-original-title="Update the server stored client Public and Preshared keys.">
                            </i>
                        </summary>
                        <div class="form-group" style="margin-top: 1rem">
                            <label for="_client_public_key" class="control-label" data-translate="Public Key">
                                Public Key
                            </label>
                            <input type="text" class="form-control" id="_client_public_key" name="_client_public_key" aria-invalid="false">
                        </div>
                        <div class="form-group">
                            <label for="_client_preshared_key" class="control-label" data-translate="Preshared Key">
                                Preshared Key
                            </label>
                            <input type="text" class="form-control" id="_client_preshared_key" name="_client_preshared_key">
                        </div>
                    </details>
                    <details style="margin-top: 0.5rem;">
                        <summary>
                            <strong data-translate="Additional configuration">Additional configuration</strong>
                        </summary>
                        <div class="form-group">
                            <label for="_client_allowed_ips" class="control-label" data-translate="Allowed IPs">Allowed IPs</label>
                            <input type="text" data-role="tagsinput" class="form-control" id="_client_allowed_ips">
                        </div>
                        <div class="form-group">
                            <label for="_client_extra_allowed_ips" class="control-label" data-translate="Extra Allowed IPs">Extra Allowed IPs</label>
                            <input type="text" data-role="tagsinput" class="form-control"
                                   id="_client_extra_allowed_ips">
                        </div>
                        <div class="form-group">
                            <label for="_subnet_ranges" class="control-label" data-translate="Subnet range">Subnet range</label>
                            <select id="_subnet_ranges" class="select2"
                                    data-translate-placeholder="Select a subnet range"
                                    data-placeholder="Select a subnet range" style="width: 100%;">
                            </select>
                        </div>
                    </details>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Save">Save</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_pause_client">
    <div class="modal-dialog">
        <div class="modal-content bg-warning">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Disable">Disable</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-dark" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                <button type="button" class="btn btn-outline-dark" id="pause_client_confirm" data-translate="Apply">Apply</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_remove_client">
    <div class="modal-dialog">
        <div class="modal-content bg-danger">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Remove">Remove</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-dark" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                <button type="button" class="btn btn-outline-dark" id="remove_client_confirm" data-translate="Apply">Apply</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->
{{end}}

{{define "bottom_js"}}
    <script>
        function populateClientList() {
            console.log('Fetching clients list...');
            $("#client-list").empty();
            
            const tryFetchClients = (retryCount = 0) => {
                $.ajax({
                    cache: false,
                    method: 'GET',
                    url: '{{.basePath}}/api/clients',
                    dataType: 'json',
                    contentType: "application/json",
                    success: function(response) {
                        console.log('Raw server response:', response);
                        
                        if (!response) {
                            console.log('No response from server');
                            $("#client-list").html('<div class="col-12 text-center"><p>No clients found</p></div>');
                            return;
                        }

                        // اگر پاسخ به صورت رشته JSON باشد، آن را پارس کنیم
                        let data = response;
                        if (typeof response === 'string') {
                            try {
                                data = JSON.parse(response);
                            } catch (e) {
                                console.error('Error parsing JSON response:', e);
                                toastr.error('Error processing server response');
                                return;
                            }
                        }

                        // اگر داده‌ها آرایه باشند، مستقیماً آنها را رندر کنیم
                        if (Array.isArray(data)) {
                            console.log('Rendering array of clients:', data);
                            renderClientList(data);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        // اگر داده‌ها یک آبجکت باشند که شامل آرایه clients است
                        if (data.clients && Array.isArray(data.clients)) {
                            console.log('Rendering clients from data.clients:', data.clients);
                            renderClientList(data.clients);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        // اگر داده‌ها یک آبجکت باشند که شامل آرایه data است
                        if (data.data && Array.isArray(data.data)) {
                            console.log('Rendering clients from data.data:', data.data);
                            renderClientList(data.data);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        // اگر داده‌ها یک کلاینت منفرد باشند
                        if (data.Client || (data.name && data.id)) {
                            console.log('Rendering single client:', data);
                            renderClientList([data]);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        console.log('No valid client data found in response');
                        $("#client-list").html('<div class="col-12 text-center"><p>No clients found</p></div>');
                    },
                    error: function(jqXHR) {
                        console.error('Error fetching clients:', {
                            status: jqXHR.status,
                            statusText: jqXHR.statusText,
                            responseText: jqXHR.responseText
                        });
                        
                        if (retryCount < 3 && (jqXHR.status === 0 || jqXHR.status === 500)) {
                            setTimeout(() => tryFetchClients(retryCount + 1), 1000 * (retryCount + 1));
                            return;
                        }

                        let errorMessage = 'Failed to fetch clients';
                        if (jqXHR.responseText) {
                            try {
                                const responseJson = JSON.parse(jqXHR.responseText);
                                errorMessage = responseJson.message || errorMessage;
                            } catch (e) {
                                console.error('Error parsing error response:', e);
                            }
                        }
                        
                        toastr.error(errorMessage);
                        $("#client-list").html('<div class="col-12 text-center"><p>Error loading clients</p></div>');
                    }
                });
            };

            tryFetchClients();
        }

        function autoApplyConfig() {
            $("#apply_config_confirm").click();
        }

        let disableInProgress = false;

        function setClientStatus(clientID, status, isAutomatic = false) {
            if (!clientID) {
                console.error('Invalid client ID');
                return;
            }

            if (disableInProgress) {
                console.log('Status change already in progress, skipping');
                return;
            }

            disableInProgress = true;
            const trySetStatus = (retryCount = 0) => {
                $.ajax({
                    cache: false,
                    method: 'POST',
                    url: '{{.basePath}}/api/client/' + clientID + '/status/' + status,
                    dataType: 'json',
                    contentType: "application/json",
                    data: JSON.stringify({ 
                        enabled: status,
                        automatic: isAutomatic 
                    }),
                    success: function(data) {
                        console.log("Set client " + clientID + " status to " + status);
                        toastr.success('Client ' + (status ? 'enabled' : 'disabled') + ' successfully');
                        
                        const divElement = document.getElementById("paused_" + clientID);
                        if (divElement) {
                            divElement.style.visibility = status ? "hidden" : "visible";
                        }

                        if (!status && isAutomatic) {
                            applyWireGuardConfig();
                        }

                        populateClientList();
                        disableInProgress = false;
                    },
                    error: function(jqXHR) {
                        console.error('Error setting client status:', jqXHR.status);
                        if (retryCount < 3 && (jqXHR.status === 500 || jqXHR.status === 0)) {
                            setTimeout(() => trySetStatus(retryCount + 1), 1000 * (retryCount + 1));
                        } else {
                            let errorMessage = 'Error changing client status';
                            try {
                                const responseJson = jQuery.parseJSON(jqXHR.responseText);
                                errorMessage = responseJson.message || errorMessage;
                            } catch (e) {
                                console.error('Error parsing error response:', e);
                            }
                            toastr.error(errorMessage);
                            disableInProgress = false;
                        }
                    }
                });
            };

            trySetStatus();
        }

        function applyWireGuardConfig(retryCount = 0) {
            $.ajax({
                cache: false,
                method: 'POST',
                url: '{{.basePath}}/api/apply-wg-config',
                dataType: 'json',
                contentType: "application/json",
                success: function(data) {
                    toastr.success('Configuration applied successfully');
                    populateClientList();
                },
                error: function(jqXHR) {
                    console.error('Error applying config:', jqXHR.status);
                    if (retryCount < 3 && (jqXHR.status === 500 || jqXHR.status === 0)) {
                        setTimeout(() => applyWireGuardConfig(retryCount + 1), 1000 * (retryCount + 1));
                    } else {
                        let errorMessage = 'Error applying configuration';
                        try {
                            const responseJson = jQuery.parseJSON(jqXHR.responseText);
                            errorMessage = responseJson.message || errorMessage;
                        } catch (e) {
                            console.error('Error parsing error response:', e);
                        }
                        toastr.error(errorMessage);
                    }
                }
            });
        }

        function pauseClient(clientID) {
            setClientStatus(clientID, false);
        }

        function resumeClient(clientID) {
            setClientStatus(clientID, true);
        }

        function updateIPAllocationSuggestion() {
            const selectedSubnet = $('#subnet_ranges').val() || '__default_any__';
            
            // اگر درخواست قبلی هنوز در حال اجراست، از درخواست جدید جلوگیری کن
            if (updateIPAllocationSuggestion.isRunning) {
                console.log('Previous request is still running, skipping...');
                return;
            }

            console.log('Getting IP suggestions for subnet:', selectedSubnet);

            // Clear previous IPs
            $('#client_allocated_ips').importTags('');

            // تنظیم وضعیت درخواست
            updateIPAllocationSuggestion.isRunning = true;

            // Get IP suggestion from API with retry logic
            const tryGetSuggestions = (retryCount = 0) => {
                $.ajax({
                    cache: false,
                    method: 'GET',
                    url: '{{.basePath}}/api/suggest-client-ips',
                    data: { sr: selectedSubnet },
                    dataType: 'json',
                    contentType: "application/json",
                    success: function(response) {
                        console.log('Received IP suggestions:', response);
                        if (response && Array.isArray(response)) {
                            response.forEach(function(ip) {
                                if (ip) {
                                    $('#client_allocated_ips').addTag(ip);
                                }
                            });
                        } else {
                            console.warn('Invalid response format or no IPs available');
                        }
                        // پایان درخواست
                        updateIPAllocationSuggestion.isRunning = false;
                    },
                    error: function(jqXHR) {
                        console.error('Error getting IP suggestions:', jqXHR.status);
                        if (retryCount < 3 && (jqXHR.status === 503 || jqXHR.status === 0)) {
                            setTimeout(() => tryGetSuggestions(retryCount + 1), 1000 * (retryCount + 1));
                        } else {
                            let errorMessage = 'Failed to get IP suggestions';
                            try {
                                const responseJson = jQuery.parseJSON(jqXHR.responseText);
                                errorMessage = responseJson.message || errorMessage;
                            } catch (e) {
                                console.error('Error parsing error response:', e);
                            }
                            toastr.error(errorMessage);
                            // پایان درخواست در صورت خطا
                            updateIPAllocationSuggestion.isRunning = false;
                        }
                    }
                });
            };

            tryGetSuggestions();
        }

        // مقداردهی اولیه وضعیت درخواست
        updateIPAllocationSuggestion.isRunning = false;

        function updateSubnetRangesList(elementID, preselectedVal) {
            $.getJSON("{{.basePath}}/api/subnet-ranges", null, function(data) {
                $(`${elementID} option`).remove();
                $(elementID).append(
                    $("<option></option>")
                        .text("Any")
                        .val("__default_any__")
                );
                $.each(data, function(index, item) {
                    $(elementID).append(
                        $("<option></option>")
                            .text(item)
                            .val(item)
                    );
                    if (item === preselectedVal) {
                        console.log(preselectedVal);
                        $(elementID).val(preselectedVal).trigger('change')
                    }
                });
            });
        }

        function updateSearchList() {
            $.getJSON("{{.basePath}}/api/subnet-ranges", null, function(data) {
                $("#status-selector option").remove();
                $("#status-selector").append(
                    $("<option></option>")
                        .text("All")
                        .val("All"),
                    $("<option></option>")
                        .text("Enabled")
                        .val("Enabled"),
                    $("<option></option>")
                        .text("Disabled")
                        .val("Disabled"),
                    $("<option></option>")
                        .text("Connected")
                        .val("Connected"),
                    $("<option></option>")
                        .text("Disconnected")
                        .val("Disconnected")
                );
                $.each(data, function(index, item) {
                    $("#status-selector").append(
                        $("<option></option>")
                            .text(item)
                            .val(item)
                    );
                });
            });
        }
    </script>
</code_block_to_apply_changes_from>
</edit_instructions>


Assistant: <rewritten_file>
```
{{define "title"}}
<span data-translate="Wireguard Clients">Wireguard Clients</span>
{{end}}

{{define "top_css"}}
<style>
    .paused-client {
        transition: transform .2s;
        cursor: pointer;
    }
    i[class^="paused-client"]:hover { transform: scale(1.5); }
</style>
{{end}}

{{define "username"}}
{{ .username }}
{{end}}

{{define "page_title"}}
<span data-translate="Wireguard Clients">Wireguard Clients</span>
{{end}}

{{define "page_content"}}
<section class="content">
    <div class="container-fluid">
        <!-- <h5 class="mt-4 mb-2">Wireguard Clients</h5> -->
        <div class="row mb-2">
            <div class="col-12 d-flex justify-content-end align-items-center">
                <div class="mr-3">
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="auto-refresh-toggle">
                        <label class="custom-control-label" for="auto-refresh-toggle" data-translate="Auto Refresh">Auto Refresh</label>
                    </div>
                </div>
                <select id="refresh-interval" class="form-control mr-2" style="width: auto;" disabled>
                    <option value="5" data-translate="5 seconds">5 seconds</option>
                    <option value="10" data-translate="10 seconds">10 seconds</option>
                    <option value="30" data-translate="30 seconds">30 seconds</option>
                    <option value="60" data-translate="60 seconds">60 seconds</option>
                </select>
                <button type="button" id="refresh-status-btn" class="btn btn-outline-secondary">
                    <i class="fas fa-sync-alt"></i> <span data-translate="Refresh Status">Refresh Status</span>
                </button>
            </div>
        </div>
        <div class="row" id="client-list">
        </div>
        <!-- /.row -->
    </div>
</section>

<div class="modal fade" id="modal_email_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Email Configuration">Email Configuration</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_email_client" id="frm_email_client">
                <div class="modal-body">
                    <input type="hidden" id="e_client_id" name="e_client_id">
                    <div class="form-group">
                        <label for="e_client_email" class="control-label" data-translate="Email address">Email address</label>
                        <input type="text" class="form-control" id="e_client_email" name="e_client_email">
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Send">Send</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_qr_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="QR Code">QR Code</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="qr_client_id" name="qr_client_id">
                <img id="qr_code" class="w-100" style="image-rendering: pixelated;" src="" alt="QR code" />
                <!-- do not include FwMark in any client configs: it is INVALID. -->
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_telegram_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Telegram Configuration">Telegram Configuration</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_telegram_client" id="frm_telegram_client">
                <div class="modal-body">
                    <input type="hidden" id="tg_client_id" name="tg_client_id">
                    <div class="form-group">
                        <label for="tg_client_userid" class="control-label" data-translate="Telegram userid">Telegram userid</label>
                        <input type="text" class="form-control" id="tg_client_userid" name="tg_client_userid">
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Send">Send</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_edit_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Edit Client">Edit Client</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_edit_client" id="frm_edit_client">
                <div class="modal-body">
                    <input type="hidden" id="_client_id" name="_client_id">
                    <div class="form-group">
                        <label for="_client_name" class="control-label" data-translate="Name">Name</label>
                        <input type="text" class="form-control" id="_client_name" name="_client_name">
                    </div>
                    <div class="form-group">
                        <label for="_client_email" class="control-label" data-translate="Email">Email</label>
                        <input type="text" class="form-control" id="_client_email" name="client_email">
                    </div>
                    <div class="form-group">
                        <label for="_client_quota" class="control-label" data-translate="Quota">Quota</label>
                        <select class="form-control" id="_quota_preset" onchange="updateQuotaInput()">
                            <option value="" data-translate="Select Quota">Select Quota</option>
                            <option value="10">10 GB</option>
                            <option value="20">20 GB</option>
                            <option value="30">30 GB</option>
                            <option value="40">40 GB</option>
                            <option value="50">50 GB</option>
                            <option value="100">100 GB</option>
                            <option value="200">200 GB</option>
                            <option value="500">500 GB</option>
                            <option value="1000">1 TB</option>
                            <option value="custom" data-translate="Custom">Custom</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="number" class="form-control" id="_client_quota" name="_client_quota" data-translate-placeholder="Enter custom quota in GB" placeholder="Enter custom quota in GB" step="0.1" min="0" />
                    </div>

                    <div class="form-group">
                        <label for="_client_expiration_days" class="control-label" data-translate="Expiration Days">Expiration Days</label>
                        <input type="number" class="form-control" id="_client_expiration_days" name="_client_expiration_days" placeholder="e.g. 30" min="0" />
                    </div>

                    <div class="form-group">
                        <label for="_client_allocated_ips" class="control-label" data-translate="IP Allocation">IP Allocation</label>
                        <input type="text" data-role="tagsinput" class="form-control" id="_client_allocated_ips">
                    </div>
                    <div class="form-group">
                        <label for="_client_endpoint" class="control-label" data-translate="Endpoint">Endpoint</label>
                        <input type="text" class="form-control" id="_client_endpoint" name="client_endpoint">
                    </div>
                    <div class="form-group" style="margin-top: 0.5rem;">
                        <label for="_client_telegram_userid" class="control-label" data-translate="Telegram userid">Telegram userid</label>
                        <input type="text" class="form-control" id="_client_telegram_userid" name="_client_telegram_userid">
                    </div>
                    <div class="form-group">
                        <label for="_additional_notes" class="control-label" data-translate="Notes">Notes</label>
                        <textarea class="form-control" style="min-height: 6rem;" id="_additional_notes" name="_additional_notes" data-translate-placeholder="Additional notes about this client" placeholder="Additional notes about this client"></textarea>
                    </div>
                    <div class="form-group">
                        <div class="icheck-primary d-inline">
                            <input type="checkbox" id="_use_server_dns">
                            <label for="_use_server_dns" data-translate="Use server DNS">
                                Use server DNS
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="icheck-primary d-inline">
                            <input type="checkbox" id="_enabled">
                            <label for="_enabled" data-translate="Enable this client">
                                Enable this client
                            </label>
                        </div>
                    </div>
                    <details>
                        <summary>
                            <strong data-translate="Public and Preshared Keys">Public and Preshared Keys</strong>
                            <i class="fas fa-info-circle" data-toggle="tooltip"
                               data-translate-title="Update the server stored client Public and Preshared keys."
                               data-original-title="Update the server stored client Public and Preshared keys.">
                            </i>
                        </summary>
                        <div class="form-group" style="margin-top: 1rem">
                            <label for="_client_public_key" class="control-label" data-translate="Public Key">
                                Public Key
                            </label>
                            <input type="text" class="form-control" id="_client_public_key" name="_client_public_key" aria-invalid="false">
                        </div>
                        <div class="form-group">
                            <label for="_client_preshared_key" class="control-label" data-translate="Preshared Key">
                                Preshared Key
                            </label>
                            <input type="text" class="form-control" id="_client_preshared_key" name="_client_preshared_key">
                        </div>
                    </details>
                    <details style="margin-top: 0.5rem;">
                        <summary>
                            <strong data-translate="Additional configuration">Additional configuration</strong>
                        </summary>
                        <div class="form-group">
                            <label for="_client_allowed_ips" class="control-label" data-translate="Allowed IPs">Allowed IPs</label>
                            <input type="text" data-role="tagsinput" class="form-control" id="_client_allowed_ips">
                        </div>
                        <div class="form-group">
                            <label for="_client_extra_allowed_ips" class="control-label" data-translate="Extra Allowed IPs">Extra Allowed IPs</label>
                            <input type="text" data-role="tagsinput" class="form-control"
                                   id="_client_extra_allowed_ips">
                        </div>
                        <div class="form-group">
                            <label for="_subnet_ranges" class="control-label" data-translate="Subnet range">Subnet range</label>
                            <select id="_subnet_ranges" class="select2"
                                    data-translate-placeholder="Select a subnet range"
                                    data-placeholder="Select a subnet range" style="width: 100%;">
                            </select>
                        </div>
                    </details>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Save">Save</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_pause_client">
    <div class="modal-dialog">
        <div class="modal-content bg-warning">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Disable">Disable</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-dark" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                <button type="button" class="btn btn-outline-dark" id="pause_client_confirm" data-translate="Apply">Apply</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_remove_client">
    <div class="modal-dialog">
        <div class="modal-content bg-danger">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Remove">Remove</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-dark" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                <button type="button" class="btn btn-outline-dark" id="remove_client_confirm" data-translate="Apply">Apply</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->
{{end}}

{{define "bottom_js"}}
    <script>
        function populateClientList() {
            console.log('Fetching clients list...');
            $("#client-list").empty();
            
            const tryFetchClients = (retryCount = 0) => {
                $.ajax({
                    cache: false,
                    method: 'GET',
                    url: '{{.basePath}}/api/clients',
                    dataType: 'json',
                    contentType: "application/json",
                    success: function(response) {
                        console.log('Raw server response:', response);
                        
                        if (!response) {
                            console.log('No response from server');
                            $("#client-list").html('<div class="col-12 text-center"><p>No clients found</p></div>');
                            return;
                        }

                        // اگر پاسخ به صورت رشته JSON باشد، آن را پارس کنیم
                        let data = response;
                        if (typeof response === 'string') {
                            try {
                                data = JSON.parse(response);
                            } catch (e) {
                                console.error('Error parsing JSON response:', e);
                                toastr.error('Error processing server response');
                                return;
                            }
                        }

                        // اگر داده‌ها آرایه باشند، مستقیماً آنها را رندر کنیم
                        if (Array.isArray(data)) {
                            console.log('Rendering array of clients:', data);
                            renderClientList(data);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        // اگر داده‌ها یک آبجکت باشند که شامل آرایه clients است
                        if (data.clients && Array.isArray(data.clients)) {
                            console.log('Rendering clients from data.clients:', data.clients);
                            renderClientList(data.clients);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        // اگر داده‌ها یک آبجکت باشند که شامل آرایه data است
                        if (data.data && Array.isArray(data.data)) {
                            console.log('Rendering clients from data.data:', data.data);
                            renderClientList(data.data);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        // اگر داده‌ها یک کلاینت منفرد باشند
                        if (data.Client || (data.name && data.id)) {
                            console.log('Rendering single client:', data);
                            renderClientList([data]);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        console.log('No valid client data found in response');
                        $("#client-list").html('<div class="col-12 text-center"><p>No clients found</p></div>');
                    },
                    error: function(jqXHR) {
                        console.error('Error fetching clients:', {
                            status: jqXHR.status,
                            statusText: jqXHR.statusText,
                            responseText: jqXHR.responseText
                        });
                        
                        if (retryCount < 3 && (jqXHR.status === 0 || jqXHR.status === 500)) {
                            setTimeout(() => tryFetchClients(retryCount + 1), 1000 * (retryCount + 1));
                            return;
                        }

                        let errorMessage = 'Failed to fetch clients';
                        if (jqXHR.responseText) {
                            try {
                                const responseJson = JSON.parse(jqXHR.responseText);
                                errorMessage = responseJson.message || errorMessage;
                            } catch (e) {
                                console.error('Error parsing error response:', e);
                            }
                        }
                        
                        toastr.error(errorMessage);
                        $("#client-list").html('<div class="col-12 text-center"><p>Error loading clients</p></div>');
                    }
                });
            };

            tryFetchClients();
        }

        function autoApplyConfig() {
            $("#apply_config_confirm").click();
        }

        let disableInProgress = false;

        function setClientStatus(clientID, status, isAutomatic = false) {
            if (!clientID) {
                console.error('Invalid client ID');
                return;
            }

            if (disableInProgress) {
                console.log('Status change already in progress, skipping');
                return;
            }

            disableInProgress = true;
            const trySetStatus = (retryCount = 0) => {
                $.ajax({
                    cache: false,
                    method: 'POST',
                    url: '{{.basePath}}/api/client/' + clientID + '/status/' + status,
                    dataType: 'json',
                    contentType: "application/json",
                    data: JSON.stringify({ 
                        enabled: status,
                        automatic: isAutomatic 
                    }),
                    success: function(data) {
                        console.log("Set client " + clientID + " status to " + status);
                        toastr.success('Client ' + (status ? 'enabled' : 'disabled') + ' successfully');
                        
                        const divElement = document.getElementById("paused_" + clientID);
                        if (divElement) {
                            divElement.style.visibility = status ? "hidden" : "visible";
                        }

                        if (!status && isAutomatic) {
                            applyWireGuardConfig();
                        }

                        populateClientList();
                        disableInProgress = false;
                    },
                    error: function(jqXHR) {
                        console.error('Error setting client status:', jqXHR.status);
                        if (retryCount < 3 && (jqXHR.status === 500 || jqXHR.status === 0)) {
                            setTimeout(() => trySetStatus(retryCount + 1), 1000 * (retryCount + 1));
                        } else {
                            let errorMessage = 'Error changing client status';
                            try {
                                const responseJson = jQuery.parseJSON(jqXHR.responseText);
                                errorMessage = responseJson.message || errorMessage;
                            } catch (e) {
                                console.error('Error parsing error response:', e);
                            }
                            toastr.error(errorMessage);
                            disableInProgress = false;
                        }
                    }
                });
            };

            trySetStatus();
        }

        function applyWireGuardConfig(retryCount = 0) {
            $.ajax({
                cache: false,
                method: 'POST',
                url: '{{.basePath}}/api/apply-wg-config',
                dataType: 'json',
                contentType: "application/json",
                success: function(data) {
                    toastr.success('Configuration applied successfully');
                    populateClientList();
                },
                error: function(jqXHR) {
                    console.error('Error applying config:', jqXHR.status);
                    if (retryCount < 3 && (jqXHR.status === 500 || jqXHR.status === 0)) {
                        setTimeout(() => applyWireGuardConfig(retryCount + 1), 1000 * (retryCount + 1));
                    } else {
                        let errorMessage = 'Error applying configuration';
                        try {
                            const responseJson = jQuery.parseJSON(jqXHR.responseText);
                            errorMessage = responseJson.message || errorMessage;
                        } catch (e) {
                            console.error('Error parsing error response:', e);
                        }
                        toastr.error(errorMessage);
                    }
                }
            });
        }

        function pauseClient(clientID) {
            setClientStatus(clientID, false);
        }

        function resumeClient(clientID) {
            setClientStatus(clientID, true);
        }

        function updateIPAllocationSuggestion() {
            const selectedSubnet = $('#subnet_ranges').val() || '__default_any__';
            
            // اگر درخواست قبلی هنوز در حال اجراست، از درخواست جدید جلوگیری کن
            if (updateIPAllocationSuggestion.isRunning) {
                console.log('Previous request is still running, skipping...');
                return;
            }

            console.log('Getting IP suggestions for subnet:', selectedSubnet);

            // Clear previous IPs
            $('#client_allocated_ips').importTags('');

            // تنظیم وضعیت درخواست
            updateIPAllocationSuggestion.isRunning = true;

            // Get IP suggestion from API with retry logic
            const tryGetSuggestions = (retryCount = 0) => {
                $.ajax({
                    cache: false,
                    method: 'GET',
                    url: '{{.basePath}}/api/suggest-client-ips',
                    data: { sr: selectedSubnet },
                    dataType: 'json',
                    contentType: "application/json",
                    success: function(response) {
                        console.log('Received IP suggestions:', response);
                        if (response && Array.isArray(response)) {
                            response.forEach(function(ip) {
                                if (ip) {
                                    $('#client_allocated_ips').addTag(ip);
                                }
                            });
                        } else {
                            console.warn('Invalid response format or no IPs available');
                        }
                        // پایان درخواست
                        updateIPAllocationSuggestion.isRunning = false;
                    },
                    error: function(jqXHR) {
                        console.error('Error getting IP suggestions:', jqXHR.status);
                        if (retryCount < 3 && (jqXHR.status === 503 || jqXHR.status === 0)) {
                            setTimeout(() => tryGetSuggestions(retryCount + 1), 1000 * (retryCount + 1));
                        } else {
                            let errorMessage = 'Failed to get IP suggestions';
                            try {
                                const responseJson = jQuery.parseJSON(jqXHR.responseText);
                                errorMessage = responseJson.message || errorMessage;
                            } catch (e) {
                                console.error('Error parsing error response:', e);
                            }
                            toastr.error(errorMessage);
                            // پایان درخواست در صورت خطا
                            updateIPAllocationSuggestion.isRunning = false;
                        }
                    }
                });
            };

            tryGetSuggestions();
        }

        // مقداردهی اولیه وضعیت درخواست
        updateIPAllocationSuggestion.isRunning = false;

        function updateSubnetRangesList(elementID, preselectedVal) {
            $.getJSON("{{.basePath}}/api/subnet-ranges", null, function(data) {
                $(`${elementID} option`).remove();
                $(elementID).append(
                    $("<option></option>")
                        .text("Any")
                        .val("__default_any__")
                );
                $.each(data, function(index, item) {
                    $(elementID).append(
                        $("<option></option>")
                            .text(item)
                            .val(item)
                    );
                    if (item === preselectedVal) {
                        console.log(preselectedVal);
                        $(elementID).val(preselectedVal).trigger('change')
                    }
                });
            });
        }

        function updateSearchList() {
            $.getJSON("{{.basePath}}/api/subnet-ranges", null, function(data) {
                $("#status-selector option").remove();
                $("#status-selector").append(
                    $("<option></option>")
                        .text("All")
                        .val("All"),
                    $("<option></option>")
                        .text("Enabled")
                        .val("Enabled"),
                    $("<option></option>")
                        .text("Disabled")
                        .val("Disabled"),
                    $("<option></option>")
                        .text("Connected")
                        .val("Connected"),
                    $("<option></option>")
                        .text("Disconnected")
                        .val("Disconnected")
                );
                $.each(data, function(index, item) {
                    $("#status-selector").append(
                        $("<option></option>")
                            .text(item)
                            .val(item)
                    );
                });
            });
        }
    </script>
</code_block_to_apply_changes_from>
</edit_instructions>


Assistant: <rewritten_file>
```
{{define "title"}}
<span data-translate="Wireguard Clients">Wireguard Clients</span>
{{end}}

{{define "top_css"}}
<style>
    .paused-client {
        transition: transform .2s;
        cursor: pointer;
    }
    i[class^="paused-client"]:hover { transform: scale(1.5); }
</style>
{{end}}

{{define "username"}}
{{ .username }}
{{end}}

{{define "page_title"}}
<span data-translate="Wireguard Clients">Wireguard Clients</span>
{{end}}

{{define "page_content"}}
<section class="content">
    <div class="container-fluid">
        <!-- <h5 class="mt-4 mb-2">Wireguard Clients</h5> -->
        <div class="row mb-2">
            <div class="col-12 d-flex justify-content-end align-items-center">
                <div class="mr-3">
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="auto-refresh-toggle">
                        <label class="custom-control-label" for="auto-refresh-toggle" data-translate="Auto Refresh">Auto Refresh</label>
                    </div>
                </div>
                <select id="refresh-interval" class="form-control mr-2" style="width: auto;" disabled>
                    <option value="5" data-translate="5 seconds">5 seconds</option>
                    <option value="10" data-translate="10 seconds">10 seconds</option>
                    <option value="30" data-translate="30 seconds">30 seconds</option>
                    <option value="60" data-translate="60 seconds">60 seconds</option>
                </select>
                <button type="button" id="refresh-status-btn" class="btn btn-outline-secondary">
                    <i class="fas fa-sync-alt"></i> <span data-translate="Refresh Status">Refresh Status</span>
                </button>
            </div>
        </div>
        <div class="row" id="client-list">
        </div>
        <!-- /.row -->
    </div>
</section>

<div class="modal fade" id="modal_email_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Email Configuration">Email Configuration</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_email_client" id="frm_email_client">
                <div class="modal-body">
                    <input type="hidden" id="e_client_id" name="e_client_id">
                    <div class="form-group">
                        <label for="e_client_email" class="control-label" data-translate="Email address">Email address</label>
                        <input type="text" class="form-control" id="e_client_email" name="e_client_email">
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Send">Send</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_qr_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="QR Code">QR Code</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="qr_client_id" name="qr_client_id">
                <img id="qr_code" class="w-100" style="image-rendering: pixelated;" src="" alt="QR code" />
                <!-- do not include FwMark in any client configs: it is INVALID. -->
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_telegram_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Telegram Configuration">Telegram Configuration</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_telegram_client" id="frm_telegram_client">
                <div class="modal-body">
                    <input type="hidden" id="tg_client_id" name="tg_client_id">
                    <div class="form-group">
                        <label for="tg_client_userid" class="control-label" data-translate="Telegram userid">Telegram userid</label>
                        <input type="text" class="form-control" id="tg_client_userid" name="tg_client_userid">
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Send">Send</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_edit_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Edit Client">Edit Client</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_edit_client" id="frm_edit_client">
                <div class="modal-body">
                    <input type="hidden" id="_client_id" name="_client_id">
                    <div class="form-group">
                        <label for="_client_name" class="control-label" data-translate="Name">Name</label>
                        <input type="text" class="form-control" id="_client_name" name="_client_name">
                    </div>
                    <div class="form-group">
                        <label for="_client_email" class="control-label" data-translate="Email">Email</label>
                        <input type="text" class="form-control" id="_client_email" name="client_email">
                    </div>
                    <div class="form-group">
                        <label for="_client_quota" class="control-label" data-translate="Quota">Quota</label>
                        <select class="form-control" id="_quota_preset" onchange="updateQuotaInput()">
                            <option value="" data-translate="Select Quota">Select Quota</option>
                            <option value="10">10 GB</option>
                            <option value="20">20 GB</option>
                            <option value="30">30 GB</option>
                            <option value="40">40 GB</option>
                            <option value="50">50 GB</option>
                            <option value="100">100 GB</option>
                            <option value="200">200 GB</option>
                            <option value="500">500 GB</option>
                            <option value="1000">1 TB</option>
                            <option value="custom" data-translate="Custom">Custom</option