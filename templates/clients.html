{{define "title"}}
<span data-translate="Wireguard Clients">Wireguard Clients</span>
{{end}}

{{define "top_css"}}
<style>
    .paused-client {
        transition: transform .2s;
        cursor: pointer;
    }
    i[class^="paused-client"]:hover { transform: scale(1.5); }
    
    /* Modern TailwindCSS styling for info-box components */
    .info-box {
        background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 1rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .info-box:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        border-color: rgba(249,115,22,0.3);
    }
    
    .dark .info-box {
        background: linear-gradient(135deg, rgba(31,41,55,0.95) 0%, rgba(55,65,81,0.85) 100%);
        border: 1px solid rgba(75,85,99,0.3);
    }
    
    .dark .info-box:hover {
        box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        border-color: rgba(249,115,22,0.4);
    }
    
    .info-box .info-box-content {
        padding: 1.5rem;
    }
    
    .info-box .info-box-icon {
        background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        border-radius: 0.75rem;
        padding: 1rem;
        color: white;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 3rem;
        height: 3rem;
        box-shadow: 0 4px 6px rgba(249,115,22,0.2);
    }
    
    .info-box .info-box-text {
        color: #374151;
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
    }
    
    .dark .info-box .info-box-text {
        color: #d1d5db;
    }
    
    .info-box .info-box-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 0.25rem;
    }
    
    .dark .info-box .info-box-number {
        color: #f9fafb;
    }
    
    .badge-secondary {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        display: inline-block;
        margin: 0.125rem;
    }
    
    .btn-outline-primary {
        background: transparent;
        border: 2px solid #f97316;
        color: #f97316;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .btn-outline-primary:hover {
        background: #f97316;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(249,115,22,0.3);
    }
    
    .btn-more {
        background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        transition: all 0.2s ease;
        cursor: pointer;
        border: none;
    }
    
    .btn-more:hover {
        background: linear-gradient(135deg, #ea580c 0%, #dc2626 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(249,115,22,0.3);
    }
    
    .overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 1rem;
        z-index: 10;
    }
    
    .progress {
        background: #e5e7eb;
        border-radius: 0.5rem;
        height: 0.5rem;
        overflow: hidden;
        margin-top: 0.5rem;
    }
    
    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #22c55e 0%, #16a34a 100%);
        transition: width 0.3s ease;
    }
    
    .progress-bar.bg-danger {
        background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
    }
    
    .progress-bar.bg-primary {
        background: linear-gradient(90deg, #f97316 0%, #ea580c 100%);
    }
    
    .dark .progress {
        background: #374151;
    }
    
    .form-control {
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #f97316;
        box-shadow: 0 0 0 3px rgba(249,115,22,0.1);
    }
    
    .dark .form-control {
        background: #374151;
        border-color: #4b5563;
        color: #d1d5db;
    }
    
    .custom-control-input:checked ~ .custom-control-label::before {
        background: #f97316;
        border-color: #f97316;
    }
    
    .custom-control-input:focus ~ .custom-control-label::before {
        box-shadow: 0 0 0 3px rgba(249,115,22,0.1);
    }
    
    .btn-outline-secondary {
        background: transparent;
        border: 2px solid #6b7280;
        color: #6b7280;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .btn-outline-secondary:hover {
        background: #6b7280;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(107,114,128,0.3);
    }
    
    .text-success {
        color: #059669;
    }
    
    .text-danger {
        color: #dc2626;
    }
    
    .text-muted {
        color: #6b7280;
    }
    
    .dark .text-muted {
        color: #9ca3af;
    }
    
    .card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 1rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .dark .card {
        background: #1f2937;
        border-color: #374151;
    }
    
    .ip-allocation {
        display: inline-block;
        background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        margin: 0.125rem;
        box-shadow: 0 2px 4px rgba(249,115,22,0.2);
    }
    
    .client-status {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .client-status.enabled {
        background: rgba(34, 197, 94, 0.1);
        color: #22c55e;
        border: 1px solid rgba(34, 197, 94, 0.2);
    }
    
    .client-status.disabled {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.2);
    }
    
    .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 10px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #f97316;
        border-radius: 10px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #ea580c;
    }
    
    .dark .custom-scrollbar::-webkit-scrollbar-track {
        background: #374151;
    }
</style>
{{end}}

{{define "username"}}
{{ .username }}
{{end}}

{{define "page_title"}}
<span data-translate="Wireguard Clients">Wireguard Clients</span>
{{end}}

{{define "page_content"}}
<section class="content">
    <div class="container-fluid">
        <!-- <h5 class="mt-4 mb-2">Wireguard Clients</h5> -->
        <div class="row mb-2">
            <div class="col-12 d-flex justify-content-end align-items-center">
                <div class="mr-3">
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="auto-refresh-toggle">
                        <label class="custom-control-label" for="auto-refresh-toggle" data-translate="Auto Refresh">Auto Refresh</label>
                    </div>
                </div>
                <select id="refresh-interval" class="form-control mr-2" style="width: auto;" disabled>
                    <option value="5" data-translate="5 seconds">5 seconds</option>
                    <option value="10" data-translate="10 seconds">10 seconds</option>
                    <option value="30" data-translate="30 seconds">30 seconds</option>
                    <option value="60" data-translate="60 seconds">60 seconds</option>
                </select>
                <button type="button" id="refresh-status-btn" class="btn btn-outline-secondary">
                    <i class="fas fa-sync-alt"></i> <span data-translate="Refresh Status">Refresh Status</span>
                </button>
            </div>
        </div>
        
        <!-- Search and Filter Row -->
        <div class="row mb-3" id="search-form" style="display: none;">
            <div class="col-md-8">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                    <input type="text" id="search-input" class="form-control" placeholder="Search clients..." data-translate-placeholder="Search clients...">
                </div>
            </div>
            <div class="col-md-4">
                <select id="status-selector" class="form-control">
                    <option value="All" data-translate="All">All</option>
                    <option value="Enabled" data-translate="Enabled">Enabled</option>
                    <option value="Disabled" data-translate="Disabled">Disabled</option>
                    <option value="Connected" data-translate="Connected">Connected</option>
                    <option value="Disconnected" data-translate="Disconnected">Disconnected</option>
                </select>
            </div>
        </div>
        
        <div class="row" id="client-list">
        </div>
        <!-- /.row -->
    </div>
</section>

<div class="modal fade" id="modal_email_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Email Configuration">Email Configuration</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_email_client" id="frm_email_client">
                <div class="modal-body">
                    <input type="hidden" id="e_client_id" name="e_client_id">
                    <div class="form-group">
                        <label for="e_client_email" class="control-label" data-translate="Email address">Email address</label>
                        <input type="text" class="form-control" id="e_client_email" name="e_client_email">
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Send">Send</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_qr_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="QR Code">QR Code</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="qr_client_id" name="qr_client_id">
                <img id="qr_code" class="w-100" style="image-rendering: pixelated;" src="" alt="QR code" />
                <!-- do not include FwMark in any client configs: it is INVALID. -->
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_telegram_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Telegram Configuration">Telegram Configuration</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_telegram_client" id="frm_telegram_client">
                <div class="modal-body">
                    <input type="hidden" id="tg_client_id" name="tg_client_id">
                    <div class="form-group">
                        <label for="tg_client_userid" class="control-label" data-translate="Telegram userid">Telegram userid</label>
                        <input type="text" class="form-control" id="tg_client_userid" name="tg_client_userid">
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Send">Send</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_edit_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Edit Client">Edit Client</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_edit_client" id="frm_edit_client">
                <div class="modal-body">
                    <input type="hidden" id="_client_id" name="_client_id">
                    <div class="form-group">
                        <label for="_client_name" class="control-label" data-translate="Name">Name</label>
                        <input type="text" class="form-control" id="_client_name" name="_client_name">
                    </div>
                    <div class="form-group">
                        <label for="_client_email" class="control-label" data-translate="Email">Email</label>
                        <input type="text" class="form-control" id="_client_email" name="client_email">
                    </div>
                    <div class="form-group">
                        <label for="_client_quota" class="control-label" data-translate="Quota">Quota</label>
                        <select class="form-control" id="_quota_preset" onchange="updateQuotaInput()">
                            <option value="" data-translate="Select Quota">Select Quota</option>
                            <option value="10">10 GB</option>
                            <option value="20">20 GB</option>
                            <option value="30">30 GB</option>
                            <option value="40">40 GB</option>
                            <option value="50">50 GB</option>
                            <option value="100">100 GB</option>
                            <option value="200">200 GB</option>
                            <option value="500">500 GB</option>
                            <option value="1000">1 TB</option>
                            <option value="custom" data-translate="Custom">Custom</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="number" class="form-control" id="_client_quota" name="_client_quota" data-translate-placeholder="Enter custom quota in GB" placeholder="Enter custom quota in GB" step="0.1" min="0" />
                    </div>

                    <div class="form-group">
                        <label for="_client_expiration_days" class="control-label" data-translate="Expiration Days">Expiration Days</label>
                        <input type="number" class="form-control" id="_client_expiration_days" name="_client_expiration_days" placeholder="e.g. 30" min="0" />
                    </div>

                    <div class="form-group">
                        <label for="_client_allocated_ips" class="control-label" data-translate="IP Allocation">IP Allocation</label>
                        <input type="text" data-role="tagsinput" class="form-control" id="_client_allocated_ips">
                    </div>
                    <div class="form-group">
                        <label for="_client_endpoint" class="control-label" data-translate="Endpoint">Endpoint</label>
                        <input type="text" class="form-control" id="_client_endpoint" name="client_endpoint">
                    </div>
                    <div class="form-group" style="margin-top: 0.5rem;">
                        <label for="_client_telegram_userid" class="control-label" data-translate="Telegram userid">Telegram userid</label>
                        <input type="text" class="form-control" id="_client_telegram_userid" name="_client_telegram_userid">
                    </div>
                    <div class="form-group">
                        <label for="_additional_notes" class="control-label" data-translate="Notes">Notes</label>
                        <textarea class="form-control" style="min-height: 6rem;" id="_additional_notes" name="_additional_notes" data-translate-placeholder="Additional notes about this client" placeholder="Additional notes about this client"></textarea>
                    </div>
                    <div class="form-group">
                        <div class="icheck-primary d-inline">
                            <input type="checkbox" id="_use_server_dns">
                            <label for="_use_server_dns" data-translate="Use server DNS">
                                Use server DNS
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="icheck-primary d-inline">
                            <input type="checkbox" id="_enabled">
                            <label for="_enabled" data-translate="Enable this client">
                                Enable this client
                            </label>
                        </div>
                    </div>
                    <details>
                        <summary>
                            <strong data-translate="Public and Preshared Keys">Public and Preshared Keys</strong>
                            <i class="fas fa-info-circle" data-toggle="tooltip"
                               data-translate-title="Update the server stored client Public and Preshared keys."
                               data-original-title="Update the server stored client Public and Preshared keys.">
                            </i>
                        </summary>
                        <div class="form-group" style="margin-top: 1rem">
                            <label for="_client_public_key" class="control-label" data-translate="Public Key">
                                Public Key
                            </label>
                            <input type="text" class="form-control" id="_client_public_key" name="_client_public_key" aria-invalid="false">
                        </div>
                        <div class="form-group">
                            <label for="_client_preshared_key" class="control-label" data-translate="Preshared Key">
                                Preshared Key
                            </label>
                            <input type="text" class="form-control" id="_client_preshared_key" name="_client_preshared_key">
                        </div>
                    </details>
                    <details style="margin-top: 0.5rem;">
                        <summary>
                            <strong data-translate="Additional configuration">Additional configuration</strong>
                        </summary>
                        <div class="form-group">
                            <label for="_client_allowed_ips" class="control-label" data-translate="Allowed IPs">Allowed IPs</label>
                            <input type="text" data-role="tagsinput" class="form-control" id="_client_allowed_ips">
                        </div>
                        <div class="form-group">
                            <label for="_client_extra_allowed_ips" class="control-label" data-translate="Extra Allowed IPs">Extra Allowed IPs</label>
                            <input type="text" data-role="tagsinput" class="form-control"
                                   id="_client_extra_allowed_ips">
                        </div>
                        <div class="form-group">
                            <label for="_subnet_ranges" class="control-label" data-translate="Subnet range">Subnet range</label>
                            <select id="_subnet_ranges" class="select2"
                                    data-translate-placeholder="Select a subnet range"
                                    data-placeholder="Select a subnet range" style="width: 100%;">
                            </select>
                        </div>
                    </details>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Save">Save</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_pause_client">
    <div class="modal-dialog">
        <div class="modal-content bg-warning">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Disable">Disable</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-dark" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                <button type="button" class="btn btn-outline-dark" id="pause_client_confirm" data-translate="Apply">Apply</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_remove_client">
    <div class="modal-dialog">
        <div class="modal-content bg-danger">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Remove">Remove</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-dark" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                <button type="button" class="btn btn-outline-dark" id="remove_client_confirm" data-translate="Apply">Apply</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->
                <span data-translate="QR Code">QR Code</span>
            </h3>
            <button onclick="document.getElementById('modal_qr_code').style.display='none'" class="p-2 hover:bg-gray-100 dark:hover:bg-dark-700 rounded-lg">
                <i class="fas fa-times text-gray-400"></i>
            </button>
        </div>
        
        <div class="p-6 text-center">
            <div class="bg-gray-100 dark:bg-dark-700 rounded-xl p-4 mb-4">
                <img id="qr-code-image" src="" alt="QR Code" class="w-full h-auto max-w-xs mx-auto">
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-400" data-translate="Scan this QR code with your Wireguard client">Scan this QR code with your Wireguard client</p>
        </div>
    </div>
</div>
{{end}}

{{define "bottom_js"}}
<script>
// Global variables
let clients = [];
let filteredClients = [];
let autoRefreshInterval = null;
let isLoading = false;

// DOM elements
const clientsContainer = document.getElementById('clients-container');
const loadingState = document.getElementById('loading-state');
const emptyState = document.getElementById('empty-state');
const searchInput = document.getElementById('search-input');
const statusFilter = document.getElementById('status-filter');
const autoRefreshToggle = document.getElementById('auto-refresh');
const refreshBtn = document.getElementById('refresh-btn');

// Statistics elements
const totalClientsEl = document.getElementById('total-clients');
const onlineClientsEl = document.getElementById('online-clients');
const totalTransferEl = document.getElementById('total-transfer');
const serverStatusEl = document.getElementById('server-status');

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadClients();
    bindEvents();
    updateStats();
});

// Bind events
function bindEvents() {
    searchInput.addEventListener('input', debounce(filterClients, 300));
    statusFilter.addEventListener('change', filterClients);
    autoRefreshToggle.addEventListener('change', toggleAutoRefresh);
    refreshBtn.addEventListener('click', loadClients);
}

// Load clients from server
async function loadClients() {
    if (isLoading) return;
    
    isLoading = true;
    showLoading();
    
    try {
        const response = await fetch(`${basePath}/api/clients`);
        if (response.ok) {
            const data = await response.json();
            clients = data.clients || [];
            filteredClients = [...clients];
            renderClients();
            updateStats();
        } else {
            throw new Error('Failed to load clients');
        }
    } catch (error) {
        console.error('Error loading clients:', error);
        showError('Failed to load clients. Please try again.');
    } finally {
        isLoading = false;
        hideLoading();
    }
}

// Show loading state
function showLoading() {
    loadingState.classList.remove('hidden');
    clientsContainer.classList.add('hidden');
    emptyState.classList.add('hidden');
}

// Hide loading state
function hideLoading() {
    loadingState.classList.add('hidden');
    clientsContainer.classList.remove('hidden');
}

// Filter clients
function filterClients() {
    const searchTerm = searchInput.value.toLowerCase();
    const statusFilterValue = statusFilter.value;
    
    filteredClients = clients.filter(client => {
        const matchesSearch = client.name.toLowerCase().includes(searchTerm) ||
                             client.email.toLowerCase().includes(searchTerm) ||
                             client.allocated_ips.some(ip => ip.includes(searchTerm));
        
        const matchesStatus = statusFilterValue === 'all' || 
                             client.status === statusFilterValue ||
                             (statusFilterValue === 'enabled' && client.enabled) ||
                             (statusFilterValue === 'disabled' && !client.enabled);
        
        return matchesSearch && matchesStatus;
    });
    
    renderClients();
}

// Render clients
function renderClients() {
    if (filteredClients.length === 0) {
        clientsContainer.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
    }
    
    clientsContainer.classList.remove('hidden');
    emptyState.classList.add('hidden');
    
    clientsContainer.innerHTML = filteredClients.map(client => createClientCard(client)).join('');
}

// Create client card HTML
function createClientCard(client) {
    const isOnline = client.status === 'online';
    const statusColor = isOnline ? 'bg-green-500' : 'bg-gray-400';
    const statusText = isOnline ? 'Online' : 'Offline';
    const transferData = formatBytes(client.transfer_rx + client.transfer_tx);
    
    return `
        <div class="client-card bg-white dark:bg-dark-800 rounded-2xl shadow-lg border border-gray-200 dark:border-dark-700 overflow-hidden">
            <!-- Client Header -->
            <div class="p-6 border-b border-gray-200 dark:border-dark-700">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="relative">
                            <div class="w-12 h-12 bg-gradient-to-br from-primary-500 to-primary-600 rounded-xl flex items-center justify-center text-white font-bold text-lg">
                                ${client.name.charAt(0).toUpperCase()}
                            </div>
                            <div class="absolute -bottom-1 -right-1 w-4 h-4 ${statusColor} rounded-full border-2 border-white dark:border-dark-800"></div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">${client.name}</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400">${client.email}</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <span class="status-badge px-3 py-1 text-xs font-medium rounded-full ${isOnline ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200'}">
                            ${statusText}
                        </span>
                        <div class="flex items-center space-x-1">
                            <button onclick="editClient('${client.id}')" class="action-button p-2 text-gray-400 hover:text-primary-500 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-700">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="showQRCode('${client.id}')" class="action-button p-2 text-gray-400 hover:text-primary-500 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-700">
                                <i class="fas fa-qrcode"></i>
                            </button>
                            <button onclick="toggleClient('${client.id}')" class="action-button p-2 text-gray-400 hover:text-primary-500 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-700">
                                <i class="fas fa-${client.enabled ? 'pause' : 'play'}"></i>
                            </button>
                            <button onclick="deleteClient('${client.id}')" class="action-button p-2 text-gray-400 hover:text-red-500 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Client Details -->
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">IP Address</p>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">${client.allocated_ips.join(', ')}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Data Transfer</p>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">${transferData}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Last Seen</p>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">${client.last_handshake || 'Never'}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Quota</p>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">${client.quota ? formatBytes(client.quota) : 'Unlimited'}</p>
                    </div>
                </div>
                
                ${client.notes ? `
                <div class="bg-gray-50 dark:bg-dark-700 rounded-xl p-3">
                    <p class="text-sm text-gray-700 dark:text-gray-300">${client.notes}</p>
                </div>
                ` : ''}
            </div>
        </div>
    `;
}

// Update statistics
function updateStats() {
    const totalClients = clients.length;
    const onlineClients = clients.filter(c => c.status === 'online').length;
    const totalTransfer = clients.reduce((sum, c) => sum + c.transfer_rx + c.transfer_tx, 0);
    
    totalClientsEl.textContent = totalClients;
    onlineClientsEl.textContent = onlineClients;
    totalTransferEl.textContent = formatBytes(totalTransfer);
    
    // Animate counters
    animateCounter(totalClientsEl, totalClients);
    animateCounter(onlineClientsEl, onlineClients);
}

// Animate counter
function animateCounter(element, target) {
    const start = parseInt(element.textContent) || 0;
    const duration = 1000;
    const startTime = performance.now();
    
    function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const current = Math.floor(start + (target - start) * progress);
        
        element.textContent = current;
        
        if (progress < 1) {
            requestAnimationFrame(update);
        }
    }
    
    requestAnimationFrame(update);
}

// Toggle auto refresh
function toggleAutoRefresh() {
    if (autoRefreshToggle.checked) {
        autoRefreshInterval = setInterval(loadClients, 10000); // 10 seconds
    } else {
        clearInterval(autoRefreshInterval);
    }
}

// Client actions
function editClient(clientId) {
    const client = clients.find(c => c.id === clientId);
    if (!client) return;
    
    document.getElementById('edit-client-id').value = client.id;
    document.getElementById('edit-client-name').value = client.name;
    document.getElementById('edit-client-email').value = client.email;
    document.getElementById('edit-client-quota').value = client.quota ? client.quota / (1024 * 1024 * 1024) : '';
    document.getElementById('edit-client-expiry').value = client.expiry_days || '';
    document.getElementById('edit-client-notes').value = client.notes || '';
    document.getElementById('edit-client-enabled').checked = client.enabled;
    document.getElementById('edit-client-dns').checked = client.use_server_dns;
    
    document.getElementById('modal_edit_client').style.display = 'block';
}

function showQRCode(clientId) {
    const client = clients.find(c => c.id === clientId);
    if (!client) return;
    
    document.getElementById('qr-code-image').src = `${basePath}/api/client/${clientId}/qr`;
    document.getElementById('modal_qr_code').style.display = 'block';
}

function toggleClient(clientId) {
    const client = clients.find(c => c.id === clientId);
    if (!client) return;
    
    // Toggle client enabled state
    fetch(`${basePath}/api/client/${clientId}/toggle`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadClients();
            showSuccess(`Client ${client.enabled ? 'disabled' : 'enabled'} successfully`);
        } else {
            showError('Failed to toggle client');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Failed to toggle client');
    });
}

function deleteClient(clientId) {
    const client = clients.find(c => c.id === clientId);
    if (!client) return;
    
    if (confirm(`Are you sure you want to delete client "${client.name}"?`)) {
        fetch(`${basePath}/api/client/${clientId}`, {
            method: 'DELETE',
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadClients();
                showSuccess('Client deleted successfully');
            } else {
                showError('Failed to delete client');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Failed to delete client');
        });
    }
}

// Utility functions
function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function showSuccess(message) {
    // You can integrate with a toast library here
    console.log('Success:', message);
}

function showError(message) {
    // You can integrate with a toast library here
    console.error('Error:', message);
}

// Global base path
const basePath = '{{.basePath}}';

// Handle edit client form submission
document.getElementById('edit-client-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const clientId = formData.get('client_id');
    
    fetch(`${basePath}/api/client/${clientId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: formData.get('client_name'),
            email: formData.get('client_email'),
            quota: formData.get('client_quota') ? parseFloat(formData.get('client_quota')) * 1024 * 1024 * 1024 : null,
            expiry_days: formData.get('client_expiry') ? parseInt(formData.get('client_expiry')) : null,
            notes: formData.get('client_notes'),
            enabled: formData.get('client_enabled') === 'on',
            use_server_dns: formData.get('client_dns') === 'on',
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('modal_edit_client').style.display = 'none';
            loadClients();
            showSuccess('Client updated successfully');
        } else {
            showError('Failed to update client');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Failed to update client');
    });
});
</script>
{{end}}