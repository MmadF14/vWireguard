{{define "title"}}
Wireguard Clients
{{end}}

{{define "top_css"}}
<style>
    .paused-client {
        transition: transform .2s;
        cursor: pointer;
    }
    i[class^="paused-client"]:hover { transform: scale(1.5); }
</style>
{{end}}

{{define "username"}}
{{ .username }}
{{end}}

{{define "page_title"}}
Wireguard Clients
{{end}}

{{define "page_content"}}
<section class="content">
    <div class="container-fluid">
        <!-- <h5 class="mt-4 mb-2">Wireguard Clients</h5> -->
        <div class="row" id="client-list">
        </div>
        <!-- /.row -->
    </div>
</section>

<div class="modal fade" id="modal_email_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Email Configuration</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_email_client" id="frm_email_client">
                <div class="modal-body">
                    <input type="hidden" id="e_client_id" name="e_client_id">
                    <div class="form-group">
                        <label for="e_client_email" class="control-label">Email address</label>
                        <input type="text" class="form-control" id="e_client_email" name="e_client_email">
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Send</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_qr_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">QR Code</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="qr_client_id" name="qr_client_id">
                <img id="qr_code" class="w-100" style="image-rendering: pixelated;" src="" alt="QR code" />
                <!-- do not include FwMark in any client configs: it is INVALID. -->
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_telegram_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Telegram Configuration</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_telegram_client" id="frm_telegram_client">
                <div class="modal-body">
                    <input type="hidden" id="tg_client_id" name="tg_client_id">
                    <div class="form-group">
                        <label for="tg_client_userid" class="control-label">Telegram userid</label>
                        <input type="text" class="form-control" id="tg_client_userid" name="tg_client_userid">
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Send</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_edit_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Edit Client</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_edit_client" id="frm_edit_client">
                <div class="modal-body">
                    <input type="hidden" id="_client_id" name="_client_id">
                    <div class="form-group">
                        <label for="_client_name" class="control-label">Name</label>
                        <input type="text" class="form-control" id="_client_name" name="_client_name">
                    </div>
                    <div class="form-group">
                        <label for="_client_email" class="control-label">Email</label>
                        <input type="text" class="form-control" id="_client_email" name="client_email">
                    </div>
                    <div class="form-group">
                        <label for="_client_quota" class="control-label">Quota</label>
                        <select class="form-control" id="_quota_preset" onchange="updateQuotaInput()">
                            <option value="">Select Quota</option>
                            <option value="1">1 GB</option>
                            <option value="2">2 GB</option>
                            <option value="5">5 GB</option>
                            <option value="10">10 GB</option>
                            <option value="20">20 GB</option>
                            <option value="50">50 GB</option>
                            <option value="100">100 GB</option>
                            <option value="200">200 GB</option>
                            <option value="500">500 GB</option>
                            <option value="1000">1 TB</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="number" class="form-control" id="_client_quota" name="_client_quota" placeholder="Enter custom quota in GB" step="0.1" min="0" />
                    </div>

                    <div class="form-group">
                        <label for="_client_expiration" class="control-label">Expiration Date</label>
                        <!-- از نوع datetime-local استفاده می‌کنیم تا کاربر بتواند تاریخ و ساعت انتخاب کند -->
                        <input type="datetime-local" class="form-control" id="_client_expiration" name="_client_expiration" placeholder="e.g. 2025-12-31T23:59" />
                    </div>

                    <div class="form-group">
                        <label for="_subnet_ranges" class="control-label">Subnet range</label>
                        <select id="_subnet_ranges" class="select2"
                                data-placeholder="Select a subnet range" style="width: 100%;">
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="_client_allocated_ips" class="control-label">IP Allocation</label>
                        <input type="text" data-role="tagsinput" class="form-control" id="_client_allocated_ips">
                    </div>
                    <div class="form-group">
                        <label for="_client_allowed_ips" class="control-label">Allowed IPs</label>
                        <input type="text" data-role="tagsinput" class="form-control" id="_client_allowed_ips">
                    </div>
                    <div class="form-group">
                        <label for="_client_extra_allowed_ips" class="control-label">Extra Allowed IPs</label>
                        <input type="text" data-role="tagsinput" class="form-control"
                               id="_client_extra_allowed_ips">
                    </div>
                    <div class="form-group">
                        <label for="_client_endpoint" class="control-label">Endpoint</label>
                        <input type="text" class="form-control" id="_client_endpoint" name="client_endpoint">
                    </div>
                    <div class="form-group">
                        <div class="icheck-primary d-inline">
                            <input type="checkbox" id="_use_server_dns">
                            <label for="_use_server_dns">
                                Use server DNS
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="icheck-primary d-inline">
                            <input type="checkbox" id="_enabled">
                            <label for="_enabled">
                                Enable this client
                            </label>
                        </div>
                    </div>
                    <details>
                        <summary>
                            <strong>Public and Preshared Keys</strong>
                            <i class="fas fa-info-circle" data-toggle="tooltip"
                               data-original-title="Update the server stored
                               client Public and Preshared keys.">
                            </i>
                        </summary>
                        <div class="form-group" style="margin-top: 1rem">
                            <label for="_client_public_key" class="control-label">
                                Public Key
                            </label>
                            <input type="text" class="form-control" id="_client_public_key" name="_client_public_key" aria-invalid="false">
                        </div>
                        <div class="form-group">
                            <label for="_client_preshared_key" class="control-label">
                                Preshared Key
                            </label>
                            <input type="text" class="form-control" id="_client_preshared_key" name="_client_preshared_key">
                        </div>
                    </details>
                    <details style="margin-top: 0.5rem;">
                        <summary>
                            <strong>Additional configuration</strong>
                        </summary>
                        <div class="form-group" style="margin-top: 0.5rem;">
                            <label for="_client_telegram_userid" class="control-label">Telegram userid</label>
                            <input type="text" class="form-control" id="_client_telegram_userid" name="_client_telegram_userid">
                        </div>
                        <div class="form-group">
                            <label for="_additional_notes" class="control-label">Notes</label>
                            <textarea class="form-control" style="min-height: 6rem;" id="_additional_notes" name="_additional_notes" placeholder="Additional notes about this client"></textarea>
                        </div>
                    </details>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Save</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_pause_client">
    <div class="modal-dialog">
        <div class="modal-content bg-warning">
            <div class="modal-header">
                <h4 class="modal-title">Disable</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-dark" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-outline-dark" id="pause_client_confirm">Apply</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_remove_client">
    <div class="modal-dialog">
        <div class="modal-content bg-danger">
            <div class="modal-header">
                <h4 class="modal-title">Remove</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-dark" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-outline-dark" id="remove_client_confirm">Apply</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->
{{end}}

{{define "bottom_js"}}
    <script>
        function populateClientList() {
            console.log('Fetching clients list...');
            $("#client-list").empty();
            
            $.ajax({
                cache: false,
                method: 'GET',
                url: '{{.basePath}}/api/clients',
                dataType: 'json',
                contentType: "application/json",
                success: function(response) {
                    console.log('Raw server response:', response);
                    
                    if (!response) {
                        console.log('No response from server');
                        $("#client-list").html('<div class="col-12 text-center"><p>No clients found</p></div>');
                        return;
                    }

                    // اگر پاسخ به صورت رشته JSON باشد، آن را پارس کنیم
                    let data = response;
                    if (typeof response === 'string') {
                        try {
                            data = JSON.parse(response);
                        } catch (e) {
                            console.error('Error parsing JSON response:', e);
                            toastr.error('Error processing server response');
                            return;
                        }
                    }

                    // اگر داده‌ها آرایه باشند، مستقیماً آنها را رندر کنیم
                    if (Array.isArray(data)) {
                        console.log('Rendering array of clients:', data);
                    renderClientList(data);
                        return;
                    }

                    // اگر داده‌ها یک آبجکت باشند که شامل آرایه clients است
                    if (data.clients && Array.isArray(data.clients)) {
                        console.log('Rendering clients from data.clients:', data.clients);
                        renderClientList(data.clients);
                        return;
                    }

                    // اگر داده‌ها یک آبجکت باشند که شامل آرایه data است
                    if (data.data && Array.isArray(data.data)) {
                        console.log('Rendering clients from data.data:', data.data);
                        renderClientList(data.data);
                        return;
                    }

                    // اگر داده‌ها یک کلاینت منفرد باشند
                    if (data.Client || (data.name && data.id)) {
                        console.log('Rendering single client:', data);
                        renderClientList([data]);
                        return;
                    }

                    console.log('No valid client data found in response');
                    $("#client-list").html('<div class="col-12 text-center"><p>No clients found</p></div>');
                },
                error: function(jqXHR, exception) {
                    console.error('Error fetching clients:', {
                        status: jqXHR.status,
                        statusText: jqXHR.statusText,
                        responseText: jqXHR.responseText
                    });
                    
                    let errorMessage = 'Failed to fetch clients';
                    try {
                        const responseJson = JSON.parse(jqXHR.responseText);
                        errorMessage = responseJson.message || errorMessage;
                    } catch (e) {
                        console.error('Error parsing error response:', e);
                    }
                    
                    toastr.error(errorMessage);
                    $("#client-list").html('<div class="col-12 text-center"><p>Error loading clients</p></div>');
                }
            });
        }

        function autoApplyConfig() {
            $("#apply_config_confirm").click();
        }

        // اضافه کردن متغیر برای ذخیره آخرین فعال‌سازی دستی
        window.lastManualActivation = null;

        let disableInProgress = false;

        function setClientStatus(clientID, status, isAutomatic = false) {
            if (!clientID) {
                console.error('Invalid client ID');
                return;
            }

            if (disableInProgress) {
                console.log('Disable action already in progress, skipping');
                return;
            }

            disableInProgress = true;
            const trySetStatus = (retryCount = 0) => {
                $.ajax({
                    cache: false,
                    method: 'POST',
                    url: '{{.basePath}}/api/client/' + clientID + '/status/' + status,
                    dataType: 'json',
                    contentType: "application/json",
                    data: JSON.stringify({ enabled: status }),
                    success: function(data) {
                        console.log("Set client " + clientID + " status to " + status);
                        toastr.success('Client ' + (status ? 'enabled' : 'disabled') + ' successfully');
                        
                        const divElement = document.getElementById("paused_" + clientID);
                        if (divElement) {
                            divElement.style.visibility = status ? "hidden" : "visible";
                        }

                        if (status && !isAutomatic) {
                            window.lastManualActivation = {
                                clientId: clientID,
                                timestamp: new Date().getTime()
                            };
                            
                            toastr.warning('You have 1 minute to make changes before automatic check');
                            
                            setTimeout(() => {
                                if (window.lastManualActivation && window.lastManualActivation.clientId === clientID) {
                                    window.lastManualActivation = null;
                                }
                            }, 60000);
                        }

                        if (!status && isAutomatic) {
                            applyWireGuardConfig();
                        }

                        populateClientList();
                        disableInProgress = false;
                    },
                    error: function(jqXHR) {
                        console.error('Error setting client status:', jqXHR.status);
                        if (retryCount < 3 && (jqXHR.status === 500 || jqXHR.status === 0)) {
                            setTimeout(() => trySetStatus(retryCount + 1), 1000 * (retryCount + 1));
                        } else {
                            let errorMessage = 'Error changing client status';
                            try {
                                const responseJson = jQuery.parseJSON(jqXHR.responseText);
                                errorMessage = responseJson.message || errorMessage;
                            } catch (e) {
                                console.error('Error parsing error response:', e);
                            }
                            toastr.error(errorMessage);
                            disableInProgress = false;
                        }
                    }
                });
            };

            trySetStatus();
        }

        function applyWireGuardConfig(retryCount = 0) {
            $.ajax({
                cache: false,
                method: 'POST',
                url: '{{.basePath}}/api/apply-wg-config',
                dataType: 'json',
                contentType: "application/json",
                success: function(data) {
                    toastr.success('Configuration applied successfully');
                    populateClientList();
                },
                error: function(jqXHR) {
                    console.error('Error applying config:', jqXHR.status);
                    if (retryCount < 3 && (jqXHR.status === 500 || jqXHR.status === 0)) {
                        setTimeout(() => applyWireGuardConfig(retryCount + 1), 1000 * (retryCount + 1));
                    } else {
                        let errorMessage = 'Error applying configuration';
                        try {
                            const responseJson = jQuery.parseJSON(jqXHR.responseText);
                            errorMessage = responseJson.message || errorMessage;
                        } catch (e) {
                            console.error('Error parsing error response:', e);
                        }
                        toastr.error(errorMessage);
                    }
                }
            });
        }

        function pauseClient(clientID) {
            setClientStatus(clientID, false);
        }

        function resumeClient(clientID) {
            setClientStatus(clientID, true);
        }

        // updateIPAllocationSuggestion function for automatically fill
        // the IP Allocation input with suggested ip addresses
        // FOR CHANGING A SUBNET OF AN EXISTING CLIENT
        function updateIPAllocationSuggestionExisting() {
            let subnetRange = $("#_subnet_ranges").select2('val');

            if (!subnetRange || subnetRange.length === 0) {
                subnetRange = '__default_any__';
            }
            
            // اضافه کردن مدیریت خطا و retry
            const tryFetchSuggestions = (retryCount = 0) => {
            $.ajax({
                cache: false,
                method: 'GET',
                    url: `{{.basePath}}/api/suggest-client-ips`,
                    data: { sr: subnetRange },
                dataType: 'json',
                contentType: "application/json",
                success: function(data) {
                        if (!data || !Array.isArray(data)) {
                            console.error('Invalid response format:', data);
                            return;
                        }
                        
                        const allocated_ips = $("#_client_allocated_ips").val();
                        if (allocated_ips) {
                            allocated_ips.split(",").forEach(function (item) {
                                if (item) {
                        $('#_client_allocated_ips').removeTag(escape(item));
                                }
                            });
                        }
                        
                        data.forEach(function (item) {
                            if (item) {
                        $('#_client_allocated_ips').addTag(item);
                            }
                        });
                    },
                    error: function(jqXHR) {
                        console.error('Error fetching IP suggestions:', jqXHR.status);
                        if (retryCount < 3 && (jqXHR.status === 503 || jqXHR.status === 0)) {
                            setTimeout(() => tryFetchSuggestions(retryCount + 1), 1000 * (retryCount + 1));
                        } else {
                            let errorMessage = 'Failed to get IP suggestions';
                            try {
                    const responseJson = jQuery.parseJSON(jqXHR.responseText);
                                errorMessage = responseJson.message || errorMessage;
                            } catch (e) {
                                console.error('Error parsing error response:', e);
                            }
                            toastr.error(errorMessage);
                        }
                    }
                });
            };

            tryFetchSuggestions();
        }

        function updateSubnetRangesList(elementID, preselectedVal) {
            $.getJSON("{{.basePath}}/api/subnet-ranges", null, function(data) {
                $(`${elementID} option`).remove();
                $(elementID).append(
                    $("<option></option>")
                        .text("Any")
                        .val("__default_any__")
                );
                $.each(data, function(index, item) {
                    $(elementID).append(
                        $("<option></option>")
                            .text(item)
                            .val(item)
                    );
                    if (item === preselectedVal) {
                        console.log(preselectedVal);
                        $(elementID).val(preselectedVal).trigger('change')
                    }
                });
            });
        }

        function updateSearchList() {
            $.getJSON("{{.basePath}}/api/subnet-ranges", null, function(data) {
                $("#status-selector option").remove();
                $("#status-selector").append(
                    $("<option></option>")
                        .text("All")
                        .val("All"),
                    $("<option></option>")
                        .text("Enabled")
                        .val("Enabled"),
                    $("<option></option>")
                        .text("Disabled")
                        .val("Disabled"),
                    $("<option></option>")
                        .text("Connected")
                        .val("Connected"),
                    $("<option></option>")
                        .text("Disconnected")
                        .val("Disconnected")
                );
                $.each(data, function(index, item) {
                    $("#status-selector").append(
                        $("<option></option>")
                            .text(item)
                            .val(item)
                    );
                });
            });
        }
    </script>
    <script>
        // load client list
        $(document).ready(function () {
            updateSearchList();
            populateClientList();
        })

        // show search bar and override :contains to be case-insensitive
        $(document).ready(function () {
            $("#search-form").show();
            jQuery.expr[':'].contains = function(a, i, m) {
                return jQuery(a).text().toUpperCase()
                    .indexOf(m[3].toUpperCase()) >= 0;
            };
        })

        // hide all clients and display only the ones that meet the search criteria (name, email, IP)
        $('#search-input').keyup(function () {
            $("#status-selector").val("All");
            let query = $(this).val().trim();
            $('.col-lg-4').hide();
            $(".info-box-text").each(function() {
                if($(this).children('i.fa-user').length > 0 || $(this).children('i.fa-envelope').length > 0)
                {
                    $(this).filter(':contains("' + query + '")').parent().parent().parent().show();
                }
                })
            $(".badge-secondary").filter(':contains("' + query + '")').parent().parent().parent().show();
            $(".fa-tguserid").each(function () {
                if ($(this).parent().text().trim().indexOf(query) != -1) {
                    $(this).closest('.col-lg-4').show();
                }
            })
            let upperQuery = query.toUpperCase()
            $(".fa-additional_notes").each(function () {
                if ($(this).parent().text().trim().indexOf(upperQuery) != -1) {
                    $(this).closest('.col-lg-4').show();
                }
            })
        })

        $("#status-selector").on('change', function () {
            $('#search-input').val("");
            switch ($("#status-selector").val()) {
                case "All":
                    $('.col-lg-4').show();
                    break;
                case "Enabled":
                    $('.col-lg-4').hide();
                    $('[id^="paused_"]').each(function () {
                        if ($(this).css("visibility") === "hidden") {
                            $(this).parent().parent().show();
                        }
                    });
                    break;
                case "Disabled":
                    $('.col-lg-4').hide();
                    $('[id^="paused_"]').each(function () {
                        if ($(this).css("visibility") !== "hidden") {
                            $(this).parent().parent().show();
                        }
                    });
                    break;
                case "Connected":
                    $('.col-lg-4').hide();
                    $.ajax({
                        cache: false,
                        method: 'GET',
                        url: '{{.basePath}}/status',
                        success: function (data) {
                            const returnedHTML = $(data).find(".table-success").get();
                            var returnedString = "";
                            returnedHTML.forEach(entry => returnedString += entry.outerHTML);
                            $(".fa-key").each(function () {
                                if (returnedString.indexOf($(this).parent().text().trim()) != -1) {
                                    $(this).closest('.col-lg-4').show();
                                }
                            })
                        }
                    });
                    break;
                case "Disconnected":
                    $('.col-lg-4').show();
                    $.ajax({
                        cache: false,
                        method: 'GET',
                        url: '{{.basePath}}/status',
                        success: function (data) {
                            const returnedHTML = $(data).find(".table-success").get();
                            var returnedString = "";
                            returnedHTML.forEach(entry => returnedString += entry.outerHTML);
                            $(".fa-key").each(function () {
                                if (returnedString.indexOf($(this).parent().text().trim()) != -1) {
                                    $(this).closest('.col-lg-4').hide();
                                }
                            })
                        }
                    });
                    break;
                default:
                    $('.col-lg-4').hide();
                    const selectedSR = $("#status-selector").val()
                    $(".fa-subnetrange").each(function () {
                        const srs = $(this).parent().text().trim().split(',')
                        for (const sr of srs) {
                            if (sr === selectedSR) {
                                $(this).closest('.col-lg-4').show();
                                break
                            }                            
                        }
                    })
                    // $('.col-lg-4').show();
                    break;
            }
        });

        // modal_pause_client modal event
        $("#modal_pause_client").on('show.bs.modal', function (event) {
            const button = $(event.relatedTarget);
            const client_id = button.data('clientid');
            const client_name = button.data('clientname');
            const modal = $(this);
            modal.find('.modal-body').text("You are about to disable client " + client_name);
            modal.find('#pause_client_confirm').val(client_id);
        })

        // pause_client_confirm button event
        $(document).ready(function () {
            $("#pause_client_confirm").click(function () {
                const client_id = $(this).val();
                pauseClient(client_id);
                $("#modal_pause_client").modal('hide');
            });
        });

        // modal_remove_client modal event
        $("#modal_remove_client").on('show.bs.modal', function (event) {
            const button = $(event.relatedTarget);
            const client_id = button.data('clientid');
            const client_name = button.data('clientname');
            const modal = $(this);
            modal.find('.modal-body').text("You are about to remove client " + client_name);
            modal.find('#remove_client_confirm').val(client_id);
        })

        // remove_client_confirm button event
        $(document).ready(function () {
            $("#remove_client_confirm").click(function () {
                const client_id = $(this).val();
                const data = {"id": client_id};
                $.ajax({
                    cache: false,
                    method: 'DELETE',
                    url: '{{.basePath}}/api/client/' + client_id,
                    dataType: 'json',
                    contentType: "application/json",
                    data: JSON.stringify(data),
                    success: function(data) {
                        $("#modal_remove_client").modal('hide');
                        toastr.success('Removed client successfully');
                        const divElement = document.getElementById('client_' + client_id);
                        divElement.style.display = "none";
                    },
                    error: function(jqXHR, exception) {
                        const responseJson = jQuery.parseJSON(jqXHR.responseText);
                        toastr.error(responseJson['message']);
                    }
                });
            });
        });



        // Edit client modal event
        // This fills the modal dialogue with data from the DB when we open the edit menu
        $(document).ready(function () {
            $("#modal_edit_client").on('show.bs.modal', function (event) {
                let modal = $(this);
                const button = $(event.relatedTarget);
                const client_id = button.data('clientid');

                // IP Allocation tag input
                modal.find("#_client_allocated_ips").tagsInput({
                    'width': '100%',
                    'height': '75%',
                    'interactive': true,
                    'defaultText': 'Add More',
                    'removeWithBackspace': true,
                    'minChars': 0,
                    'minInputWidth': '100%',
                    'placeholderColor': '#666666'
                });

                // AllowedIPs tag input
                modal.find("#_client_allowed_ips").tagsInput({
                    'width': '100%',
                    'height': '75%',
                    'interactive': true,
                    'defaultText': 'Add More',
                    'removeWithBackspace': true,
                    'minChars': 0,
                    'minInputWidth': '100%',
                    'placeholderColor': '#666666'
                });

                modal.find("#_client_extra_allowed_ips").tagsInput({
                    'width': '100%',
                    'height': '75%',
                    'interactive': true,
                    'defaultText': 'Add More',
                    'removeWithBackspace': true,
                    'minChars': 0,
                    'minInputWidth': '100%',
                    'placeholderColor': '#666666'
                })

                // دریافت اطلاعات کلاینت از سرور
                $.ajax({
                    cache: false,
                    method: 'GET',
                    url: '{{.basePath}}/api/client/' + client_id,
                    dataType: 'json',
                    contentType: "application/json",
                    success: function (resp) {
                        const client = resp.Client;

                        // مقداردهی عنوان مدال
                        modal.find(".modal-title").text("Edit Client " + client.name);

                        // مقداردهی فیلدهای پنهان
                        modal.find("#_client_id").val(client.id);
                        modal.find("#_client_telegram_userid").val(client.telegram_userid);

                        // مقداردهی فیلدهای ساده
                        modal.find("#_client_name").val(client.name);
                        modal.find("#_client_email").val(client.email);
                        modal.find("#_client_endpoint").val(client.endpoint);
                        modal.find("#_client_public_key").val(client.public_key);
                        modal.find("#_client_preshared_key").val(client.preshared_key);
                        modal.find("#_additional_notes").val(client.additional_notes);

                        // مقداردهی Quota
                        modal.find("#_client_quota").val(client.quota ? (client.quota / (1024 * 1024 * 1024)).toFixed(1) : "");     
                        // مقداردهی Expiration (تبدیل تاریخ UTC به فرمت datetime-local)
                        if (client.expiration) {
                            let dt = new Date(client.expiration); // مثلاً "2025-12-31T23:59:59Z"
                            let year = dt.getFullYear();
                            let month = String(dt.getMonth() + 1).padStart(2, '0');
                            let day = String(dt.getDate()).padStart(2, '0');
                            let hour = String(dt.getHours()).padStart(2, '0');
                            let min = String(dt.getMinutes()).padStart(2, '0');
                            let localDatetime = `${year}-${month}-${day}T${hour}:${min}`;
                            modal.find("#_client_expiration").val(localDatetime);
                        } else {
                            modal.find("#_client_expiration").val("");
                        }

                        // مقداردهی Subnet range
                        let preselectedEl;
                        if (client.subnet_ranges && client.subnet_ranges.length > 0) {
                            preselectedEl = client.subnet_ranges[0];
                        }
                        updateSubnetRangesList("#_subnet_ranges", preselectedEl);

                        // مقداردهی Allocated IPs
                        modal.find("#_client_allocated_ips").importTags('');
                        client.allocated_ips.forEach(function (obj) {
                            modal.find("#_client_allocated_ips").addTag(obj);
                        });

                        // مقداردهی Allowed IPs
                        modal.find("#_client_allowed_ips").importTags('');
                        client.allowed_ips.forEach(function (obj) {
                            modal.find("#_client_allowed_ips").addTag(obj);
                        });

                        // مقداردهی Extra Allowed IPs
                        modal.find("#_client_extra_allowed_ips").importTags('');
                        client.extra_allowed_ips.forEach(function (obj) {
                            modal.find("#_client_extra_allowed_ips").addTag(obj);
                        });

                        // مقداردهی Use server DNS و Enable
                        modal.find("#_use_server_dns").prop("checked", client.use_server_dns);
                        modal.find("#_enabled").prop("checked", client.enabled);

                        // اگر subnet range تغییر کرد، IP Allocation جدید پیشنهاد بده
                        $('#_subnet_ranges').on('select2:select', function (e) {
                            updateIPAllocationSuggestionExisting();
                        });
                    },
                    error: function (jqXHR, exception) {
                        const responseJson = jQuery.parseJSON(jqXHR.responseText);
                        toastr.error(responseJson['message']);
                    }
                });
            });
        });

        // regenerateQRCode function for regenerating QR Code adding/removing some parts of configuration because of compatibility issues with some clients
        function regenerateQRCode() {
            const client_id = $("#qr_client_id").val();
            const QRCodeImg = $("#qr_code");
            const QRCodeA = $("#qr_code_a");
            QRCodeImg.hide();
            $.ajax({
                cache: false,
                method: 'GET',
                url: '{{.basePath}}/api/client/' + client_id,
                data: {

                },
                dataType: 'json',
                contentType: "application/json",
                success: function (resp) {
                    const client = resp.Client;

                    $(".modal-title").text("Scan QR Code for " + client.name + " profile");
                    QRCodeImg.attr('src', resp.QRCode).show();
                    QRCodeA.attr('download', resp.Client.name);
                    QRCodeA.attr('href', resp.QRCode).show();
                },
                error: function (jqXHR, exception) {
                    const responseJson = jQuery.parseJSON(jqXHR.responseText);
                    toastr.error(responseJson['message']);
                }
            });
        }

        // submitEmailClient function for sending an email with the configuration to the client
        function submitEmailClient() {
            const client_id = $("#e_client_id").val();
            const email = $("#e_client_email").val();
            const data = {"id": client_id, "email": email};
            $.ajax({
                cache: false,
                method: 'POST',
                url: '{{.basePath}}/email-client',
                dataType: 'json',
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function(resp) {
                    $("#modal_email_client").modal('hide');
                    toastr.success('Sent email to client successfully');
                },
                error: function(jqXHR, exception) {
                    const responseJson = jQuery.parseJSON(jqXHR.responseText);
                    toastr.error(responseJson['message']);
                }
            });
        }

        // submitTelegramClient function for sending a telegram message with the configuration to the client
        function submitTelegramClient() {
            const client_id = $("#tg_client_id").val();
            const userid = $("#tg_client_userid").val();
            const data = {"id": client_id, "userid": userid};
            $.ajax({
                cache: false,
                method: 'POST',
                url: '{{.basePath}}/send-telegram-client',
                dataType: 'json',
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function(resp) {
                    $("#modal_telegram_client").modal('hide');
                    toastr.success('Sent config via telegram to client successfully');
                },
                error: function(jqXHR, exception) {
                    const responseJson = jQuery.parseJSON(jqXHR.responseText);
                    toastr.error(responseJson['message']);
                }
            });
        }

        //  function for updating an existing client
        // This sends dialogue data to the back-end when user presses "Save"
        // See e.g. routes.go:UpdateClient for where data is processed/verified.
        function submitEditClient() {
            const client_id = $("#_client_id").val();
            const name = $("#_client_name").val();
            const email = $("#_client_email").val();
            const telegram_userid = $("#_client_telegram_userid").val();
            const allocated_ips = $("#_client_allocated_ips").val().split(",");
            const allowed_ips = $("#_client_allowed_ips").val().split(",");
            let use_server_dns = false;
            let extra_allowed_ips = [];
            const public_key = $("#_client_public_key").val();
            const preshared_key = $("#_client_preshared_key").val();

            // اضافه کردن Quota
            const quotaGB = parseFloat($("#_client_quota").val()) || 0;
            const quotaBytes = Math.floor(quotaGB * 1024 * 1024 * 1024);

            // اضافه کردن Expiration
            let expirationValue = $("#_client_expiration").val();
            let expirationIso = "";
            if (expirationValue) {
                expirationIso = new Date(expirationValue).toISOString();
            }

            if ($("#_client_extra_allowed_ips").val() !== "") {
                extra_allowed_ips = $("#_client_extra_allowed_ips").val().split(",");
            }
            const endpoint = $("#_client_endpoint").val();

            if ($("#_use_server_dns").is(':checked')) {
                use_server_dns = true;
            }

            let enabled = false;
            if ($("#_enabled").is(':checked')) {
                enabled = true;
            }

            const additional_notes = $("#_additional_notes").val();

            const data = {
                "id": client_id,
                "name": name,
                "email": email,
                "telegram_userid": telegram_userid,
                "allocated_ips": allocated_ips,
                "allowed_ips": allowed_ips,
                "extra_allowed_ips": extra_allowed_ips,
                "endpoint": endpoint,
                "use_server_dns": use_server_dns,
                "enabled": enabled,
                "public_key": public_key,
                "preshared_key": preshared_key,
                "additional_notes": additional_notes,
                "quota": quotaBytes,
                "expiration": expirationIso
            };

            $.ajax({
                cache: false,
                method: 'POST',
                url: '{{.basePath}}/update-client',
                dataType: 'json',
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function(resp) {
                    $("#modal_edit_client").modal('hide');
                    toastr.success('Updated client successfully');
                    populateClientList();
                },
                error: function(jqXHR, exception) {
                    const responseJson = jQuery.parseJSON(jqXHR.responseText);
                    toastr.error(responseJson['message']);
                }
            });
        }

        // submitHandler
        function submitHandler(form) {
            const formId = $(form).attr('id');
            if (formId === "frm_edit_client") {
                submitEditClient();
            } else if (formId === "frm_email_client") {
                submitEmailClient();
            } else if (formId === "frm_telegram_client") {
                submitTelegramClient();
            }
        }

        $("#modal_email_client").on('show.bs.modal', function (event) {
            let modal = $(this);
            const button = $(event.relatedTarget);
            const client_id = button.data('clientid');
            $.ajax({
                cache: false,
                method: 'GET',
                url: '{{.basePath}}/api/client/' + client_id,
                dataType: 'json',
                contentType: "application/json",
                success: function (resp) {
                    const client = resp.Client;

                    modal.find(".modal-title").text("Send config to client " + client.name);
                    modal.find("#e_client_id").val(client.id);
                    modal.find("#e_client_email").val(client.email);
                },
                error: function (jqXHR, exception) {
                    const responseJson = jQuery.parseJSON(jqXHR.responseText);
                    toastr.error(responseJson['message']);
                }
            });
        });

        $("#modal_qr_client").on('show.bs.modal', function (event) {
            let modal = $(this);
            const button = $(event.relatedTarget);
            const client_id = button.data('clientid');

            modal.find("#qr_client_id").val(client_id);
            regenerateQRCode();
        });

        $("#modal_telegram_client").on('show.bs.modal', function (event) {
            let modal = $(this);
            const button = $(event.relatedTarget);
            const client_id = button.data('clientid');
            $.ajax({
                cache: false,
                method: 'GET',
                url: '{{.basePath}}/api/client/' + client_id,
                dataType: 'json',
                contentType: "application/json",
                success: function (resp) {
                    const client = resp.Client;

                    modal.find(".modal-title").text("Send config to client " + client.name);
                    modal.find("#tg_client_id").val(client.id);
                    modal.find("#tg_client_userid").val(client.telegram_userid);
                },
                error: function (jqXHR, exception) {
                    const responseJson = jQuery.parseJSON(jqXHR.responseText);
                    toastr.error(responseJson['message']);
                }
            });
        });

        $(document).ready(function () {
            $.validator.setDefaults({
                submitHandler: function (form) {
                    submitHandler(form);
                }
            });
            // Edit client form validation
            $("#frm_edit_client").validate({
                rules: {
                    client_name: {
                        required: true,
                    },
                },
                messages: {
                    client_name: {
                        required: "Please enter a name"
                    },
                },
                errorElement: 'span',
                errorPlacement: function (error, element) {
                    error.addClass('invalid-feedback');
                    element.closest('.form-group').append(error);
                },
                highlight: function (element, errorClass, validClass) {
                    $(element).addClass('is-invalid');
                },
                unhighlight: function (element, errorClass, validClass) {
                    $(element).removeClass('is-invalid');
                }
            });
            // Email client form validation
            $("#frm_email_client").validate({
                rules: {
                    e_client_email: {
                        required: true,
                        email: true,
                    },
                },
                messages: {
                    e_client_email: {
                        required: "Please enter an email"
                    },
                },
                errorElement: 'span',
                errorPlacement: function (error, element) {
                    error.addClass('invalid-feedback');
                    element.closest('.form-group').append(error);
                },
                highlight: function (element, errorClass, validClass) {
                    $(element).addClass('is-invalid');
                },
                unhighlight: function (element, errorClass, validClass) {
                    $(element).removeClass('is-invalid');
                }
            });
            // Telegram client form validation
            $("#frm_telegram_client").validate({
                rules: {
                    tg_client_userid: {
                        required: true,
                        number: true,
                    },
                },
                messages: {
                    tg_client_userid: {
                        required: "Please enter a telegram userid",
                        number: "Please enter a valid telegram userid"
                    },
                },
                errorElement: 'span',
                errorPlacement: function (error, element) {
                    error.addClass('invalid-feedback');
                    element.closest('.form-group').append(error);
                },
                highlight: function (element, errorClass, validClass) {
                    $(element).addClass('is-invalid');
                },
                unhighlight: function (element, errorClass, validClass) {
                    $(element).removeClass('is-invalid');
                }
            });
            // 
        });
    </script>
    <script>
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';

            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];

            const i = Math.floor(Math.log(bytes) / Math.log(k));

            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function renderClientList(clients) {
            console.log('Rendering clients:', clients);
            const clientList = $("#client-list");
            clientList.empty();

            if (!clients || !Array.isArray(clients) || clients.length === 0) {
                clientList.html('<div class="col-12 text-center"><p>No clients found</p></div>');
                return;
            }

            clients.forEach(function(data) {
                try {
                    let client = data.Client || data;
                    
                    if (!client || !client.id) {
                        console.error('Invalid client data:', data);
                        return;
                    }

                    // بررسی آیا این کلاینت اخیراً به صورت دستی فعال شده است
                    const isRecentlyActivated = window.lastManualActivation && 
                                          window.lastManualActivation.clientId === client.id && 
                                          (new Date().getTime() - window.lastManualActivation.timestamp) < 60000;

                    // فقط اگر اخیراً فعال نشده باشد، شرایط را بررسی کن
                    if (client.enabled && !isRecentlyActivated) {
                        let shouldDeactivate = false;
                        let deactivationReason = '';

                        // بررسی حجم مصرفی
                        if (client.quota > 0 && client.used_quota >= client.quota) {
                            shouldDeactivate = true;
                            deactivationReason = 'quota exceeded';
                        }

                        // بررسی تاریخ انقضا
                        if (client.expiration) {
                            const expDate = new Date(client.expiration);
                            const now = new Date();
                            if (expDate <= now) {
                                shouldDeactivate = true;
                                deactivationReason = 'expired';
                            }
                        }

                        // اگر نیاز به غیرفعال‌سازی باشد
                        if (shouldDeactivate) {
                            console.log(`Auto-deactivating client ${client.name} (${deactivationReason})`);
                            setClientStatus(client.id, false, true);
                        }
                    }

                    // ساخت HTML برای کلاینت
                    let html = `
                        <div class="col-sm-6 col-md-6 col-lg-4" id="client_${client.id}">
                            <div class="info-box">
                                <div class="overlay" id="paused_${client.id}" style="visibility: ${client.enabled ? 'hidden' : 'visible'}">
                                    <i class="paused-client fas fa-3x fa-play" onclick="resumeClient('${client.id}')"></i>
                                </div>
                                <div class="info-box-content" style="overflow: hidden">`;

                    // اضافه کردن دکمه‌ها
                    html += `
                        <div class="btn-group">
                            <a href="{{.basePath}}/download?clientid=${client.id}" class="btn btn-outline-primary btn-sm">Download</a>
                        </div>
                        <div class="btn-group">      
                            <button type="button" class="btn btn-outline-primary btn-sm" data-toggle="modal"
                                data-target="#modal_qr_client" data-clientid="${client.id}"
                                data-clientname="${client.name}" ${data.QRCode ? '' : 'disabled'}>QR code</button>
                        </div>
                        <div class="btn-group">      
                            <button type="button" class="btn btn-outline-primary btn-sm" data-toggle="modal"
                                data-target="#modal_email_client" data-clientid="${client.id}"
                                data-clientname="${client.name}">Email</button>
                        </div>`;

                    // اضافه کردن دکمه تلگرام اگر telegram_userid وجود داشته باشد
                    if (client.telegram_userid) {
                        html += `
                            <div class="btn-group">      
                                <button type="button" class="btn btn-outline-primary btn-sm" data-toggle="modal"
                                    data-target="#modal_telegram_client" data-clientid="${client.id}"
                                    data-clientname="${client.name}">Telegram</button>
                            </div>`;
                    }

                    // منوی More
                    html += `
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-danger btn-sm">More</button>
                            <button type="button" class="btn btn-outline-danger btn-sm dropdown-toggle dropdown-icon" 
                                data-toggle="dropdown">
                            </button>
                            <div class="dropdown-menu" role="menu">
                                <a class="dropdown-item" href="#" data-toggle="modal"
                                    data-target="#modal_edit_client" data-clientid="${client.id}"
                                    data-clientname="${client.name}">Edit</a>
                                <a class="dropdown-item" href="#" data-toggle="modal"
                                    data-target="#modal_pause_client" data-clientid="${client.id}"
                                    data-clientname="${client.name}">Disable</a>
                                <a class="dropdown-item" href="#" data-toggle="modal"
                                    data-target="#modal_remove_client" data-clientid="${client.id}"
                                    data-clientname="${client.name}">Delete</a>
                            </div>
                        </div>
                        <hr>`;

                    // اطلاعات اصلی کلاینت
                    html += `<span class="info-box-text"><i class="fas fa-user"></i> ${client.name || 'Unnamed Client'}</span>`;

                    if (client.email) {
                        html += `<span class="info-box-text"><i class="fas fa-envelope"></i> ${client.email}</span>`;
                    }

                    if (client.created_at) {
                        html += `<span class="info-box-text"><i class="fas fa-clock"></i> ${prettyDateTime(client.created_at)}</span>`;
                    }

                    if (client.updated_at) {
                        html += `<span class="info-box-text"><i class="fas fa-history"></i> ${prettyDateTime(client.updated_at)}</span>`;
                    }

                    // نمایش حجم مصرفی و باقی‌مانده
                    if (client.quota > 0) {
                        const quotaFormatted = formatBytes(client.quota);
                        const usedFormatted = formatBytes(client.used_quota || 0);
                        const remainingBytes = Math.max(0, client.quota - (client.used_quota || 0));
                        const remainingFormatted = formatBytes(remainingBytes);
                        
                        const usagePercent = Math.min(100, ((client.used_quota || 0) / client.quota * 100)).toFixed(1);
                        
                        let progressClass = 'bg-success';
                        if (usagePercent > 90) {
                            progressClass = 'bg-danger';
                        } else if (usagePercent > 70) {
                            progressClass = 'bg-warning';
                        }

                        html += `
                            <span class="info-box-text">
                                <i class="fas fa-database"></i> Usage: ${usedFormatted} / ${quotaFormatted}
                                <div class="progress progress-sm">
                                    <div class="progress-bar ${progressClass}" role="progressbar" 
                                         style="width: ${usagePercent}%" 
                                         aria-valuenow="${usagePercent}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                    </div>
                                </div>
                                <small>Remaining: ${remainingFormatted}</small>
                            </span>`;
                    } else {
                        html += `<span class="info-box-text"><i class="fas fa-database"></i> Unlimited</span>`;
                    }

                    // نمایش تاریخ انقضا
                    if (client.expiration) {
                        const expDate = new Date(client.expiration);
                        const now = new Date();
                        const daysRemaining = Math.ceil((expDate - now) / (1000 * 60 * 60 * 24));
                        
                        let expirationClass = '';
                        if (daysRemaining <= 0) {
                            expirationClass = 'text-danger';
                            // اگر تاریخ انقضا گذشته باشد و کلاینت هنوز فعال باشد
                            if (client.enabled) {
                                setTimeout(() => {
                                    setClientStatus(client.id, false);
                                }, 100);
                            }
                        } else if (daysRemaining <= 7) {
                            expirationClass = 'text-warning';
                        }
                        
                        html += `<span class="info-box-text ${expirationClass}"><i class="fas fa-calendar"></i> Expires: ${prettyDateTime(client.expiration)} (${daysRemaining > 0 ? daysRemaining + ' days remaining' : 'Expired'})</span>`;
                    } else {
                        html += `<span class="info-box-text"><i class="fas fa-calendar"></i> Expiration: Unlimited</span>`;
                    }

                    // نمایش سایر اطلاعات
                    html += `<span class="info-box-text"><i class="fas fa-server" style="opacity: ${client.use_server_dns ? '1.0' : '0.5'}"></i> DNS</span>`;

                    if (client.additional_notes) {
                        html += `<span class="info-box-text"><i class="fas fa-file"></i> ${client.additional_notes}</span>`;
                    }

                    if (client.allocated_ips && Array.isArray(client.allocated_ips) && client.allocated_ips.length > 0) {
                        html += `<span class="info-box-text"><strong>IP Allocation</strong></span>`;
                        client.allocated_ips.forEach(function(ip) {
                            if (ip) {
                                html += `<small class="badge badge-secondary">${ip}</small>&nbsp;`;
                            }
                        });
                    }

                    if (client.allowed_ips && Array.isArray(client.allowed_ips) && client.allowed_ips.length > 0) {
                        html += `<span class="info-box-text"><strong>Allowed IPs</strong></span>`;
                        client.allowed_ips.forEach(function(ip) {
                            if (ip) {
                                html += `<small class="badge badge-secondary">${ip}</small>&nbsp;`;
                            }
                        });
                    }

                    html += `
                                </div>
                            </div>
                        </div>`;

                    clientList.append(html);
                } catch (error) {
                    console.error('Error rendering client:', error, data);
                }
            });
        }
    </script>
    <script>
        function updateQuotaInput() {
            const preset = $("#_quota_preset").val();
            const quotaInput = $("#_client_quota");
            
            if (preset === "custom") {
                quotaInput.prop("disabled", false);
                quotaInput.val("");
            } else if (preset) {
                quotaInput.prop("disabled", true);
                quotaInput.val(preset);
            } else {
                quotaInput.prop("disabled", false);
                quotaInput.val("");
            }
        }

        $(document).ready(function() {
            updateQuotaInput();
        });
    </script>
    <script>
        // New Client modal event
        $(document).ready(function () {
            let newClientModal = $("#modal_new_client");
            
            // تنظیم IP Allocation tag input برای مدال جدید
            $("#client_allocated_ips").tagsInput({
                'width': '100%',
                'height': '75%',
                'interactive': true,
                'defaultText': 'Add More',
                'removeWithBackspace': true,
                'minChars': 0,
                'minInputWidth': '100%',
                'placeholderColor': '#666666'
            });

            // تنظیم Extra Allowed IPs tag input برای مدال جدید
            $("#client_extra_allowed_ips").tagsInput({
                'width': '100%',
                'height': '75%',
                'interactive': true,
                'defaultText': 'Add More',
                'removeWithBackspace': true,
                'minChars': 0,
                'minInputWidth': '100%',
                'placeholderColor': '#666666'
            });
            
            newClientModal.on('shown.bs.modal', function (e) {
                $("#client_name").val("");
                $("#client_email").val("");
                $("#client_public_key").val("");
                $("#client_preshared_key").val("");
                $("#client_allocated_ips").importTags('');
                $("#client_extra_allowed_ips").importTags('');
                $("#client_endpoint").val('');
                $("#client_telegram_userid").val('');
                $("#additional_notes").val('');
                $("#client_quota").val("");
                $("#client_expiration").val("");
                
                // تنظیم مقادیر پیش‌فرض
                $("#use_server_dns").prop("checked", true);
                $("#enabled").prop("checked", true);
                
                updateSubnetRangesList("#subnet_ranges");
            });

            // Form validation and submission
            $("#frm_new_client").validate({
                rules: {
                    client_name: {
                        required: true
                    }
                },
                messages: {
                    client_name: {
                        required: "Please enter a name"
                    }
                },
                errorElement: 'span',
                errorPlacement: function (error, element) {
                    error.addClass('invalid-feedback');
                    element.closest('.form-group').append(error);
                },
                highlight: function (element, errorClass, validClass) {
                    $(element).addClass('is-invalid');
                },
                unhighlight: function (element, errorClass, validClass) {
                    $(element).removeClass('is-invalid');
                },
                submitHandler: function(form, event) {
                    event.preventDefault();
                    
                    const name = $("#client_name").val();
                    const quotaGB = parseFloat($("#client_quota").val()) || 0;
                    const quotaBytes = Math.floor(quotaGB * 1024 * 1024 * 1024);

                    let expirationValue = $("#client_expiration").val();
                    let expirationIso = "";
                    if (expirationValue) {
                        const expDate = new Date(expirationValue);
                        if (expDate <= new Date()) {
                            toastr.error('Expiration date must be in the future');
                            return;
                        }
                        expirationIso = expDate.toISOString();
                    }

                    const formData = {
                        name: name,
                        email: $("#client_email").val() || "",
                        public_key: $("#client_public_key").val() || "",
                        preshared_key: $("#client_preshared_key").val() || "",
                        allocated_ips: $("#client_allocated_ips").val() ? $("#client_allocated_ips").val().split(",").filter(Boolean) : [],
                        allowed_ips: ["0.0.0.0/0", "::/0"],
                        extra_allowed_ips: $("#client_extra_allowed_ips").val() ? $("#client_extra_allowed_ips").val().split(",").filter(Boolean) : [],
                        endpoint: $("#client_endpoint").val() || "",
                        telegram_userid: $("#client_telegram_userid").val() || "",
                        additional_notes: $("#additional_notes").val() || "",
                        use_server_dns: $("#use_server_dns").is(":checked"),
                        enabled: true,
                        quota: quotaBytes || 0,
                        expiration: expirationIso || null,
                        subnet_ranges: ["__default_any__"]
                    };

                    const tryCreateClient = (retryCount = 0) => {
                        $.ajax({
                            cache: false,
                            method: 'POST',
                            url: '{{.basePath}}/new-client',
                            dataType: 'json',
                            contentType: "application/json",
                            data: JSON.stringify(formData),
                            success: function(response) {
                                newClientModal.modal('hide');
                                toastr.success('Created client successfully');
                                populateClientList();
                            },
                            error: function(jqXHR) {
                                console.error('Error creating client:', jqXHR.status);
                                if (retryCount < 3 && (jqXHR.status === 500 || jqXHR.status === 0)) {
                                    setTimeout(() => tryCreateClient(retryCount + 1), 1000 * (retryCount + 1));
                                } else {
                                    let errorMessage = 'Error creating client';
                                    try {
                                        const responseJson = jQuery.parseJSON(jqXHR.responseText);
                                        errorMessage = responseJson.message || errorMessage;
                                    } catch (e) {
                                        console.error('Error parsing error response:', e);
                                    }
                                    toastr.error(errorMessage);
                                }
                            }
                        });
                    };

                    tryCreateClient();
                }
            });
        });
    </script>
{{end}}