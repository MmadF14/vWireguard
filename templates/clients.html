{{define "title"}}
<span data-translate="Wireguard Clients">Wireguard Clients</span>
{{end}}

{{define "top_css"}}
<style>
    .paused-client {
        transition: transform .2s;
        cursor: pointer;
    }
    i[class^="paused-client"]:hover { transform: scale(1.5); }
</style>
{{end}}

{{define "username"}}
{{ .username }}
{{end}}

{{define "page_title"}}
<span data-translate="Wireguard Clients">Wireguard Clients</span>
{{end}}

{{define "page_content"}}
<section class="content">
    <div class="container-fluid">
        <!-- <h5 class="mt-4 mb-2">Wireguard Clients</h5> -->
        <div class="row mb-2">
            <div class="col-12 d-flex justify-content-end align-items-center">
                <div class="mr-3">
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="auto-refresh-toggle">
                        <label class="custom-control-label" for="auto-refresh-toggle" data-translate="Auto Refresh">Auto Refresh</label>
                    </div>
                </div>
                <select id="refresh-interval" class="form-control mr-2" style="width: auto;" disabled>
                    <option value="5" data-translate="5 seconds">5 seconds</option>
                    <option value="10" data-translate="10 seconds">10 seconds</option>
                    <option value="30" data-translate="30 seconds">30 seconds</option>
                    <option value="60" data-translate="60 seconds">60 seconds</option>
                </select>
                <button type="button" id="refresh-status-btn" class="btn btn-outline-secondary">
                    <i class="fas fa-sync-alt"></i> <span data-translate="Refresh Status">Refresh Status</span>
                </button>
            </div>
        </div>
        <div class="row" id="client-list">
        </div>
        <!-- /.row -->
    </div>
</section>

<div class="modal fade" id="modal_email_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Email Configuration">Email Configuration</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_email_client" id="frm_email_client">
                <div class="modal-body">
                    <input type="hidden" id="e_client_id" name="e_client_id">
                    <div class="form-group">
                        <label for="e_client_email" class="control-label" data-translate="Email address">Email address</label>
                        <input type="text" class="form-control" id="e_client_email" name="e_client_email">
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Send">Send</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_qr_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="QR Code">QR Code</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="qr_client_id" name="qr_client_id">
                <img id="qr_code" class="w-100" style="image-rendering: pixelated;" src="" alt="QR code" />
                <!-- do not include FwMark in any client configs: it is INVALID. -->
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_telegram_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Telegram Configuration">Telegram Configuration</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_telegram_client" id="frm_telegram_client">
                <div class="modal-body">
                    <input type="hidden" id="tg_client_id" name="tg_client_id">
                    <div class="form-group">
                        <label for="tg_client_userid" class="control-label" data-translate="Telegram userid">Telegram userid</label>
                        <input type="text" class="form-control" id="tg_client_userid" name="tg_client_userid">
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Send">Send</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_edit_client">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Edit Client">Edit Client</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form name="frm_edit_client" id="frm_edit_client">
                <div class="modal-body">
                    <input type="hidden" id="_client_id" name="_client_id">
                    <div class="form-group">
                        <label for="_client_name" class="control-label" data-translate="Name">Name</label>
                        <input type="text" class="form-control" id="_client_name" name="_client_name">
                    </div>
                    <div class="form-group">
                        <label for="_client_email" class="control-label" data-translate="Email">Email</label>
                        <input type="text" class="form-control" id="_client_email" name="client_email">
                    </div>
                    <div class="form-group">
                        <label for="_client_quota" class="control-label" data-translate="Quota">Quota</label>
                        <select class="form-control" id="_quota_preset" onchange="updateQuotaInput()">
                            <option value="" data-translate="Select Quota">Select Quota</option>
                            <option value="10">10 GB</option>
                            <option value="20">20 GB</option>
                            <option value="30">30 GB</option>
                            <option value="40">40 GB</option>
                            <option value="50">50 GB</option>
                            <option value="100">100 GB</option>
                            <option value="200">200 GB</option>
                            <option value="500">500 GB</option>
                            <option value="1000">1 TB</option>
                            <option value="custom" data-translate="Custom">Custom</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="number" class="form-control" id="_client_quota" name="_client_quota" data-translate-placeholder="Enter custom quota in GB" placeholder="Enter custom quota in GB" step="0.1" min="0" />
                    </div>

                    <div class="form-group">
                        <label for="_client_expiration_days" class="control-label" data-translate="Expiration Days">Expiration Days</label>
                        <input type="number" class="form-control" id="_client_expiration_days" name="_client_expiration_days" placeholder="e.g. 30" min="0" />
                    </div>

                    <div class="form-group">
                        <label for="_client_allocated_ips" class="control-label" data-translate="IP Allocation">IP Allocation</label>
                        <input type="text" data-role="tagsinput" class="form-control" id="_client_allocated_ips">
                    </div>
                    <div class="form-group">
                        <label for="_client_endpoint" class="control-label" data-translate="Endpoint">Endpoint</label>
                        <input type="text" class="form-control" id="_client_endpoint" name="client_endpoint">
                    </div>
                    <div class="form-group" style="margin-top: 0.5rem;">
                        <label for="_client_telegram_userid" class="control-label" data-translate="Telegram userid">Telegram userid</label>
                        <input type="text" class="form-control" id="_client_telegram_userid" name="_client_telegram_userid">
                    </div>
                    <div class="form-group">
                        <label for="_additional_notes" class="control-label" data-translate="Notes">Notes</label>
                        <textarea class="form-control" style="min-height: 6rem;" id="_additional_notes" name="_additional_notes" data-translate-placeholder="Additional notes about this client" placeholder="Additional notes about this client"></textarea>
                    </div>
                    <div class="form-group">
                        <div class="icheck-primary d-inline">
                            <input type="checkbox" id="_use_server_dns">
                            <label for="_use_server_dns" data-translate="Use server DNS">
                                Use server DNS
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="icheck-primary d-inline">
                            <input type="checkbox" id="_enabled">
                            <label for="_enabled" data-translate="Enable this client">
                                Enable this client
                            </label>
                        </div>
                    </div>
                    <details>
                        <summary>
                            <strong data-translate="Public and Preshared Keys">Public and Preshared Keys</strong>
                            <i class="fas fa-info-circle" data-toggle="tooltip"
                               data-translate-title="Update the server stored client Public and Preshared keys."
                               data-original-title="Update the server stored client Public and Preshared keys.">
                            </i>
                        </summary>
                        <div class="form-group" style="margin-top: 1rem">
                            <label for="_client_public_key" class="control-label" data-translate="Public Key">
                                Public Key
                            </label>
                            <input type="text" class="form-control" id="_client_public_key" name="_client_public_key" aria-invalid="false">
                        </div>
                        <div class="form-group">
                            <label for="_client_preshared_key" class="control-label" data-translate="Preshared Key">
                                Preshared Key
                            </label>
                            <input type="text" class="form-control" id="_client_preshared_key" name="_client_preshared_key">
                        </div>
                    </details>
                    <details style="margin-top: 0.5rem;">
                        <summary>
                            <strong data-translate="Additional configuration">Additional configuration</strong>
                        </summary>
                        <div class="form-group">
                            <label for="_client_allowed_ips" class="control-label" data-translate="Allowed IPs">Allowed IPs</label>
                            <input type="text" data-role="tagsinput" class="form-control" id="_client_allowed_ips">
                        </div>
                        <div class="form-group">
                            <label for="_client_extra_allowed_ips" class="control-label" data-translate="Extra Allowed IPs">Extra Allowed IPs</label>
                            <input type="text" data-role="tagsinput" class="form-control"
                                   id="_client_extra_allowed_ips">
                        </div>
                        <div class="form-group">
                            <label for="_subnet_ranges" class="control-label" data-translate="Subnet range">Subnet range</label>
                            <select id="_subnet_ranges" class="select2"
                                    data-translate-placeholder="Select a subnet range"
                                    data-placeholder="Select a subnet range" style="width: 100%;">
                            </select>
                        </div>
                    </details>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-success" data-translate="Save">Save</button>
                </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_pause_client">
    <div class="modal-dialog">
        <div class="modal-content bg-warning">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Disable">Disable</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-dark" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                <button type="button" class="btn btn-outline-dark" id="pause_client_confirm" data-translate="Apply">Apply</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<div class="modal fade" id="modal_remove_client">
    <div class="modal-dialog">
        <div class="modal-content bg-danger">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Remove">Remove</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-dark" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                <button type="button" class="btn btn-outline-dark" id="remove_client_confirm" data-translate="Apply">Apply</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->
{{end}}

{{define "bottom_js"}}
    <script>
        function populateClientList() {
            console.log('Fetching clients list...');
            $("#client-list").empty();
            
            const tryFetchClients = (retryCount = 0) => {
                $.ajax({
                    cache: false,
                    method: 'GET',
                    url: '{{.basePath}}/api/clients',
                    dataType: 'json',
                    contentType: "application/json",
                    success: function(response) {
                        console.log('Raw server response:', response);
                        
                        if (!response) {
                            console.log('No response from server');
                            $("#client-list").html('<div class="col-12 text-center"><p>No clients found</p></div>');
                            return;
                        }

                        // اگر پاسخ به صورت رشته JSON باشد، آن را پارس کنیم
                        let data = response;
                        if (typeof response === 'string') {
                            try {
                                data = JSON.parse(response);
                            } catch (e) {
                                console.error('Error parsing JSON response:', e);
                                toastr.error('Error processing server response');
                                return;
                            }
                        }

                        // اگر داده‌ها آرایه باشند، مستقیماً آنها را رندر کنیم
                        if (Array.isArray(data)) {
                            console.log('Rendering array of clients:', data);
                            renderClientList(data);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        // اگر داده‌ها یک آبجکت باشند که شامل آرایه clients است
                        if (data.clients && Array.isArray(data.clients)) {
                            console.log('Rendering clients from data.clients:', data.clients);
                            renderClientList(data.clients);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        // اگر داده‌ها یک آبجکت باشند که شامل آرایه data است
                        if (data.data && Array.isArray(data.data)) {
                            console.log('Rendering clients from data.data:', data.data);
                            renderClientList(data.data);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        // اگر داده‌ها یک کلاینت منفرد باشند
                        if (data.Client || (data.name && data.id)) {
                            console.log('Rendering single client:', data);
                            renderClientList([data]);
                            refreshConnectionStatus(); // Refresh connection status after rendering
                            return;
                        }

                        console.log('No valid client data found in response');
                        $("#client-list").html('<div class="col-12 text-center"><p>No clients found</p></div>');
                    },
                    error: function(jqXHR) {
                        console.error('Error fetching clients:', {
                            status: jqXHR.status,
                            statusText: jqXHR.statusText,
                            responseText: jqXHR.responseText
                        });
                        
                        if (retryCount < 3 && (jqXHR.status === 0 || jqXHR.status === 500)) {
                            setTimeout(() => tryFetchClients(retryCount + 1), 1000 * (retryCount + 1));
                            return;
                        }

                        let errorMessage = 'Failed to fetch clients';
                        if (jqXHR.responseText) {
                            try {
                                const responseJson = JSON.parse(jqXHR.responseText);
                                errorMessage = responseJson.message || errorMessage;
                            } catch (e) {
                                console.error('Error parsing error response:', e);
                            }
                        }
                        
                        toastr.error(errorMessage);
                        $("#client-list").html('<div class="col-12 text-center"><p>Error loading clients</p></div>');
                    }
                });
            };

            tryFetchClients();
        }

        function autoApplyConfig() {
            $("#apply_config_confirm").click();
        }

        let disableInProgress = false;

        function setClientStatus(clientID, status, isAutomatic = false) {
            if (!clientID) {
                console.error('Invalid client ID');
                return;
            }

            if (disableInProgress) {
                console.log('Status change already in progress, skipping');
                return;
            }

            disableInProgress = true;
            const trySetStatus = (retryCount = 0) => {
                $.ajax({
                    cache: false,
                    method: 'POST',
                    url: '{{.basePath}}/api/client/' + clientID + '/status/' + status,
                    dataType: 'json',
                    contentType: "application/json",
                    data: JSON.stringify({ 
                        enabled: status,
                        automatic: isAutomatic 
                    }),
                    success: function(data) {
                        console.log("Set client " + clientID + " status to " + status);
                        toastr.success('Client ' + (status ? 'enabled' : 'disabled') + ' successfully');
                        
                        const divElement = document.getElementById("paused_" + clientID);
                        if (divElement) {
                            divElement.style.visibility = status ? "hidden" : "visible";
                        }

                        if (!status && isAutomatic) {
                            applyWireGuardConfig();
                        }

                        populateClientList();
                        disableInProgress = false;
                    },
                    error: function(jqXHR) {
                        console.error('Error setting client status:', jqXHR.status);
                        if (retryCount < 3 && (jqXHR.status === 500 || jqXHR.status === 0)) {
                            setTimeout(() => trySetStatus(retryCount + 1), 1000 * (retryCount + 1));
                        } else {
                            let errorMessage = 'Error changing client status';
                            try {
                                const responseJson = jQuery.parseJSON(jqXHR.responseText);
                                errorMessage = responseJson.message || errorMessage;
                            } catch (e) {
                                console.error('Error parsing error response:', e);
                            }
                            toastr.error(errorMessage);
                            disableInProgress = false;
                        }
                    }
                });
            };

            trySetStatus();
        }

        function applyWireGuardConfig(retryCount = 0) {
            $.ajax({
                cache: false,
                method: 'POST',
                url: '{{.basePath}}/api/apply-wg-config',
                dataType: 'json',
                contentType: "application/json",
                success: function(data) {
                    toastr.success('Configuration applied successfully');
                    populateClientList();
                },
                error: function(jqXHR) {
                    console.error('Error applying config:', jqXHR.status);
                    if (retryCount < 3 && (jqXHR.status === 500 || jqXHR.status === 0)) {
                        setTimeout(() => applyWireGuardConfig(retryCount + 1), 1000 * (retryCount + 1));
                    } else {
                        let errorMessage = 'Error applying configuration';
                        try {
                            const responseJson = jQuery.parseJSON(jqXHR.responseText);
                            errorMessage = responseJson.message || errorMessage;
                        } catch (e) {
                            console.error('Error parsing error response:', e);
                        }
                        toastr.error(errorMessage);
                    }
                }
            });
        }

        function pauseClient(clientID) {
            setClientStatus(clientID, false);
        }

        function resumeClient(clientID) {
            setClientStatus(clientID, true);
        }

        function updateIPAllocationSuggestion() {
            const selectedSubnet = $('#subnet_ranges').val() || '__default_any__';
            
            // اگر درخواست قبلی هنوز در حال اجراست، از درخواست جدید جلوگیری کن
            if (updateIPAllocationSuggestion.isRunning) {
                console.log('Previous request is still running, skipping...');
                return;
            }

            console.log('Getting IP suggestions for subnet:', selectedSubnet);

            // Clear previous IPs
            $('#client_allocated_ips').importTags('');

            // تنظیم وضعیت درخواست
            updateIPAllocationSuggestion.isRunning = true;

            // Get IP suggestion from API with retry logic
            const tryGetSuggestions = (retryCount = 0) => {
                $.ajax({
                    cache: false,
                    method: 'GET',
                    url: '{{.basePath}}/api/suggest-client-ips',
                    data: { sr: selectedSubnet },
                    dataType: 'json',
                    contentType: "application/json",
                    success: function(response) {
                        console.log('Received IP suggestions:', response);
                        if (response && Array.isArray(response)) {
                            response.forEach(function(ip) {
                                if (ip) {
                                    $('#client_allocated_ips').addTag(ip);
                                }
                            });
                        } else {
                            console.warn('Invalid response format or no IPs available');
                        }
                        // پایان درخواست
                        updateIPAllocationSuggestion.isRunning = false;
                    },
                    error: function(jqXHR) {
                        console.error('Error getting IP suggestions:', jqXHR.status);
                        if (retryCount < 3 && (jqXHR.status === 503 || jqXHR.status === 0)) {
                            setTimeout(() => tryGetSuggestions(retryCount + 1), 1000 * (retryCount + 1));
                        } else {
                            let errorMessage = 'Failed to get IP suggestions';
                            try {
                                const responseJson = jQuery.parseJSON(jqXHR.responseText);
                                errorMessage = responseJson.message || errorMessage;
                            } catch (e) {
                                console.error('Error parsing error response:', e);
                            }
                            toastr.error(errorMessage);
                            // پایان درخواست در صورت خطا
                            updateIPAllocationSuggestion.isRunning = false;
                        }
                    }
                });
            };

            tryGetSuggestions();
        }

        // مقداردهی اولیه وضعیت درخواست
        updateIPAllocationSuggestion.isRunning = false;

        function updateSubnetRangesList(elementID, preselectedVal) {
            $.getJSON("{{.basePath}}/api/subnet-ranges", null, function(data) {
                $(`${elementID} option`).remove();
                $(elementID).append(
                    $("<option></option>")
                        .text("Any")
                        .val("__default_any__")
                );
                $.each(data, function(index, item) {
                    $(elementID).append(
                        $("<option></option>")
                            .text(item)
                            .val(item)
                    );
                    if (item === preselectedVal) {
                        console.log(preselectedVal);
                        $(elementID).val(preselectedVal).trigger('change')
                    }
                });
            });
        }

        function updateSearchList() {
            $.getJSON("{{.basePath}}/api/subnet-ranges", null, function(data) {
                $("#status-selector option").remove();
                $("#status-selector").append(
                    $("<option></option>")
                        .text("All")
                        .val("All"),
                    $("<option></option>")
                        .text("Enabled")
                        .val("Enabled"),
                    $("<option></option>")
                        .text("Disabled")
                        .val("Disabled"),
                    $("<option></option>")
                        .text("Connected")
                        .val("Connected"),
                    $("<option></option>")
                        .text("Disconnected")
                        .val("Disconnected")
                );
                $.each(data, function(index, item) {
                    $("#status-selector").append(
                        $("<option></option>")
                            .text(item)
                            .val(item)
                    );
                });
            });
        }
    </script>
    <script>
        // load client list
        $(document).ready(function () {
            updateSearchList();
            populateClientList();
            
            let autoRefreshInterval;
            
            // Handle auto-refresh toggle
            $("#auto-refresh-toggle").change(function() {
                const isChecked = $(this).prop('checked');
                $("#refresh-interval").prop('disabled', !isChecked);
                
                if (isChecked) {
                    startAutoRefresh();
                } else {
                    stopAutoRefresh();
                }
            });
            
            // Handle refresh interval change
            $("#refresh-interval").change(function() {
                if ($("#auto-refresh-toggle").prop('checked')) {
                    startAutoRefresh();
                }
            });
            
            function startAutoRefresh() {
                // Clear any existing interval
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                }
                
                // Get interval in seconds and convert to milliseconds
                const intervalSeconds = parseInt($("#refresh-interval").val());
                const intervalMs = intervalSeconds * 1000;
                
                // Start new interval
                autoRefreshInterval = setInterval(function() {
                    refreshConnectionStatus();
                }, intervalMs);
            }
            
            function stopAutoRefresh() {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
            
            // Manual refresh button
            $("#refresh-status-btn").click(function() {
                $(this).find('i').addClass('fa-spin');
                refreshConnectionStatus();
                setTimeout(() => {
                    $(this).find('i').removeClass('fa-spin');
                }, 1000);
            });
        })

        // show search bar and override :contains to be case-insensitive
        $(document).ready(function () {
            $("#search-form").show();
            jQuery.expr[':'].contains = function(a, i, m) {
                return jQuery(a).text().toUpperCase()
                    .indexOf(m[3].toUpperCase()) >= 0;
            };
        })

        // hide all clients and display only the ones that meet the search criteria (name, email, IP)
        $('#search-input').keyup(function () {
            $("#status-selector").val("All");
            let query = $(this).val().trim();
            $('.col-lg-4').hide();
            $(".info-box-text").each(function() {
                if($(this).children('i.fa-user').length > 0 || $(this).children('i.fa-envelope').length > 0)
                {
                    $(this).filter(':contains("' + query + '")').parent().parent().parent().show();
                }
                })
            $(".badge-secondary").filter(':contains("' + query + '")').parent().parent().parent().show();
            $(".fa-tguserid").each(function () {
                if ($(this).parent().text().trim().indexOf(query) != -1) {
                    $(this).closest('.col-lg-4').show();
                }
            })
            let upperQuery = query.toUpperCase()
            $(".fa-additional_notes").each(function () {
                if ($(this).parent().text().trim().indexOf(upperQuery) != -1) {
                    $(this).closest('.col-lg-4').show();
                }
            })
        })

        $("#status-selector").on('change', function () {
            $('#search-input').val("");
            switch ($("#status-selector").val()) {
                case "All":
                    $('.col-lg-4').show();
                    break;
                case "Enabled":
                    $('.col-lg-4').hide();
                    $('[id^="paused_"]').each(function () {
                        if ($(this).css("visibility") === "hidden") {
                            $(this).parent().parent().show();
                        }
                    });
                    break;
                case "Disabled":
                    $('.col-lg-4').hide();
                    $('[id^="paused_"]').each(function () {
                        if ($(this).css("visibility") !== "hidden") {
                            $(this).parent().parent().show();
                        }
                    });
                    break;
                case "Connected":
                    $('.col-lg-4').hide();
                    $.ajax({
                        cache: false,
                        method: 'GET',
                        url: '{{.basePath}}/status',
                        success: function (data) {
                            const returnedHTML = $(data).find(".table-success").get();
                            var returnedString = "";
                            returnedHTML.forEach(entry => returnedString += entry.outerHTML);
                            $(".fa-key").each(function () {
                                if (returnedString.indexOf($(this).parent().text().trim()) != -1) {
                                    $(this).closest('.col-lg-4').show();
                                }
                            })
                        }
                    });
                    break;
                case "Disconnected":
                    $('.col-lg-4').show();
                    $.ajax({
                        cache: false,
                        method: 'GET',
                        url: '{{.basePath}}/status',
                        success: function (data) {
                            const returnedHTML = $(data).find(".table-success").get();
                            var returnedString = "";
                            returnedHTML.forEach(entry => returnedString += entry.outerHTML);
                            $(".fa-key").each(function () {
                                if (returnedString.indexOf($(this).parent().text().trim()) != -1) {
                                    $(this).closest('.col-lg-4').hide();
                                }
                            })
                        }
                    });
                    break;
                default:
                    $('.col-lg-4').hide();
                    const selectedSR = $("#status-selector").val()
                    $(".fa-subnetrange").each(function () {
                        const srs = $(this).parent().text().trim().split(',')
                        for (const sr of srs) {
                            if (sr === selectedSR) {
                                $(this).closest('.col-lg-4').show();
                                break
                            }                            
                        }
                    })
                    // $('.col-lg-4').show();
                    break;
            }
        });

        // modal_pause_client modal event
        $("#modal_pause_client").on('show.bs.modal', function (event) {
            const button = $(event.relatedTarget);
            const client_id = button.data('clientid');
            const client_name = button.data('clientname');
            const modal = $(this);
            modal.find('.modal-body').text("You are about to disable client " + client_name);
            modal.find('#pause_client_confirm').val(client_id);
        })

        // pause_client_confirm button event
        $(document).ready(function () {
            $("#pause_client_confirm").click(function () {
                const client_id = $(this).val();
                pauseClient(client_id);
                $("#modal_pause_client").modal('hide');
            });
        });

        // modal_remove_client modal event
        $("#modal_remove_client").on('show.bs.modal', function (event) {
            const button = $(event.relatedTarget);
            const client_id = button.data('clientid');
            const client_name = button.data('clientname');
            const modal = $(this);
            modal.find('.modal-body').text("You are about to remove client " + client_name);
            modal.find('#remove_client_confirm').val(client_id);
        })

        // remove_client_confirm button event
        $(document).ready(function () {
            $("#remove_client_confirm").click(function () {
                const client_id = $(this).val();
                const data = {"id": client_id};
                $.ajax({
                    cache: false,
                    method: 'POST',
                    url: '{{.basePath}}/remove-client',
                    dataType: 'json',
                    contentType: "application/json",
                    data: JSON.stringify(data),
                    success: function(data) {
                        $("#modal_remove_client").modal('hide');
                        toastr.success('Removed client successfully');
                        const divElement = document.getElementById('client_' + client_id);
                        divElement.style.display = "none";
                    },
                    error: function(jqXHR, exception) {
                        const responseJson = jQuery.parseJSON(jqXHR.responseText);
                        toastr.error(responseJson['message']);
                    }
                });
            });
        });



        // Edit client modal event
        // This fills the modal dialogue with data from the DB when we open the edit menu
        $(document).ready(function () {
            $("#modal_edit_client").on('show.bs.modal', function (event) {
                let modal = $(this);
                const button = $(event.relatedTarget);
                const client_id = button.data('clientid');

                // IP Allocation tag input
                modal.find("#_client_allocated_ips").tagsInput({
                    'width': '100%',
                    'height': '75%',
                    'interactive': true,
                    'defaultText': 'Add More',
                    'removeWithBackspace': true,
                    'minChars': 0,
                    'minInputWidth': '100%',
                    'placeholderColor': '#666666'
                });

                // AllowedIPs tag input
                modal.find("#_client_allowed_ips").tagsInput({
                    'width': '100%',
                    'height': '75%',
                    'interactive': true,
                    'defaultText': 'Add More',
                    'removeWithBackspace': true,
                    'minChars': 0,
                    'minInputWidth': '100%',
                    'placeholderColor': '#666666'
                });

                modal.find("#_client_extra_allowed_ips").tagsInput({
                    'width': '100%',
                    'height': '75%',
                    'interactive': true,
                    'defaultText': 'Add More',
                    'removeWithBackspace': true,
                    'minChars': 0,
                    'minInputWidth': '100%',
                    'placeholderColor': '#666666'
                })

                // دریافت اطلاعات کلاینت از سرور
                $.ajax({
                    cache: false,
                    method: 'GET',
                    url: '{{.basePath}}/api/client/' + client_id,
                    dataType: 'json',
                    contentType: "application/json",
                    success: function (resp) {
                        const client = resp.Client;

                        // مقداردهی عنوان مدال
                        modal.find(".modal-title").text("Edit Client " + client.name);

                        // مقداردهی فیلدهای پنهان
                        modal.find("#_client_id").val(client.id);
                        modal.find("#_client_telegram_userid").val(client.telegram_userid);

                        // مقداردهی فیلدهای ساده
                        modal.find("#_client_name").val(client.name);
                        modal.find("#_client_email").val(client.email);
                        modal.find("#_client_endpoint").val(client.endpoint);
                        modal.find("#_client_public_key").val(client.public_key);
                        modal.find("#_client_preshared_key").val(client.preshared_key);
                        modal.find("#_additional_notes").val(client.additional_notes);

                        // مقداردهی Quota
                        modal.find("#_client_quota").val(client.quota ? (client.quota / (1024 * 1024 * 1024)).toFixed(1) : "");     
                        // مقداردهی Expiration (تبدیل تاریخ UTC به فرمت datetime-local)
                        if (client.expiration_days) {
                            modal.find("#_client_expiration_days").val(client.expiration_days);
                        } else {
                            modal.find("#_client_expiration_days").val("");
                        }

                        // مقداردهی Subnet range
                        let preselectedEl;
                        if (client.subnet_ranges && client.subnet_ranges.length > 0) {
                            preselectedEl = client.subnet_ranges[0];
                        }
                        updateSubnetRangesList("#_subnet_ranges", preselectedEl);

                        // مقداردهی Allocated IPs
                        modal.find("#_client_allocated_ips").importTags('');
                        client.allocated_ips.forEach(function (obj) {
                            modal.find("#_client_allocated_ips").addTag(obj);
                        });

                        // مقداردهی Allowed IPs
                        modal.find("#_client_allowed_ips").importTags('');
                        client.allowed_ips.forEach(function (obj) {
                            modal.find("#_client_allowed_ips").addTag(obj);
                        });

                        // مقداردهی Extra Allowed IPs
                        modal.find("#_client_extra_allowed_ips").importTags('');
                        client.extra_allowed_ips.forEach(function (obj) {
                            modal.find("#_client_extra_allowed_ips").addTag(obj);
                        });

                        // مقداردهی Use server DNS و Enable
                        modal.find("#_use_server_dns").prop("checked", client.use_server_dns);
                        modal.find("#_enabled").prop("checked", client.enabled);

                        // اگر subnet range تغییر کرد، IP Allocation جدید پیشنهاد بده
                        $('#_subnet_ranges').on('select2:select', function (e) {
                            updateIPAllocationSuggestion();
                        });
                    },
                    error: function (jqXHR, exception) {
                        const responseJson = jQuery.parseJSON(jqXHR.responseText);
                        toastr.error(responseJson['message']);
                    }
                });
            });
        });

        // regenerateQRCode function for regenerating QR Code adding/removing some parts of configuration because of compatibility issues with some clients
        function regenerateQRCode() {
            const client_id = $("#qr_client_id").val();
            const QRCodeImg = $("#qr_code");
            const QRCodeA = $("#qr_code_a");
            QRCodeImg.hide();
            $.ajax({
                cache: false,
                method: 'GET',
                url: '{{.basePath}}/api/client/' + client_id,
                data: {

                },
                dataType: 'json',
                contentType: "application/json",
                success: function (resp) {
                    const client = resp.Client;

                    $(".modal-title").text("Scan QR Code for " + client.name + " profile");
                    QRCodeImg.attr('src', resp.QRCode).show();
                    QRCodeA.attr('download', resp.Client.name);
                    QRCodeA.attr('href', resp.QRCode).show();
                },
                error: function (jqXHR, exception) {
                    const responseJson = jQuery.parseJSON(jqXHR.responseText);
                    toastr.error(responseJson['message']);
                }
            });
        }

        // submitEmailClient function for sending an email with the configuration to the client
        function submitEmailClient() {
            const client_id = $("#e_client_id").val();
            const email = $("#e_client_email").val();
            const data = {"id": client_id, "email": email};
            $.ajax({
                cache: false,
                method: 'POST',
                url: '{{.basePath}}/email-client',
                dataType: 'json',
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function(resp) {
                    $("#modal_email_client").modal('hide');
                    toastr.success('Sent email to client successfully');
                },
                error: function(jqXHR, exception) {
                    const responseJson = jQuery.parseJSON(jqXHR.responseText);
                    toastr.error(responseJson['message']);
                }
            });
        }

        // submitTelegramClient function for sending a telegram message with the configuration to the client
        function submitTelegramClient() {
            const client_id = $("#tg_client_id").val();
            const userid = $("#tg_client_userid").val();
            const data = {"id": client_id, "userid": userid};
            $.ajax({
                cache: false,
                method: 'POST',
                url: '{{.basePath}}/send-telegram-client',
                dataType: 'json',
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function(resp) {
                    $("#modal_telegram_client").modal('hide');
                    toastr.success('Sent config via telegram to client successfully');
                },
                error: function(jqXHR, exception) {
                    const responseJson = jQuery.parseJSON(jqXHR.responseText);
                    toastr.error(responseJson['message']);
                }
            });
        }

        //  function for updating an existing client
        // This sends dialogue data to the back-end when user presses "Save"
        // See e.g. routes.go:UpdateClient for where data is processed/verified.
        function submitEditClient() {
            const client_id = $("#_client_id").val();
            const name = $("#_client_name").val();
            const email = $("#_client_email").val();
            const telegram_userid = $("#_client_telegram_userid").val();
            const allocated_ips = $("#_client_allocated_ips").val().split(",");
            const allowed_ips = $("#_client_allowed_ips").val().split(",");
            let use_server_dns = false;
            let extra_allowed_ips = [];
            const public_key = $("#_client_public_key").val();
            const preshared_key = $("#_client_preshared_key").val();

            // اضافه کردن Quota
            const quotaGB = parseFloat($("#_client_quota").val()) || 0;
            const quotaBytes = Math.floor(quotaGB * 1024 * 1024 * 1024);

            // اضافه کردن Expiration Days
            let expirationDaysValue = $("#_client_expiration_days").val();
            let expirationDays = parseInt(expirationDaysValue) || 0;

            if ($("#_client_extra_allowed_ips").val() !== "") {
                extra_allowed_ips = $("#_client_extra_allowed_ips").val().split(",");
            }
            const endpoint = $("#_client_endpoint").val();

            if ($("#_use_server_dns").is(':checked')) {
                use_server_dns = true;
            }

            let enabled = false;
            if ($("#_enabled").is(':checked')) {
                enabled = true;
            }

            const additional_notes = $("#_additional_notes").val();

            const data = {
                "id": client_id,
                "name": name,
                "email": email,
                "telegram_userid": telegram_userid,
                "allocated_ips": allocated_ips,
                "allowed_ips": allowed_ips,
                "extra_allowed_ips": extra_allowed_ips,
                "endpoint": endpoint,
                "use_server_dns": use_server_dns,
                "enabled": enabled,
                "public_key": public_key,
                "preshared_key": preshared_key,
                "additional_notes": additional_notes,
                "quota": quotaBytes,
                "expiration_days": expirationDays
            };

            $.ajax({
                cache: false,
                method: 'POST',
                url: '{{.basePath}}/update-client',
                dataType: 'json',
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function(resp) {
                    $("#modal_edit_client").modal('hide');
                    toastr.success('Updated client successfully');
                    populateClientList();
                },
                error: function(jqXHR, exception) {
                    const responseJson = jQuery.parseJSON(jqXHR.responseText);
                    toastr.error(responseJson['message']);
                }
            });
        }

        // submitHandler
        function submitHandler(form) {
            const formId = $(form).attr('id');
            if (formId === "frm_edit_client") {
                submitEditClient();
            } else if (formId === "frm_email_client") {
                submitEmailClient();
            } else if (formId === "frm_telegram_client") {
                submitTelegramClient();
            }
        }

        $("#modal_email_client").on('show.bs.modal', function (event) {
            let modal = $(this);
            const button = $(event.relatedTarget);
            const client_id = button.data('clientid');
            $.ajax({
                cache: false,
                method: 'GET',
                url: '{{.basePath}}/api/client/' + client_id,
                dataType: 'json',
                contentType: "application/json",
                success: function (resp) {
                    const client = resp.Client;

                    modal.find(".modal-title").text("Send config to client " + client.name);
                    modal.find("#e_client_id").val(client.id);
                    modal.find("#e_client_email").val(client.email);
                },
                error: function (jqXHR, exception) {
                    const responseJson = jQuery.parseJSON(jqXHR.responseText);
                    toastr.error(responseJson['message']);
                }
            });
        });

        $("#modal_qr_client").on('show.bs.modal', function (event) {
            let modal = $(this);
            const button = $(event.relatedTarget);
            const client_id = button.data('clientid');

            modal.find("#qr_client_id").val(client_id);
            regenerateQRCode();
        });

        $("#modal_telegram_client").on('show.bs.modal', function (event) {
            let modal = $(this);
            const button = $(event.relatedTarget);
            const client_id = button.data('clientid');
            $.ajax({
                cache: false,
                method: 'GET',
                url: '{{.basePath}}/api/client/' + client_id,
                dataType: 'json',
                contentType: "application/json",
                success: function (resp) {
                    const client = resp.Client;

                    modal.find(".modal-title").text("Send config to client " + client.name);
                    modal.find("#tg_client_id").val(client.id);
                    modal.find("#tg_client_userid").val(client.telegram_userid);
                },
                error: function (jqXHR, exception) {
                    const responseJson = jQuery.parseJSON(jqXHR.responseText);
                    toastr.error(responseJson['message']);
                }
            });
        });

        $(document).ready(function () {
            $.validator.setDefaults({
                submitHandler: function (form) {
                    submitHandler(form);
                }
            });
            // Edit client form validation
            $("#frm_edit_client").validate({
                rules: {
                    client_name: {
                        required: true,
                    },
                },
                messages: {
                    client_name: {
                        required: "Please enter a name"
                    },
                },
                errorElement: 'span',
                errorPlacement: function (error, element) {
                    error.addClass('invalid-feedback');
                    element.closest('.form-group').append(error);
                },
                highlight: function (element, errorClass, validClass) {
                    $(element).addClass('is-invalid');
                },
                unhighlight: function (element, errorClass, validClass) {
                    $(element).removeClass('is-invalid');
                }
            });
            // Email client form validation
            $("#frm_email_client").validate({
                rules: {
                    e_client_email: {
                        required: true,
                        email: true,
                    },
                },
                messages: {
                    e_client_email: {
                        required: "Please enter an email"
                    },
                },
                errorElement: 'span',
                errorPlacement: function (error, element) {
                    error.addClass('invalid-feedback');
                    element.closest('.form-group').append(error);
                },
                highlight: function (element, errorClass, validClass) {
                    $(element).addClass('is-invalid');
                },
                unhighlight: function (element, errorClass, validClass) {
                    $(element).removeClass('is-invalid');
                }
            });
            // Telegram client form validation
            $("#frm_telegram_client").validate({
                rules: {
                    tg_client_userid: {
                        required: true,
                        number: true,
                    },
                },
                messages: {
                    tg_client_userid: {
                        required: "Please enter a telegram userid",
                        number: "Please enter a valid telegram userid"
                    },
                },
                errorElement: 'span',
                errorPlacement: function (error, element) {
                    error.addClass('invalid-feedback');
                    element.closest('.form-group').append(error);
                },
                highlight: function (element, errorClass, validClass) {
                    $(element).addClass('is-invalid');
                },
                unhighlight: function (element, errorClass, validClass) {
                    $(element).removeClass('is-invalid');
                }
            });
            // 
        });
    </script>
    <script>
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';

            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];

            const i = Math.floor(Math.log(bytes) / Math.log(k));

            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function renderClientList(clients) {
            console.log('Rendering clients:', clients);
            const clientList = $("#client-list");
            clientList.empty();

            if (!clients || !Array.isArray(clients) || clients.length === 0) {
                clientList.html('<div class="col-12 text-center"><p>No clients found</p></div>');
                return;
            }

            // Fetch connection status data first
            $.ajax({
                cache: false,
                method: 'GET',
                url: '{{.basePath}}/api/status-data',
                dataType: 'json',
                contentType: "application/json",
                success: function(statusData) {
                    // Create a map of public key to connection status
                    const connectionMap = {};
                    if (statusData && statusData.devices) {
                        statusData.devices.forEach(device => {
                            if (device.peers) {
                                device.peers.forEach(peer => {
                                    connectionMap[peer.publicKey] = {
                                        connected: peer.lastHandshakeTime ? 
                                            (new Date() - new Date(peer.lastHandshakeTime)) < 180000 : false, // Consider connected if handshake within last 3 minutes
                                            lastHandshake: peer.lastHandshakeTime,
                                            receivedBytes: peer.receivedBytes,
                                            transmitBytes: peer.transmitBytes
                                    };
                                });
                            }
                        });
                    }
                    
                    // Now render clients with status info
                    renderClientsWithStatus(clients, connectionMap);
                },
                error: function() {
                    // If status fetch fails, render without status data
                    renderClientsWithStatus(clients, {});
                }
            });
        }

        function renderClientsWithStatus(clients, connectionMap) {
            const clientList = $("#client-list");
            
            clients.forEach(function(data) {
                try {
                    let client = data;
                    
                    // Handle different data structures
                    if (data.Client) {
                        client = data.Client;
                    }

                    const connectionStatus = connectionMap[client.public_key] || {};
                    const isConnected = connectionStatus.connected || false;
                    const lastHandshake = connectionStatus.lastHandshake ? new Date(connectionStatus.lastHandshake) : null;
                    const lastHandshakeText = lastHandshake ? 
                        `Last seen: ${formatTimeAgo(lastHandshake)}` : 
                        'Never connected';

                    // Client status class
                    let statusClass = isConnected ? 'client-status enabled' : 'client-status disabled';
                    let statusText = isConnected ? 'Connected' : 'Disconnected';
                    
                    let html = `
                        <div class="col-sm-6 col-md-6 col-lg-4" id="client_${client.id}">
                            <div class="client-box" data-public-key="${client.public_key}">
                                <div class="overlay" id="paused_${client.id}"${client.enabled ? ' style="visibility: hidden;"' : ''}>
                                    <i class="paused-client fas fa-3x fa-play" onclick="resumeClient('${client.id}')"></i>
                                </div>
                                <div class="client-actions">
                                    <a href="download?clientid=${client.id}" class="btn btn-outline-primary">DOWNLOAD</a>
                                    <button type="button" class="btn btn-outline-primary" data-toggle="modal"
                                        data-target="#modal_qr_client" data-clientid="${client.id}"
                                        data-clientname="${client.name}" ${data.QRCode ? '' : ' disabled'}>QR CODE</button>
                                    <button type="button" class="btn btn-outline-primary" data-toggle="modal"
                                        data-target="#modal_email_client" data-clientid="${client.id}"
                                        data-clientname="${client.name}">EMAIL</button>`;
                
                    // Add Telegram button if applicable
                    if (client.telegram_userid) {
                        html += `
                                <button type="button" class="btn btn-outline-primary" data-toggle="modal"
                                    data-target="#modal_telegram_client" data-clientid="${client.id}"
                                    data-clientname="${client.name}">TELEGRAM</button>`;
                    }
                    
                    html += `
                                <div class="btn-group">
                                    <button type="button" class="btn btn-more">MORE</button>
                                    <button type="button" class="btn btn-more dropdown-toggle dropdown-icon" 
                                        data-toggle="dropdown">
                                    </button>
                                    <div class="dropdown-menu" role="menu">
                                        <a class="dropdown-item" href="#" data-toggle="modal"
                                        data-target="#modal_edit_client" data-clientid="${client.id}"
                                        data-clientname="${client.name}">Edit</a>
                                        <a class="dropdown-item" href="#" data-toggle="modal"
                                        data-target="#modal_pause_client" data-clientid="${client.id}"
                                        data-clientname="${client.name}">Disable</a>
                                        <a class="dropdown-item" href="#" data-toggle="modal"
                                        data-target="#modal_remove_client" data-clientid="${client.id}"
                                        data-clientname="${client.name}">Delete</a>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="client-info">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="m-0">${client.name}</h5>
                                    <div class="${statusClass}">${statusText}</div>
                                </div>`;
                
                    if (client.email) {
                        html += `<div class="mb-1"><i class="fas fa-envelope"></i> ${client.email}</div>`;
                    }

                    html += `<div class="connection-details mb-2">
                                <div class="last-handshake"><i class="fas fa-clock"></i> ${lastHandshakeText}</div>`;
                
                    // Show bandwidth details if connected previously
                    if (connectionStatus.received || connectionStatus.transmitted) {
                        html += `
                                    <div class="bandwidth-info">
                                        <i class="fas fa-download"></i> ${formatBytes(connectionStatus.received || 0)}
                                        <i class="fas fa-upload ml-2"></i> ${formatBytes(connectionStatus.transmitted || 0)}
                                    </div>`;
                    }
                    
                    html += `</div>`;

                    // Show creation and update time
                    html += `<div class="client-dates">`;
                    if (client.created_at) {
                        html += `<div><i class="fas fa-calendar-plus"></i> Created: ${formatDate(new Date(client.created_at))}</div>`;
                    }
                    if (client.updated_at) {
                        html += `<div><i class="fas fa-history"></i> Updated: ${formatDate(new Date(client.updated_at))}</div>`;
                    }
                    html += `</div>`;
                    
                    // Show quota if set
                    if (client.quota && client.quota > 0) {
                        const usedQuota = client.used_quota || 0;
                        const quotaPercentage = Math.min(100, Math.round((usedQuota / client.quota) * 100));
                        const remainingBytes = Math.max(0, client.quota - usedQuota);
                        
                        html += `
                                    <div class="client-quota mt-2">
                                        <div class="d-flex justify-content-between">
                                            <span><i class="fas fa-database"></i> Quota: ${formatBytes(usedQuota)} / ${formatBytes(client.quota)}</span>
                                            <span>${quotaPercentage}%</span>
                                        </div>
                                        <div class="progress progress-sm">
                                            <div class="progress-bar ${quotaPercentage > 80 ? 'bg-danger' : 'bg-primary'}" style="width: ${quotaPercentage}%"></div>
                                        </div>
                                        <small class="text-muted">Remaining: ${formatBytes(remainingBytes)}</small>
                                    </div>`;
                    } else {
                        html += `<div class="mt-2"><i class="fas fa-database"></i> <span class="text-success">Unlimited</span></div>`;
                    }
                    
                    // Show expiration if set
                    if (client.expiration && client.expiration !== "0001-01-01T00:00:00Z") {
                        const expirationDate = new Date(client.expiration);
                        const now = new Date();
                        const isExpired = expirationDate < now;
                        
                        // Calculate days remaining
                        const daysRemaining = Math.ceil((expirationDate - now) / (1000 * 60 * 60 * 24));
                        const expiryText = daysRemaining > 0 ? 
                            `Expires: ${formatDate(expirationDate)} (${daysRemaining} days left)` : 
                            `Expired: ${formatDate(expirationDate)}`;
                        
                        html += `
                                    <div class="client-expiry mt-2">
                                        <i class="fas fa-calendar-alt"></i> 
                                        <span class="${isExpired ? 'text-danger' : ''}">
                                            ${expiryText}
                                        </span>
                                    </div>`;
                    } else {
                        html += `<div class="mt-2"><i class="fas fa-calendar-alt"></i> <span class="text-success">Never expires</span></div>`;
                    }
                    
                    // Show DNS setting
                    html += `<div class="mt-2"><i class="fas fa-server" style="opacity: ${client.use_server_dns ? '1.0' : '0.5'}"></i> DNS ${client.use_server_dns ? 'enabled' : 'disabled'}</div>`;
                    
                    // Additional notes
                    if (client.additional_notes) {
                        html += `
                                    <div class="mt-2">
                                        <i class="fas fa-sticky-note"></i> ${client.additional_notes}
                                    </div>`;
                    }
                    
                    // IP allocation 
                    if (client.allocated_ips && Array.isArray(client.allocated_ips) && client.allocated_ips.length > 0) {
                        html += `<div class="mt-3"><strong>IP Allocation</strong></div>`;
                        client.allocated_ips.forEach(function(ip) {
                            if (ip) {
                                html += `<span class="ip-allocation">${ip}</span>`;
                            }
                        });
                    }
                    
                    html += `
                                </div>
                            </div>
                        </div>`;
                    
                    clientList.append(html);
                } catch (error) {
                    console.error('Error rendering client:', error, data);
                }
            });
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.round(diffMs / 1000);
            const diffMin = Math.round(diffSec / 60);
            const diffHour = Math.round(diffMin / 60);
            const diffDay = Math.round(diffHour / 24);
            
            if (diffSec < 60) {
                return diffSec + ' seconds ago';
            } else if (diffMin < 60) {
                return diffMin + ' minutes ago';
            } else if (diffHour < 24) {
                return diffHour + ' hours ago';
            } else {
                return diffDay + ' days ago';
            }
        }

        function formatDate(date) {
            return date.toLocaleDateString() + ' ' + 
                   date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
    </script>
    <script>
        function updateQuotaInput() {
            const preset = $("#_quota_preset").val();
            const quotaInput = $("#_client_quota");
            
            if (preset === "custom") {
                quotaInput.prop("disabled", false);
                quotaInput.val("");
            } else if (preset) {
                quotaInput.prop("disabled", true);
                quotaInput.val(preset);
            } else {
                quotaInput.prop("disabled", false);
                quotaInput.val("");
            }
        }

        $(document).ready(function() {
            updateQuotaInput();
        });
    </script>
    <script>
        // New Client modal event
        $(document).ready(function () {
            let newClientModal = $("#modal_new_client");
            
            // تنظیم IP Allocation tag input برای مدال جدید
            $("#client_allocated_ips").tagsInput({
                'width': '100%',
                'height': '75%',
                'interactive': true,
                'defaultText': 'Add More',
                'removeWithBackspace': true,
                'minChars': 0,
                'minInputWidth': '100%',
                'placeholderColor': '#666666'
            });

            // تنظیم Extra Allowed IPs tag input برای مدال جدید
            $("#client_extra_allowed_ips").tagsInput({
                'width': '100%',
                'height': '75%',
                'interactive': true,
                'defaultText': 'Add More',
                'removeWithBackspace': true,
                'minChars': 0,
                'minInputWidth': '100%',
                'placeholderColor': '#666666'
            });
            
            newClientModal.on('shown.bs.modal', function (e) {
                $("#client_name").val("");
                $("#client_email").val("");
                $("#client_public_key").val("");
                $("#client_preshared_key").val("");
                $("#client_allocated_ips").importTags('');
                $("#client_extra_allowed_ips").importTags('');
                $("#client_endpoint").val('');
                $("#client_telegram_userid").val('');
                $("#additional_notes").val('');
                $("#client_quota").val("");
                $("#client_expiration_days").val("");
                
                // تنظیم مقادیر پیش‌فرض
                $("#use_server_dns").prop("checked", true);
                $("#enabled").prop("checked", true);
                
                // اول subnet ranges رو بگیریم
                $.getJSON("{{.basePath}}/api/subnet-ranges", null, function(data) {
                    $("#subnet_ranges option").remove();
                    $("#subnet_ranges").append(
                        $("<option></option>")
                            .text("Any")
                            .val("__default_any__")
                    );
                    $.each(data, function(index, item) {
                        $("#subnet_ranges").append(
                            $("<option></option>")
                                .text(item)
                                .val(item)
                        );
                    });
                    // مقدار پیش‌فرض رو تنظیم می‌کنیم
                    $("#subnet_ranges").val("__default_any__");
                    // فقط یک بار updateIPAllocationSuggestion رو صدا میزنیم
                    updateIPAllocationSuggestion();
                });
            });

            // فقط وقتی subnet range تغییر میکنه، IP پیشنهادی جدید بگیریم
            $("#subnet_ranges").on('change', function(e) {
                // فقط اگر تغییر توسط کاربر بود، IP جدید بگیریم
                if (e.originalEvent) {
                    updateIPAllocationSuggestion();
                }
            });

            // Form validation and submission
            $("#frm_new_client").validate({
                rules: {
                    client_name: {
                        required: true
                    }
                },
                messages: {
                    client_name: {
                        required: "Please enter a name"
                    }
                },
                errorElement: 'span',
                errorPlacement: function (error, element) {
                    error.addClass('invalid-feedback');
                    element.closest('.form-group').append(error);
                },
                highlight: function (element, errorClass, validClass) {
                    $(element).addClass('is-invalid');
                },
                unhighlight: function (element, errorClass, validClass) {
                    $(element).removeClass('is-invalid');
                },
                submitHandler: function(form, event) {
                    event.preventDefault();
                    
                    const name = $("#client_name").val();
                    const quotaGB = parseFloat($("#client_quota").val()) || 0;
                    const quotaBytes = quotaGB > 0 ? Math.floor(quotaGB * 1024 * 1024 * 1024) : 0;

                    let expirationDaysValue = $("#client_expiration_days").val();
                    let expirationDays = parseInt(expirationDaysValue) || 0;

                    const formData = {
                        name: name,
                        email: $("#client_email").val() || "",
                        public_key: $("#client_public_key").val() || "",
                        preshared_key: $("#client_preshared_key").val() || "",
                        allocated_ips: $("#client_allocated_ips").val() ? $("#client_allocated_ips").val().split(",").filter(Boolean) : [],
                        allowed_ips: ["0.0.0.0/0", "::/0"],
                        extra_allowed_ips: $("#client_extra_allowed_ips").val() ? $("#client_extra_allowed_ips").val().split(",").filter(Boolean) : [],
                        endpoint: $("#client_endpoint").val() || "",
                        telegram_userid: $("#client_telegram_userid").val() || "",
                        additional_notes: $("#additional_notes").val() || "",
                        use_server_dns: $("#use_server_dns").is(":checked"),
                        enabled: true,
                        quota: quotaBytes,
                        expiration_days: expirationDays,
                        subnet_ranges: ["__default_any__"]
                    };

                    const tryCreateClient = (retryCount = 0) => {
                        $.ajax({
                            cache: false,
                            method: 'POST',
                            url: '{{.basePath}}/new-client',
                            dataType: 'json',
                            contentType: "application/json",
                            data: JSON.stringify(formData),
                            success: function(response) {
                                newClientModal.modal('hide');
                                toastr.success('Created client successfully');
                                populateClientList();
                            },
                            error: function(jqXHR) {
                                console.error('Error creating client:', jqXHR.status);
                                if (retryCount < 3 && (jqXHR.status === 500 || jqXHR.status === 0)) {
                                    setTimeout(() => tryCreateClient(retryCount + 1), 1000 * (retryCount + 1));
                                } else {
                                    let errorMessage = 'Error creating client';
                                    try {
                                        const responseJson = jQuery.parseJSON(jqXHR.responseText);
                                        errorMessage = responseJson.message || errorMessage;
                                    } catch (e) {
                                        console.error('Error parsing error response:', e);
                                    }
                                    toastr.error(errorMessage);
                                }
                            }
                        });
                    };

                    tryCreateClient();
                }
            });
        });
    </script>
    <script>
        // Function to refresh only connection status without reloading all clients
        function refreshConnectionStatus() {
            console.log('Refreshing connection status...');
            $.ajax({
                cache: false,
                method: 'GET',
                url: '{{.basePath}}/api/status-data',
                dataType: 'json',
                contentType: "application/json",
                success: function(statusData) {
                    console.log('Status data received:', statusData); // Debug log
                    if (statusData && statusData.devices) {
                        updateClientConnectionStatus(statusData.devices);
                    } else {
                        console.error('Invalid status data format:', statusData);
                    }
                },
                error: function(jqXHR) {
                    console.error('Error refreshing connection status:', jqXHR.status);
                }
            });
        }

        // Update only connection status elements without redrawing the entire client list
        function updateClientConnectionStatus(devices) {
            console.log('Updating client connection status with devices:', devices); // Debug log
            const connectionMap = {};
            
            if (!devices || !Array.isArray(devices)) {
                console.error('Invalid devices data received:', devices);
                toastr.error('Error: Invalid status data received from server');
                return;
            }
            
            devices.forEach(device => {
                if (!device.Peers) {
                    console.warn('Device has no peers:', device);
                    return;
                }
                
                device.Peers.forEach(peer => {
                    if (!peer.PublicKey) {
                        console.warn('Peer missing public key:', peer);
                        return;
                    }
                    
                    // Store connection info by public key
                    connectionMap[peer.PublicKey] = {
                        connected: peer.LastHandshakeTime ? 
                            (new Date() - new Date(peer.LastHandshakeTime)) < 180000 : false, // Consider connected if handshake within last 3 minutes
                        lastHandshake: peer.LastHandshakeTime,
                        receivedBytes: peer.ReceivedBytes,
                        transmitBytes: peer.TransmitBytes
                    };
                    console.log('Peer status:', peer.PublicKey, connectionMap[peer.PublicKey]); // Debug log
                });
            });
            
            let updatedCount = 0;
            // Update status for each client card
            $("[data-public-key]").each(function() {
                const cardElement = $(this);
                const publicKey = cardElement.data("public-key");
                console.log('Checking client:', publicKey); // Debug log
                
                if (!publicKey) {
                    console.warn('Client card missing public key attribute');
                    return;
                }
                
                if (connectionMap[publicKey]) {
                    const connectionInfo = connectionMap[publicKey];
                    const statusElement = cardElement.find(".client-status");
                    const connectionDetailsElement = cardElement.find(".connection-details");
                    
                    if (!statusElement.length || !connectionDetailsElement.length) {
                        console.warn('Missing required elements for client:', publicKey);
                        return;
                    }
                    
                    // Update connection status
                    if (connectionInfo.connected) {
                        statusElement.removeClass("disabled").addClass("enabled");
                        statusElement.text("Connected");
                    } else {
                        statusElement.removeClass("enabled").addClass("disabled");
                        statusElement.text("Disconnected");
                    }
                    
                    // Update last handshake text
                    if (connectionInfo.lastHandshake) {
                        const lastHandshake = new Date(connectionInfo.lastHandshake);
                        const lastHandshakeText = `Last seen: ${formatTimeAgo(lastHandshake)}`;
                        connectionDetailsElement.find(".last-handshake").html(`<i class="fas fa-clock"></i> ${lastHandshakeText}`);
                        
                        // Update bandwidth info
                        let bandwidthHtml = '';
                        if (connectionInfo.receivedBytes || connectionInfo.transmitBytes) {
                            bandwidthHtml = `
                                <div class="bandwidth-info">
                                    <i class="fas fa-download"></i> ${formatBytes(connectionInfo.receivedBytes || 0)}
                                    <i class="fas fa-upload ml-2"></i> ${formatBytes(connectionInfo.transmitBytes || 0)}
                                </div>`;
                        }
                        
                        // Update or add bandwidth info
                        const bandwidthElement = connectionDetailsElement.find(".bandwidth-info");
                        if (bandwidthElement.length) {
                            bandwidthElement.replaceWith(bandwidthHtml);
                        } else if (bandwidthHtml) {
                            connectionDetailsElement.append(bandwidthHtml);
                        }
                    }
                    updatedCount++;
                } else {
                    console.log('No connection info for client:', publicKey); // Debug log
                }
            });
            
            console.log(`Updated ${updatedCount} clients`);
            if (updatedCount === 0) {
                console.warn('No clients were updated');
                toastr.warning('No client status information available');
            }
        }
    </script>
{{end}}