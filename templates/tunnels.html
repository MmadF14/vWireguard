{{define "title"}}
Tunnels
{{end}}

{{define "top_css"}}
{{end}}

{{define "page_title"}}
Tunnels
{{end}}

{{define "page_content"}}
<section class="content">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Tunnels</h1>
                <p class="text-muted">Manage network tunnels and routing</p>
            </div>
            <div class="col-sm-6">
                <div class="float-right">
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#modal_new_tunnel">
                        <i class="fas fa-plus"></i> New Tunnel
                    </button>
                    <button type="button" class="btn btn-warning ml-2" data-toggle="modal" data-target="#modal_cleanup_tunnels">
                        <i class="fas fa-broom"></i> Cleanup
                    </button>
                </div>
            </div>
        </div>

        <div class="row" id="tunnel-list">
            {{if .tunnels}}
                {{range .tunnels}}
                <div class="col-lg-4 col-md-6 mb-3">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">{{.Name}}</h5>
                            <span class="badge badge-{{if eq .Status "active"}}success{{else}}secondary{{end}}">{{.Status}}</span>
                        </div>
                        <div class="card-body">
                            <p class="card-text">
                                <strong>Type:</strong> {{.Type}}<br>
                                {{if eq .Type "wg-to-wg"}}
                                    {{if .WGConfig}}
                                        <strong>Remote:</strong> {{.WGConfig.RemoteEndpoint}}<br>
                                        <strong>Tunnel IP:</strong> {{.WGConfig.TunnelIP}}
                                    {{end}}
                                {{else if eq .Type "wg-to-dokodemo"}}
                                    {{if .DokodemoConfig}}
                                        <strong>Target:</strong> {{.DokodemoConfig.Address}}:{{.DokodemoConfig.Port}}<br>
                                        <strong>Protocol:</strong> {{.DokodemoConfig.Network}}
                                    {{end}}
                                {{else if eq .Type "port-forward"}}
                                    {{if .PortForwardConfig}}
                                        <strong>Protocol:</strong> {{.PortForwardConfig.Protocol}}<br>
                                        <strong>Target:</strong> {{.PortForwardConfig.RemoteHost}}:{{.PortForwardConfig.RemotePort}}
                                    {{end}}
                                {{end}}
                                <strong>Clients:</strong> 
                                {{if .RouteAll}}All Clients{{else}}{{len .ClientIDs}} Selected{{end}}
                            </p>
                            {{if .Description}}
                            <p class="text-muted">{{.Description}}</p>
                            {{end}}
                            
                            <!-- Traffic Stats -->
                            <div class="row mt-2">
                                <div class="col-6">
                                    <small class="text-muted">
                                        <i class="fas fa-download"></i> In: 
                                        <span class="text-success">{{.BytesIn}} bytes</span>
                                    </small>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">
                                        <i class="fas fa-upload"></i> Out: 
                                        <span class="text-primary">{{.BytesOut}} bytes</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            {{if eq .Status "active"}}
                            <button class="btn btn-sm btn-warning mr-2" onclick="stopTunnel('{{.ID}}')">
                                <i class="fas fa-stop"></i> Stop
                            </button>
                            {{else}}
                            <button class="btn btn-sm btn-success mr-2" onclick="startTunnel('{{.ID}}')">
                                <i class="fas fa-play"></i> Start
                            </button>
                            {{end}}
                            <button class="btn btn-sm btn-secondary mr-2" onclick="editTunnel('{{.ID}}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTunnel('{{.ID}}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
                {{end}}
            {{else}}
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        No tunnels configured. Add a new tunnel to get started.
                    </div>
                </div>
            {{end}}
        </div>
    </div>
</section>

<!-- New Tunnel Modal -->
<div class="modal fade" id="modal_new_tunnel">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">New Tunnel</h4>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="frm_new_tunnel">
                <div class="modal-body">
                    <!-- Basic Information -->
                    <div class="form-group">
                        <label for="tunnel_name">Tunnel Name</label>
                        <input type="text" class="form-control" id="tunnel_name" name="name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="tunnel_type">Tunnel Type</label>
                        <select class="form-control" id="tunnel_type" name="type" required onchange="showTunnelConfig()">
                            <option value="">Select tunnel type</option>
                            <option value="wg-to-wg">WireGuard to WireGuard</option>
                            <option value="wg-to-dokodemo">Dokodemo Door (Transparent Proxy)</option>
                            <option value="port-forward">Port Forward (Dokodemo Door)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="description">Description (Optional)</label>
                        <textarea class="form-control" id="description" name="description" rows="2"></textarea>
                    </div>

                    <!-- Client Selection -->
                    <div class="form-group">
                        <label>Client Routing</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="client_routing" id="route_all" value="all" checked>
                            <label class="form-check-label" for="route_all">
                                Route all clients through this tunnel
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="client_routing" id="route_selected" value="selected">
                            <label class="form-check-label" for="route_selected">
                                Route only selected clients
                            </label>
                        </div>
                    </div>

                    <div class="form-group" id="client_selection" style="display:none;">
                        <label>Select Clients</label>
                        <div id="client_list">
                            <!-- Will be populated via AJAX -->
                        </div>
                    </div>

                    <!-- WireGuard Configuration -->
                    <div id="wg_config" style="display:none;">
                        <h5>WireGuard Configuration</h5>
                        
                        <!-- Key Generation Section -->
                        <div class="form-group">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-info btn-sm" onclick="generateWireGuardKeys()">
                                    <i class="fas fa-key"></i> Generate Keypair
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="showManualKeyEntry()">
                                    <i class="fas fa-edit"></i> Manual Entry
                                </button>
                            </div>
                            <small class="form-text text-muted">Generate or manually enter your keypair</small>
                        </div>
                        
                        <!-- Manual Key Entry -->
                        <div id="manual_key_section" style="display:none;">
                            <div class="form-group">
                                <label for="wg_manual_private_key">Local Private Key</label>
                                <textarea class="form-control" id="wg_manual_private_key" rows="2" placeholder="Enter your WireGuard private key" onblur="generatePublicKeyFromPrivate()"></textarea>
                                <small class="form-text text-muted">Enter your private key and public key will be auto-generated</small>
                            </div>
                            <div class="form-group">
                                <label for="wg_manual_public_key">Local Public Key (Auto-generated)</label>
                                <input type="text" class="form-control" id="wg_manual_public_key" readonly placeholder="Will be generated from private key">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="wg_remote_endpoint">Remote Endpoint (IP:Port)</label>
                                    <input type="text" class="form-control" id="wg_remote_endpoint" placeholder="1.2.3.4:51820">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="wg_tunnel_ip">Our Tunnel IP</label>
                                    <input type="text" class="form-control" id="wg_tunnel_ip" placeholder="10.0.1.2/24">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="wg_remote_public_key">Remote Public Key</label>
                            <textarea class="form-control" id="wg_remote_public_key" rows="2" placeholder="Remote WireGuard server's public key"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="wg_allowed_ips">Allowed IPs (comma separated)</label>
                            <input type="text" class="form-control" id="wg_allowed_ips" value="0.0.0.0/0" placeholder="0.0.0.0/0, ::/0">
                        </div>
                        
                        <!-- PreShared Key (Optional) -->
                        <div class="form-group">
                            <label for="wg_preshared_key">PreShared Key (Optional)</label>
                            <div class="input-group">
                                <textarea class="form-control" id="wg_preshared_key" rows="2" placeholder="Leave empty or enter PreShared Key for extra security"></textarea>
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-outline-secondary" onclick="generatePreSharedKey()">
                                        <i class="fas fa-key"></i> Generate
                                    </button>
                                </div>
                            </div>
                            <small class="form-text text-muted">Optional: Adds an extra layer of symmetric-key cryptography</small>
                        </div>
                    </div>

                    <!-- Dokodemo Door Configuration -->
                    <div id="dokodemo_config" style="display:none;">
                        <h5>Dokodemo Door Configuration</h5>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label for="dokodemo_address">Target Address</label>
                                    <input type="text" class="form-control" id="dokodemo_address" placeholder="example.com or 1.2.3.4">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="dokodemo_port">Target Port</label>
                                    <input type="number" class="form-control" id="dokodemo_port" placeholder="80">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="dokodemo_network">Network Protocol</label>
                                    <select class="form-control" id="dokodemo_network">
                                        <option value="tcp">TCP</option>
                                        <option value="udp">UDP</option>
                                        <option value="tcp,udp">TCP + UDP</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="dokodemo_timeout">Timeout (seconds)</label>
                                    <input type="number" class="form-control" id="dokodemo_timeout" value="300" placeholder="300">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="dokodemo_domain_strategy">Domain Strategy</label>
                            <select class="form-control" id="dokodemo_domain_strategy">
                                <option value="AsIs">As Is (default)</option>
                                <option value="UseIP">Use IP</option>
                                <option value="UseIPv4">Use IPv4</option>
                                <option value="UseIPv6">Use IPv6</option>
                            </select>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dokodemo_follow_redirect">
                            <label class="form-check-label" for="dokodemo_follow_redirect">
                                Follow HTTP Redirects  
                            </label>
                        </div>
                    </div>

                    <!-- Port Forward Configuration -->
                    <div id="port_forward_config" style="display:none;">
                        <h5>Port Forward Configuration (Dokodemo Door)</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="pf_protocol">Protocol</label>
                                    <select class="form-control" id="pf_protocol">
                                        <option value="tcp">TCP</option>
                                        <option value="udp">UDP</option>
                                        <option value="both">Both (TCP + UDP)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="pf_local_port">Local Bind Port</label>
                                    <input type="number" class="form-control" id="pf_local_port" placeholder="8080">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label for="pf_remote_host">Target Host</label>
                                    <input type="text" class="form-control" id="pf_remote_host" placeholder="google.com">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="pf_remote_port">Target Port</label>
                                    <input type="number" class="form-control" id="pf_remote_port" placeholder="80">
                                </div>
                            </div>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="pf_transparent">
                            <label class="form-check-label" for="pf_transparent">
                                Transparent Proxy Mode
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Tunnel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Cleanup Modal -->
<div class="modal fade" id="modal_cleanup_tunnels" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Cleanup Corrupted Tunnels</h4>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>This will remove any corrupted tunnel records that cannot be loaded properly.</p>
                <p><strong>Warning:</strong> This action cannot be undone!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="cleanupTunnels()">Smart Cleanup</button>
                <button type="button" class="btn btn-danger" onclick="deleteAllTunnels()">Delete All</button>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "bottom_js"}}
<script>
$(document).ready(function() {
    // Load client list on modal open
    $('#modal_new_tunnel').on('shown.bs.modal', function() {
        loadClientList();
    });

    // Handle client routing selection
    $('input[name="client_routing"]').change(function() {
        if ($(this).val() === 'selected') {
            $('#client_selection').show();
        } else {
            $('#client_selection').hide();
        }
    });

    // Handle tunnel form submission (create/edit)
    $('#frm_new_tunnel').on('submit', function(e) {
        e.preventDefault();
        
        console.log('Form submitted!');
        
        const tunnelId = $('#modal_new_tunnel').data('tunnel-id');
        const isEdit = !!tunnelId;
        
        const tunnelType = $('#tunnel_type').val();
        const formData = {
            name: $('#tunnel_name').val(),
            type: tunnelType,
            description: $('#description').val(),
            route_all: $('input[name="client_routing"]:checked').val() === 'all',
            client_ids: []
        };

        console.log('Form data before validation:', formData);

        // Validate required fields
        if (!formData.name) {
            alert('Please enter tunnel name');
            return;
        }
        if (!formData.type) {
            alert('Please select tunnel type');
            return;
        }

        // Get selected clients if not routing all
        if (!formData.route_all) {
            $('input[name="client_ids"]:checked').each(function() {
                formData.client_ids.push($(this).val());
            });
        }

        // Add type-specific configuration
        if (tunnelType === 'wg-to-wg') {
            if (!$('#wg_remote_endpoint').val() || !$('#wg_remote_public_key').val()) {
                alert('Please fill all WireGuard configuration fields');
                return;
            }
            
            // Get keys from either generated or manual entry
            let localPrivateKey = $('#wg_config').data('private-key') || $('#wg_manual_private_key').val();
            let localPublicKey = $('#wg_config').data('public-key') || $('#wg_manual_public_key').val();
            
            if (!localPrivateKey || !localPublicKey) {
                alert('Please generate a keypair or enter private key manually');
                return;
            }
            
            formData.wg_config = {
                remote_endpoint: $('#wg_remote_endpoint').val(),
                remote_public_key: $('#wg_remote_public_key').val(),
                tunnel_ip: $('#wg_tunnel_ip').val(),
                allowed_ips: $('#wg_allowed_ips').val().split(',').map(ip => ip.trim()),
                local_private_key: localPrivateKey,
                local_public_key: localPublicKey,
                preshared_key: $('#wg_preshared_key').val()
            };
        } else if (tunnelType === 'wg-to-dokodemo') {
            if (!$('#dokodemo_address').val() || !$('#dokodemo_port').val()) {
                alert('Please fill all Dokodemo configuration fields');
                return;
            }
            formData.dokodemo_config = {
                address: $('#dokodemo_address').val(),
                port: parseInt($('#dokodemo_port').val()),
                network: $('#dokodemo_network').val(),
                timeout: parseInt($('#dokodemo_timeout').val()) || 300,
                domain_strategy: $('#dokodemo_domain_strategy').val(),
                follow_redirect: $('#dokodemo_follow_redirect').is(':checked')
            };
        } else if (tunnelType === 'port-forward') {
            if (!$('#pf_remote_host').val() || !$('#pf_remote_port').val()) {
                alert('Please fill all Port Forward configuration fields');
                return;
            }
            formData.port_forward_config = {
                protocol: $('#pf_protocol').val(),
                local_bind_port: parseInt($('#pf_local_port').val()),
                remote_host: $('#pf_remote_host').val(),
                remote_port: parseInt($('#pf_remote_port').val()),
                transparent: $('#pf_transparent').is(':checked')
            };
        }
        
        console.log('Final form data:', formData);
        
        // Determine URL and method based on create/edit mode
        const url = isEdit ? `/api/tunnel/${tunnelId}` : '/api/tunnel';
        const method = isEdit ? 'PUT' : 'POST';
        const action = isEdit ? 'updated' : 'created';
        
        $.ajax({
            url: url,
            method: method,
            contentType: 'application/json',
            data: JSON.stringify(formData)
        })
        .done(function(response) {
            console.log('API Response:', response);
            if (response.success) {
                alert(`Tunnel ${action} successfully!`);
                $('#modal_new_tunnel').modal('hide');
                setTimeout(function() {
                    location.reload();
                }, 500);
            } else {
                alert('Error: ' + (response.message || 'Unknown error'));
            }
        })
        .fail(function(xhr, status, error) {
            console.error('API Error:', xhr, status, error);
            console.error('Response Text:', xhr.responseText);
            alert(`Error ${action.replace('ed', 'ing')} tunnel: ` + (xhr.responseText || error));
        });
    });
    
    // Reset form when modal is closed
    $('#modal_new_tunnel').on('hidden.bs.modal', function() {
        $('#frm_new_tunnel')[0].reset();
        $('#wg_config, #dokodemo_config, #port_forward_config, #manual_key_section').hide();
        $('#wg_config .alert').remove();
        $('#wg_manual_private_key, #wg_manual_public_key, #wg_preshared_key').val('');
        $('#wg_config').removeData('private-key public-key');
        $('#client_selection').hide();
        $('input[name="client_routing"][value="all"]').prop('checked', true);
        
        // Reset modal for create mode
        $('#modal_new_tunnel').removeData('tunnel-id');
        $('#modal_new_tunnel .modal-title').text('New Tunnel');
        $('#frm_new_tunnel button[type="submit"]').text('Create Tunnel');
    });
});

function showTunnelConfig() {
    const tunnelType = $('#tunnel_type').val();
    
    // Reset all required attributes first
    $('#wg_remote_endpoint, #wg_remote_public_key, #dokodemo_address, #dokodemo_port, #pf_remote_host, #pf_remote_port').removeAttr('required');
    
    // Hide all config sections
    $('#wg_config, #dokodemo_config, #port_forward_config').hide();
    
    // Show relevant config section and set required fields
    if (tunnelType === 'wg-to-wg') {
        $('#wg_config').show();
        $('#wg_remote_endpoint, #wg_remote_public_key').attr('required', 'required');
    } else if (tunnelType === 'wg-to-dokodemo') {
        $('#dokodemo_config').show();
        $('#dokodemo_address, #dokodemo_port').attr('required', 'required');
    } else if (tunnelType === 'port-forward') {
        $('#port_forward_config').show();
        $('#pf_remote_host, #pf_remote_port').attr('required', 'required');
    }
}

function generateWireGuardKeys() {
    console.log('Generating WireGuard keypair...');
    
    // Hide manual key section
    $('#manual_key_section').hide();
    
    $.ajax({
        url: '/api/generate-keypair',
        method: 'POST',
        contentType: 'application/json'
    })
    .done(function(response) {
        console.log('Keypair response:', response);
        if (response.success) {
            // Store the private key (will be used when creating tunnel)
            $('#wg_config').data('private-key', response.private_key);
            $('#wg_config').data('public-key', response.public_key);
            
            // Remove any existing alerts
            $('#wg_config .alert').remove();
            
            // Show info to user
            const infoHtml = `
                <div class="alert alert-success">
                    <strong>✓ Keypair Generated!</strong><br>
                    <small>Private Key: <code>${response.private_key}</code></small><br>
                    <small>Public Key: <code>${response.public_key}</code></small><br>
                    <small class="text-success">Add the public key to your remote WireGuard server</small>
                </div>
            `;
            $('#wg_config').prepend(infoHtml);
        } else {
            alert('Error generating keypair: ' + (response.message || 'Unknown error'));
        }
    })
    .fail(function(xhr, status, error) {
        console.error('Keypair generation failed:', xhr, status, error);
        console.error('Response text:', xhr.responseText);
        alert('Error generating keypair: ' + (xhr.responseText || error));
    });
}

function showManualKeyEntry() {
    console.log('Showing manual key entry...');
    
    // Remove any existing alerts
    $('#wg_config .alert').remove();
    
    // Show manual key section
    $('#manual_key_section').show();
    
    // Clear stored keys
    $('#wg_config').removeData('private-key public-key');
    
    // Focus on private key field
    $('#wg_manual_private_key').focus();
}

function generatePublicKeyFromPrivate() {
    const privateKey = $('#wg_manual_private_key').val().trim();
    
    if (!privateKey) {
        $('#wg_manual_public_key').val('');
        return;
    }
    
    console.log('Generating public key from private key:', privateKey);
    
    $.ajax({
        url: '/api/generate-keypair',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            private_key: privateKey
        })
    })
    .done(function(response) {
        console.log('Public key response:', response);
        if (response.success) {
            $('#wg_manual_public_key').val(response.public_key);
            
            // Store keys for form submission
            $('#wg_config').data('private-key', response.private_key);
            $('#wg_config').data('public-key', response.public_key);
            
            // Show success message
            $('#wg_config .alert').remove();
            const infoHtml = `
                <div class="alert alert-success">
                    <strong>✓ Public Key Generated!</strong><br>
                    <small>Private Key: <code>${response.private_key}</code></small><br>
                    <small>Public Key: <code>${response.public_key}</code></small><br>
                    <small class="text-success">Add the public key to your remote WireGuard server</small>
                </div>
            `;
            $('#wg_config').prepend(infoHtml);
        } else {
            $('#wg_manual_public_key').val('');
            alert('Error generating public key: ' + (response.message || 'Invalid private key'));
        }
    })
    .fail(function(xhr, status, error) {
        console.error('Public key generation failed:', xhr, status, error);
        console.error('Response text:', xhr.responseText);
        $('#wg_manual_public_key').val('');
        alert('Error generating public key: ' + (xhr.responseText || 'Invalid private key format'));
    });
}

function generatePreSharedKey() {
    console.log('Generating PreShared Key...');
    
    $.ajax({
        url: '/api/generate-preshared-key',
        method: 'POST',
        contentType: 'application/json'
    })
    .done(function(response) {
        console.log('PreShared key response:', response);
        if (response.success) {
            $('#wg_preshared_key').val(response.preshared_key);
        } else {
            alert('Error generating PreShared key: ' + (response.message || 'Unknown error'));
        }
    })
    .fail(function(xhr, status, error) {
        console.error('PreShared key generation failed:', xhr, status, error);
        alert('Error generating PreShared key');
    });
}

function loadClientList() {
    $.ajax({
        url: '/api/clients',
        method: 'GET'
    })
    .done(function(response) {        
        let clientHtml = '';
        console.log('Client list response:', response);
        
        // Handle GetClients API response structure
        const clients = response.success && response.data ? response.data : [];
        
        if (clients.length === 0) {
            $('#client_list').html('<div class="alert alert-info">No clients available</div>');
            return;
        }
        
        clients.forEach(function(clientData) {
            // ClientData structure has nested client object
            const client = clientData.client;
            if (client && client.id) {
                const ips = client.allocated_ips || [];
                const ipStr = Array.isArray(ips) ? ips.join(', ') : 'N/A';
                clientHtml += `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="client_ids" value="${client.id}" id="client_${client.id}">
                        <label class="form-check-label" for="client_${client.id}">
                            ${client.name} (${ipStr})
                        </label>
                    </div>
                `;
            }
        });
        $('#client_list').html(clientHtml);
    })
    .fail(function(xhr, status, error) {
        console.error('Failed to load clients:', xhr, status, error);
        $('#client_list').html('<div class="alert alert-warning">Failed to load clients</div>');
    });
}

function editTunnel(tunnelId) {
    // Load tunnel data
    $.ajax({
        url: '/api/tunnel/' + tunnelId,
        method: 'GET'
    })
    .done(function(tunnel) {
        // Populate basic fields
        $('#tunnel_name').val(tunnel.name);
        $('#tunnel_type').val(tunnel.type);
        $('#description').val(tunnel.description);
        
        // Show config for this tunnel type
        showTunnelConfig();
        
        // Populate type-specific fields
        if (tunnel.type === 'wg-to-wg' && tunnel.wg_config) {
            $('#wg_remote_endpoint').val(tunnel.wg_config.remote_endpoint);
            $('#wg_remote_public_key').val(tunnel.wg_config.remote_public_key);
            $('#wg_tunnel_ip').val(tunnel.wg_config.tunnel_ip);
            if (tunnel.wg_config.allowed_ips && Array.isArray(tunnel.wg_config.allowed_ips)) {
                $('#wg_allowed_ips').val(tunnel.wg_config.allowed_ips.join(', '));
            }
            
            // Load private/public key if available
            if (tunnel.wg_config.local_private_key) {
                $('#wg_manual_private_key').val(tunnel.wg_config.local_private_key);
                $('#manual_key_section').show();
            }
            if (tunnel.wg_config.local_public_key) {
                $('#wg_manual_public_key').val(tunnel.wg_config.local_public_key);
            }
            
            // Load PreShared Key if available
            if (tunnel.wg_config.preshared_key) {
                $('#wg_preshared_key').val(tunnel.wg_config.preshared_key);
            }
            
            // Store keys for form submission
            $('#wg_config').data('private-key', tunnel.wg_config.local_private_key || '');
            $('#wg_config').data('public-key', tunnel.wg_config.local_public_key || '');
        } else if (tunnel.type === 'wg-to-dokodemo' && tunnel.dokodemo_config) {
            $('#dokodemo_address').val(tunnel.dokodemo_config.address);
            $('#dokodemo_port').val(tunnel.dokodemo_config.port);
            $('#dokodemo_network').val(tunnel.dokodemo_config.network);
            $('#dokodemo_timeout').val(tunnel.dokodemo_config.timeout || 300);
            $('#dokodemo_domain_strategy').val(tunnel.dokodemo_config.domain_strategy || 'AsIs');
            $('#dokodemo_follow_redirect').prop('checked', tunnel.dokodemo_config.follow_redirect || false);
        } else if (tunnel.type === 'port-forward' && tunnel.port_forward_config) {
            $('#pf_protocol').val(tunnel.port_forward_config.protocol);
            $('#pf_local_port').val(tunnel.port_forward_config.local_bind_port);
            $('#pf_remote_host').val(tunnel.port_forward_config.remote_host);
            $('#pf_remote_port').val(tunnel.port_forward_config.remote_port);
            $('#pf_transparent').prop('checked', tunnel.port_forward_config.transparent);
        }
        
        // Set client routing
        if (tunnel.route_all) {
            $('input[name="client_routing"][value="all"]').prop('checked', true);
        } else {
            $('input[name="client_routing"][value="selected"]').prop('checked', true);
            $('#client_selection').show();
            // Mark selected clients (will be loaded via loadClientList)
        }
        
        // Change modal title, button text and store tunnel ID
        $('#modal_new_tunnel .modal-title').text('Edit Tunnel');
        $('#frm_new_tunnel button[type="submit"]').text('Update Tunnel');
        $('#modal_new_tunnel').data('tunnel-id', tunnelId);
        
        // Load and mark selected clients
        loadClientList();
        setTimeout(function() {
            if (tunnel.client_ids && tunnel.client_ids.length > 0) {
                tunnel.client_ids.forEach(function(clientId) {
                    $(`#client_${clientId}`).prop('checked', true);
                });
            }
        }, 500);
        
        $('#modal_new_tunnel').modal('show');
    })
    .fail(function() {
        alert('Error loading tunnel data');
    });
}

function deleteTunnel(tunnelId) {
    if (confirm('Are you sure you want to delete this tunnel? This will affect client routing.')) {
        $.ajax({
            url: '/api/tunnel/' + tunnelId,
            method: 'DELETE',
            contentType: 'application/json'
        })
        .done(function(response) {
            if (response.success) {
                location.reload();
            } else {
                alert('Error: ' + response.message);
            }
        })
        .fail(function() {
            alert('Error deleting tunnel');
        });
    }
}

function startTunnel(tunnelId) {
    $.ajax({
        url: '/api/tunnel/' + tunnelId + '/start',
        method: 'POST',
        contentType: 'application/json'
    })
    .done(function(response) {
        if (response.success) {
            location.reload();
        } else {
            alert('Error: ' + response.message);
        }
    })
    .fail(function() {
        alert('Error starting tunnel');
    });
}

function stopTunnel(tunnelId) {
    $.ajax({
        url: '/api/tunnel/' + tunnelId + '/stop',
        method: 'POST',
        contentType: 'application/json'
    })
    .done(function(response) {
        if (response.success) {
            location.reload();
        } else {
            alert('Error: ' + response.message);
        }
    })
    .fail(function() {
        alert('Error stopping tunnel');
    });
}

function cleanupTunnels() {
    if (confirm('Are you sure you want to cleanup corrupted tunnels? This action cannot be undone!')) {
        $.ajax({
            url: '/api/cleanup-tunnels',
            method: 'POST',
            contentType: 'application/json'
        })
        .done(function(response) {
            if (response.success) {
                alert('Tunnel cleanup completed successfully!');
                $('#modal_cleanup_tunnels').modal('hide');
                location.reload();
            } else {
                alert('Error: ' + response.message);
            }
        })
        .fail(function(xhr, status, error) {
            console.error('Cleanup failed:', xhr, status, error);
            alert('Error cleaning up tunnels: ' + (xhr.responseText || error));
        });
    }
}

function deleteAllTunnels() {
    if (confirm('⚠️ WARNING: This will delete ALL tunnels permanently!\n\nThis action cannot be undone. Are you sure?')) {
        if (confirm('⚠️ FINAL CONFIRMATION: Delete ALL tunnel records?')) {
            $.ajax({
                url: '/api/delete-all-tunnels',
                method: 'DELETE',
                contentType: 'application/json'
            })
            .done(function(response) {
                if (response.success) {
                    alert('All tunnels deleted successfully!');
                    $('#modal_cleanup_tunnels').modal('hide');
                    location.reload();
                } else {
                    alert('Error: ' + response.message);
                }
            })
            .fail(function(xhr, status, error) {
                console.error('Delete all failed:', xhr, status, error);
                alert('Error deleting tunnels: ' + (xhr.responseText || error));
            });
        }
    }
}

</script>
{{end}} 