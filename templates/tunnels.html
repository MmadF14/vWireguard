{{define "title"}}
<span data-translate="Tunnels">Tunnels</span>
{{end}}

{{define "top_css"}}
{{end}}

{{define "page_title"}}
<span data-translate="Tunnels">Tunnels</span>
{{end}}

{{define "page_content"}}
<!-- Page Header -->
<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1><i class="fas fa-exchange-alt"></i> <span data-translate="Tunnels">Tunnels</span></h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{{.basePath}}" data-translate="Home">Home</a></li>
                    <li class="breadcrumb-item active" data-translate="Tunnels">Tunnels</li>
                </ol>
            </div>
        </div>
    </div>
</section>

<!-- Warning about routing setup -->
<section class="content">
    <div class="container-fluid">
        <div class="alert alert-info">
            <h5><i class="icon fas fa-info"></i> <span data-translate="Tunnel Routing Setup Required">Tunnel Routing Setup Required</span></h5>
            <p data-translate="For tunnels to work properly, you need to set up routing rules on your server. Run this command as root:">For tunnels to work properly, you need to set up routing rules on your server. Run this command as root:</p>
            <code>sudo bash setup_tunnel_routing.sh</code>
            <p class="mt-2 mb-0" data-translate="This will configure iptables rules for traffic forwarding and enable IP forwarding.">This will configure iptables rules for traffic forwarding and enable IP forwarding.</p>
        </div>
        
        <div class="alert alert-warning">
            <h5><i class="icon fas fa-exclamation-triangle"></i> <span data-translate="Important Notes">Important Notes</span></h5>
            <ul class="mb-0">
                <li><strong data-translate="Safe Routing:">Safe Routing:</strong> <span data-translate="AllowedIPs of">AllowedIPs of</span> <code>0.0.0.0/0</code> <span data-translate="is automatically replaced with private networks to prevent server disconnection">is automatically replaced with private networks to prevent server disconnection</span></li>
                <li><strong data-translate="Edit Restriction:">Edit Restriction:</strong> <span data-translate="Active tunnels cannot be edited - stop the tunnel first">Active tunnels cannot be edited - stop the tunnel first</span></li>
                <li><strong data-translate="Interface Names:">Interface Names:</strong> <span data-translate="Tunnel interfaces use format">Tunnel interfaces use format</span> <code>wg{suffix}</code> (e.g., wg123)</li>
                <li><strong data-translate="Traffic Forwarding:">Traffic Forwarding:</strong> <span data-translate="Ensure your server has proper iptables rules for traffic forwarding">Ensure your server has proper iptables rules for traffic forwarding</span></li>
            </ul>
        </div>
    </div>
</section>

<section class="content">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0" data-translate="Tunnels">Tunnels</h1>
                <p class="text-muted" data-translate="Manage network tunnels and routing">Manage network tunnels and routing</p>
            </div>
            <div class="col-sm-6">
                <div class="float-right">
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#modal_new_tunnel">
                        <i class="fas fa-plus"></i> <span data-translate="New Tunnel">New Tunnel</span>
                    </button>
                    <button type="button" class="btn btn-warning ml-2" data-toggle="modal" data-target="#modal_cleanup_tunnels">
                        <i class="fas fa-broom"></i> <span data-translate="Cleanup">Cleanup</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="row" id="tunnel-list">
            {{if .tunnels}}
                {{range .tunnels}}
                <div class="col-lg-4 col-md-6 mb-3">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">{{.Name}}</h5>
                            <span class="badge badge-{{if eq .Status "active"}}success{{else}}secondary{{end}}">{{.Status}}</span>
                        </div>
                        <div class="card-body">
                            <p class="card-text">
                                <strong data-translate="Type">Type:</strong> {{.Type}}<br>
                                {{if eq .Type "wg-to-wg"}}
                                    {{if .WGConfig}}
                                        <strong data-translate="Remote">Remote:</strong> {{.WGConfig.RemoteEndpoint}}<br>
                                        <strong data-translate="Tunnel IP">Tunnel IP:</strong> {{.WGConfig.TunnelIP}}
                                    {{end}}
                                {{else if eq .Type "wg-to-dokodemo"}}
                                    {{if .DokodemoConfig}}
                                        <strong data-translate="Target">Target:</strong> {{.DokodemoConfig.Address}}:{{.DokodemoConfig.Port}}<br>
                                        <strong data-translate="Protocol">Protocol:</strong> {{.DokodemoConfig.Network}}
                                    {{end}}
                                {{else if eq .Type "port-forward"}}
                                    {{if .PortForwardConfig}}
                                        <strong data-translate="Protocol">Protocol:</strong> {{.PortForwardConfig.Protocol}}<br>
                                        <strong data-translate="Target">Target:</strong> {{.PortForwardConfig.RemoteHost}}:{{.PortForwardConfig.RemotePort}}
                                    {{end}}
                                {{end}}
                                <strong data-translate="Clients">Clients:</strong> 
                                {{if .RouteAll}}<span data-translate="All Clients">All Clients</span>{{else}}{{len .ClientIDs}} <span data-translate="Selected">Selected</span>{{end}}
                            </p>
                            {{if .Description}}
                            <p class="text-muted">{{.Description}}</p>
                            {{end}}
                            
                            <!-- Traffic Stats -->
                            <div class="row mt-2">
                                <div class="col-6">
                                    <small class="text-muted">
                                        <i class="fas fa-download"></i> <span data-translate="In">In</span>: 
                                        <span class="text-success" data-tunnel-id="{{.ID}}" data-stat="bytes_in">{{.BytesIn | formatBytes}}</span>
                                    </small>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">
                                        <i class="fas fa-upload"></i> <span data-translate="Out">Out</span>: 
                                        <span class="text-primary" data-tunnel-id="{{.ID}}" data-stat="bytes_out">{{.BytesOut | formatBytes}}</span>
                                    </small>
                                </div>
                            </div>
                            {{if eq .Status "active"}}
                            <div class="row mt-1">
                                <div class="col-12">
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i> <span data-translate="Last seen">Last seen</span>: 
                                        <span data-tunnel-id="{{.ID}}" data-stat="last_seen">{{if .LastSeen.IsZero}}<span data-translate="Never">Never</span>{{else}}{{.LastSeen.Format "2006-01-02 15:04:05"}}{{end}}</span>
                                    </small>
                                </div>
                            </div>
                            {{end}}
                        </div>
                        <div class="card-footer">
                            {{if eq .Status "active"}}
                            <button class="btn btn-sm btn-warning mr-2" onclick="stopTunnel('{{.ID}}')">
                                <i class="fas fa-stop"></i> <span data-translate="Stop">Stop</span>
                            </button>
                            {{else}}
                            <button class="btn btn-sm btn-success mr-2" onclick="startTunnel('{{.ID}}')">
                                <i class="fas fa-play"></i> <span data-translate="Start">Start</span>
                            </button>
                            {{end}}
                            {{if eq .Status "active"}}
                            <button class="btn btn-sm btn-secondary mr-2" disabled data-translate="Stop tunnel first to edit" title="Stop tunnel first to edit">
                                <i class="fas fa-edit"></i> <span data-translate="Edit">Edit</span>
                            </button>
                            {{else}}
                            <button class="btn btn-sm btn-secondary mr-2" onclick="editTunnel('{{.ID}}')">
                                <i class="fas fa-edit"></i> <span data-translate="Edit">Edit</span>
                            </button>
                            {{end}}
                            <button class="btn btn-sm btn-danger" onclick="deleteTunnel('{{.ID}}')">
                                <i class="fas fa-trash"></i> <span data-translate="Delete">Delete</span>
                            </button>
                        </div>
                    </div>
                </div>
                {{end}}
            {{else}}
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <span data-translate="No tunnels configured. Add a new tunnel to get started.">No tunnels configured. Add a new tunnel to get started.</span>
                    </div>
                </div>
            {{end}}
        </div>
    </div>
</section>

<!-- New Tunnel Modal -->
<div class="modal fade" id="modal_new_tunnel">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                                        <h4 class="modal-title" data-translate="New Tunnel">New Tunnel</h4>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="frm_new_tunnel">
                <div class="modal-body">
                    <!-- Basic Information -->
                    <div class="form-group">
                        <label for="tunnel_name" data-translate="Tunnel Name">Tunnel Name</label>
                        <input type="text" class="form-control" id="tunnel_name" name="name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="tunnel_type" data-translate="Tunnel Type">Tunnel Type</label>
                        <select class="form-control" id="tunnel_type" name="type" required onchange="showTunnelConfig()">
                            <option value="" data-translate="Select tunnel type">Select tunnel type</option>
                            <option value="wg-to-wg" data-translate="WireGuard to WireGuard">WireGuard to WireGuard</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="description" data-translate="Description (Optional)">Description (Optional)</label>
                        <textarea class="form-control" id="description" name="description" rows="2"></textarea>
                    </div>

                    <!-- Client Selection -->
                    <div class="form-group">
                        <label data-translate="Client Routing">Client Routing</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="client_routing" id="route_all" value="all" checked>
                            <label class="form-check-label" for="route_all" data-translate="Route all clients through this tunnel">
                                Route all clients through this tunnel
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="client_routing" id="route_selected" value="selected">
                            <label class="form-check-label" for="route_selected" data-translate="Route only selected clients">
                                Route only selected clients
                            </label>
                        </div>
                    </div>

                    <div class="form-group" id="client_selection" style="display:none;">
                        <label data-translate="Select Clients">Select Clients</label>
                        <div id="client_list">
                            <!-- Will be populated via AJAX -->
                        </div>
                    </div>

                    <!-- WireGuard Configuration -->
                    <div id="wg_config" style="display:none;">
                        <h5 data-translate="WireGuard Configuration">WireGuard Configuration</h5>
                        
                        <!-- Key Generation Section -->
                        <div class="form-group">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-info btn-sm" onclick="generateWireGuardKeys()">
                                    <i class="fas fa-key"></i> <span data-translate="Generate Keypair">Generate Keypair</span>
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="showManualKeyEntry()">
                                    <i class="fas fa-edit"></i> <span data-translate="Manual Entry">Manual Entry</span>
                                </button>
                            </div>
                            <small class="form-text text-muted" data-translate="Generate or manually enter your keypair">Generate or manually enter your keypair</small>
                        </div>
                        
                        <!-- Manual Key Entry -->
                        <div id="manual_key_section" style="display:none;">
                            <div class="form-group">
                                <label for="wg_manual_private_key" data-translate="Local Private Key">Local Private Key</label>
                                <textarea class="form-control" id="wg_manual_private_key" rows="2" placeholder="Enter your WireGuard private key" onblur="generatePublicKeyFromPrivate()"></textarea>
                                <small class="form-text text-muted" data-translate="Enter your private key and public key will be auto-generated">Enter your private key and public key will be auto-generated</small>
                            </div>
                            <div class="form-group">
                                <label for="wg_manual_public_key" data-translate="Local Public Key (Auto-generated)">Local Public Key (Auto-generated)</label>
                                <input type="text" class="form-control" id="wg_manual_public_key" readonly placeholder="Will be generated from private key">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="wg_remote_endpoint" data-translate="Remote Endpoint (IP:Port)">Remote Endpoint (IP:Port)</label>
                                    <input type="text" class="form-control" id="wg_remote_endpoint" placeholder="1.2.3.4:51820">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="wg_tunnel_ip" data-translate="Our Tunnel IP">Our Tunnel IP</label>
                                    <input type="text" class="form-control" id="wg_tunnel_ip" placeholder="10.0.1.2/24">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="wg_remote_public_key" data-translate="Remote Public Key">Remote Public Key</label>
                            <textarea class="form-control" id="wg_remote_public_key" rows="2" placeholder="Remote WireGuard server's public key"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="wg_allowed_ips" data-translate="Allowed IPs (comma separated)">Allowed IPs (comma separated)</label>
                            <input type="text" class="form-control" id="wg_allowed_ips" value="10.0.0.0/8,172.16.0.0/12,192.168.0.0/16" placeholder="10.0.0.0/8,172.16.0.0/12,192.168.0.0/16">
                            <small class="form-text text-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong data-translate="WARNING:">WARNING:</strong> <span data-translate="Using 0.0.0.0/0 will route ALL traffic through tunnel and may disconnect your server! Use private networks only for safety.">Using 0.0.0.0/0 will route ALL traffic through tunnel and may disconnect your server! Use private networks only for safety.</span>
                            </small>
                        </div>
                        
                        <!-- PreShared Key (Optional) -->
                        <div class="form-group">
                            <label for="wg_preshared_key" data-translate="PreShared Key (Optional)">PreShared Key (Optional)</label>
                            <div class="input-group">
                                <textarea class="form-control" id="wg_preshared_key" rows="2" placeholder="Leave empty or enter PreShared Key for extra security"></textarea>
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-outline-secondary" onclick="generatePreSharedKey()">
                                        <i class="fas fa-key"></i> <span data-translate="Generate">Generate</span>
                                    </button>
                                </div>
                            </div>
                            <small class="form-text text-muted" data-translate="Optional: Adds an extra layer of symmetric-key cryptography">Optional: Adds an extra layer of symmetric-key cryptography</small>
                        </div>
                    </div>

                    <!-- Dokodemo Door Configuration -->
                    <div id="dokodemo_config" style="display:none;">
                        <h5>Dokodemo Door Configuration</h5>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label for="dokodemo_address">Target Address</label>
                                    <input type="text" class="form-control" id="dokodemo_address" placeholder="example.com or 1.2.3.4">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="dokodemo_port">Target Port</label>
                                    <input type="number" class="form-control" id="dokodemo_port" placeholder="80">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="dokodemo_network">Network Protocol</label>
                                    <select class="form-control" id="dokodemo_network">
                                        <option value="tcp">TCP</option>
                                        <option value="udp">UDP</option>
                                        <option value="tcp,udp">TCP + UDP</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="dokodemo_timeout">Timeout (seconds)</label>
                                    <input type="number" class="form-control" id="dokodemo_timeout" value="300" placeholder="300">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="dokodemo_domain_strategy">Domain Strategy</label>
                            <select class="form-control" id="dokodemo_domain_strategy">
                                <option value="AsIs">As Is (default)</option>
                                <option value="UseIP">Use IP</option>
                                <option value="UseIPv4">Use IPv4</option>
                                <option value="UseIPv6">Use IPv6</option>
                            </select>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dokodemo_follow_redirect">
                            <label class="form-check-label" for="dokodemo_follow_redirect">
                                Follow HTTP Redirects  
                            </label>
                        </div>
                    </div>

                    <!-- Port Forward Configuration -->
                    <div id="port_forward_config" style="display:none;">
                        <h5>Port Forward Configuration (Dokodemo Door)</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="pf_protocol">Protocol</label>
                                    <select class="form-control" id="pf_protocol">
                                        <option value="tcp">TCP</option>
                                        <option value="udp">UDP</option>
                                        <option value="both">Both (TCP + UDP)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="pf_local_port">Local Bind Port</label>
                                    <input type="number" class="form-control" id="pf_local_port" placeholder="8080">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label for="pf_remote_host">Target Host</label>
                                    <input type="text" class="form-control" id="pf_remote_host" placeholder="google.com">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="pf_remote_port">Target Port</label>
                                    <input type="number" class="form-control" id="pf_remote_port" placeholder="80">
                                </div>
                            </div>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="pf_transparent">
                            <label class="form-check-label" for="pf_transparent">
                                Transparent Proxy Mode
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary" data-translate="Create Tunnel">Create Tunnel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Cleanup Modal -->
<div class="modal fade" id="modal_cleanup_tunnels" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Cleanup Corrupted Tunnels">Cleanup Corrupted Tunnels</h4>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p data-translate="This will remove any corrupted tunnel records that cannot be loaded properly.">This will remove any corrupted tunnel records that cannot be loaded properly.</p>
                <p><strong data-translate="Warning:">Warning:</strong> <span data-translate="This action cannot be undone!">This action cannot be undone!</span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="cleanupTunnels()" data-translate="Smart Cleanup">Smart Cleanup</button>
                <button type="button" class="btn btn-danger" onclick="deleteAllTunnels()" data-translate="Delete All">Delete All</button>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "bottom_js"}}
<script>
// Smart translation for tunnels page - only when Persian is selected
function smartTranslateTunnels() {
    // Check if current language is Persian
    const currentLang = localStorage.getItem('language') || 'en';
    if (currentLang !== 'fa') {
        console.log('Not Persian language, skipping force translation');
        return;
    }
    
    console.log('Smart translating tunnels page for Persian...');
    
    // Use the existing translation system first
    if (typeof applyTranslations === 'function') {
        applyTranslations();
    }
    
    // Additional translations for elements that might not be caught by the main system
    const additionalTranslations = {
        'test': 'تست',
        'wg-to-wg': 'WG به WG',
        'active': 'فعال',
        'inactive': 'غیرفعال',
        'B': 'بایت'
    };
    
    // Apply additional translations only to specific elements
    document.querySelectorAll('.badge, .card-title').forEach(element => {
        const text = element.textContent.trim();
        if (additionalTranslations[text]) {
            element.textContent = additionalTranslations[text];
        }
    });
    
    console.log('Smart translation completed');
}

// Run smart translation when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Run smart translation only if Persian is selected
    setTimeout(smartTranslateTunnels, 500);
    setTimeout(smartTranslateTunnels, 1000);
    
    // Also run translation when modals are opened
    $('.modal').on('shown.bs.modal', function() {
        setTimeout(smartTranslateTunnels, 100);
    });
    
    // Run translation when AJAX requests complete
    $(document).ajaxComplete(function() {
        setTimeout(smartTranslateTunnels, 100);
    });
});
</script>
<script>
$(document).ready(function() {
    // Load client list on modal open
    $('#modal_new_tunnel').on('shown.bs.modal', function() {
        loadClientList();
        // Ensure tunnel config is shown if type is already selected
        setTimeout(function() {
            if ($('#tunnel_type').val()) {
                showTunnelConfig();
            }
        }, 100);
    });

    // Handle client routing radio button changes
    $('input[name="client_routing"]').change(function() {
        if ($(this).val() === 'selected') {
            $('#client_selection').show();
            loadClientList();
        } else {
            $('#client_selection').hide();
        }
    });

    // Start auto-refresh for tunnel statistics
    startTunnelStatsRefresh();
    
    // Test jQuery and elements
    console.log('jQuery loaded:', typeof $ !== 'undefined');
    console.log('tunnel_type element exists:', $('#tunnel_type').length > 0);
    console.log('wg_config element exists:', $('#wg_config').length > 0);

    // Handle tunnel form submission (create/edit)
    $('#frm_new_tunnel').on('submit', function(e) {
        e.preventDefault();
        
        console.log('Form submitted!');
        
        const tunnelId = $('#modal_new_tunnel').data('tunnel-id');
        const isEdit = !!tunnelId;
        
        const tunnelType = $('#tunnel_type').val();
        const formData = {
            name: $('#tunnel_name').val(),
            type: tunnelType,
            description: $('#description').val(),
            route_all: $('input[name="client_routing"]:checked').val() === 'all',
            client_ids: []
        };

        console.log('Form data before validation:', formData);

        // Validate required fields
        if (!formData.name) {
            alert('Please enter tunnel name');
            return;
        }
        if (!formData.type) {
            alert('Please select tunnel type');
            return;
        }

        // Get selected clients if not routing all
        if (!formData.route_all) {
            $('input[name="client_ids"]:checked').each(function() {
                formData.client_ids.push($(this).val());
            });
        }

        // Add type-specific configuration
        if (tunnelType === 'wg-to-wg') {
            if (!$('#wg_remote_endpoint').val() || !$('#wg_remote_public_key').val()) {
                alert('Please fill all WireGuard configuration fields');
                return;
            }
            
            // Get keys from either generated or manual entry
            let localPrivateKey = $('#wg_config').data('private-key') || $('#wg_manual_private_key').val();
            let localPublicKey = $('#wg_config').data('public-key') || $('#wg_manual_public_key').val();
            
            if (!localPrivateKey || !localPublicKey) {
                alert('Please generate a keypair or enter private key manually');
                return;
            }
            
            formData.wg_config = {
                remote_endpoint: $('#wg_remote_endpoint').val(),
                remote_public_key: $('#wg_remote_public_key').val(),
                tunnel_ip: $('#wg_tunnel_ip').val(),
                allowed_ips: $('#wg_allowed_ips').val().split(',').map(ip => ip.trim()),
                local_private_key: localPrivateKey,
                local_public_key: localPublicKey,
                preshared_key: $('#wg_preshared_key').val()
            };
        } else if (tunnelType === 'wg-to-dokodemo') {
            if (!$('#dokodemo_address').val() || !$('#dokodemo_port').val()) {
                alert('Please fill all Dokodemo configuration fields');
                return;
            }
            formData.dokodemo_config = {
                address: $('#dokodemo_address').val(),
                port: parseInt($('#dokodemo_port').val()),
                network: $('#dokodemo_network').val(),
                timeout: parseInt($('#dokodemo_timeout').val()) || 300,
                domain_strategy: $('#dokodemo_domain_strategy').val(),
                follow_redirect: $('#dokodemo_follow_redirect').is(':checked')
            };
        } else if (tunnelType === 'port-forward') {
            if (!$('#pf_remote_host').val() || !$('#pf_remote_port').val()) {
                alert('Please fill all Port Forward configuration fields');
                return;
            }
            formData.port_forward_config = {
                protocol: $('#pf_protocol').val(),
                local_bind_port: parseInt($('#pf_local_port').val()),
                remote_host: $('#pf_remote_host').val(),
                remote_port: parseInt($('#pf_remote_port').val()),
                transparent: $('#pf_transparent').is(':checked')
            };
        }
        
        console.log('Final form data:', formData);
        
        // Determine URL and method based on create/edit mode
        const url = isEdit ? `{{.basePath}}/api/tunnel/${tunnelId}` : '{{.basePath}}/api/tunnel';
        const method = isEdit ? 'PUT' : 'POST';
        const action = isEdit ? 'updated' : 'created';
        
        $.ajax({
            url: url,
            method: method,
            contentType: 'application/json',
            data: JSON.stringify(formData)
        })
        .done(function(response) {
            console.log('API Response:', response);
            if (response.success) {
                alert(`Tunnel ${action} successfully!`);
                $('#modal_new_tunnel').modal('hide');
                setTimeout(function() {
                    location.reload();
                }, 500);
            } else {
                alert('Error: ' + (response.message || 'Unknown error'));
            }
        })
        .fail(function(xhr, status, error) {
            console.error('API Error:', xhr, status, error);
            console.error('Response Text:', xhr.responseText);
            alert(`Error ${action.replace('ed', 'ing')} tunnel: ` + (xhr.responseText || error));
        });
    });
    
    // Reset form when modal is closed
    $('#modal_new_tunnel').on('hidden.bs.modal', function() {
        $('#frm_new_tunnel')[0].reset();
        $('#wg_config, #dokodemo_config, #port_forward_config, #manual_key_section').hide();
        $('#wg_config .alert').remove();
        $('#wg_manual_private_key, #wg_manual_public_key, #wg_preshared_key').val('');
        $('#wg_config').removeData('private-key public-key');
        $('#client_selection').hide();
        $('input[name="client_routing"][value="all"]').prop('checked', true);
        
        // Reset modal for create mode
        $('#modal_new_tunnel').removeData('tunnel-id');
        $('#modal_new_tunnel .modal-title').text('New Tunnel');
        $('#frm_new_tunnel button[type="submit"]').text('Create Tunnel');
    });
});

function showTunnelConfig() {
    const tunnelType = $('#tunnel_type').val();
    console.log('showTunnelConfig called with type:', tunnelType);
    
    // Reset all required attributes first
    $('#wg_remote_endpoint, #wg_remote_public_key, #dokodemo_address, #dokodemo_port, #pf_remote_host, #pf_remote_port').removeAttr('required');
    
    // Hide all config sections
    $('#wg_config, #dokodemo_config, #port_forward_config').hide();
    
    // Show relevant config section and set required fields
    if (tunnelType === 'wg-to-wg') {
        console.log('Showing WireGuard config section');
        $('#wg_config').show();
        $('#wg_remote_endpoint, #wg_remote_public_key').attr('required', 'required');
        
        // Run translation after showing the config
        setTimeout(smartTranslateTunnels, 100);
    } else if (tunnelType === 'wg-to-dokodemo') {
        console.log('Showing Dokodemo config section');
        $('#dokodemo_config').show();
        $('#dokodemo_address, #dokodemo_port').attr('required', 'required');
    } else if (tunnelType === 'port-forward') {
        console.log('Showing Port Forward config section');
        $('#port_forward_config').show();
        $('#pf_remote_host, #pf_remote_port').attr('required', 'required');
    }
}

function generateWireGuardKeys() {
    console.log('Generating WireGuard keypair...');
    
    // Hide manual key section
    $('#manual_key_section').hide();
    
    $.ajax({
        url: '{{.basePath}}/api/tunnel/generate-keypair',
        method: 'POST',
        contentType: 'application/json'
    })
    .done(function(response) {
        console.log('Keypair response:', response);
        if (response.success) {
            // Store the private key (will be used when creating tunnel)
            $('#wg_config').data('private-key', response.private_key);
            $('#wg_config').data('public-key', response.public_key);
            
            // Remove any existing alerts
            $('#wg_config .alert').remove();
            
            // Show info to user
            const infoHtml = `
                <div class="alert alert-success">
                    <strong>✓ Keypair Generated!</strong><br>
                    <small>Private Key: <code>${response.private_key}</code></small><br>
                    <small>Public Key: <code>${response.public_key}</code></small><br>
                    <small class="text-success">Add the public key to your remote WireGuard server</small>
                </div>
            `;
            $('#wg_config').prepend(infoHtml);
        } else {
            alert('Error generating keypair: ' + (response.message || 'Unknown error'));
        }
    })
    .fail(function(xhr, status, error) {
        console.error('Keypair generation failed:', xhr, status, error);
        console.error('Response text:', xhr.responseText);
        alert('Error generating keypair: ' + (xhr.responseText || error));
    });
}

function showManualKeyEntry() {
    console.log('Showing manual key entry...');
    
    // Remove any existing alerts
    $('#wg_config .alert').remove();
    
    // Show manual key section
    $('#manual_key_section').show();
    
    // Clear stored keys
    $('#wg_config').removeData('private-key public-key');
    
    // Focus on private key field
    $('#wg_manual_private_key').focus();
}

function generatePublicKeyFromPrivate() {
    const privateKey = $('#wg_manual_private_key').val().trim();
    
    if (!privateKey) {
        $('#wg_manual_public_key').val('');
        return;
    }
    
    console.log('Generating public key from private key:', privateKey);
    
    $.ajax({
        url: '{{.basePath}}/api/tunnel/generate-keypair',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            private_key: privateKey
        })
    })
    .done(function(response) {
        console.log('Public key response:', response);
        if (response.success) {
            $('#wg_manual_public_key').val(response.public_key);
            
            // Store keys for form submission
            $('#wg_config').data('private-key', response.private_key);
            $('#wg_config').data('public-key', response.public_key);
            
            // Show success message
            $('#wg_config .alert').remove();
            const infoHtml = `
                <div class="alert alert-success">
                    <strong>✓ Public Key Generated!</strong><br>
                    <small>Private Key: <code>${response.private_key}</code></small><br>
                    <small>Public Key: <code>${response.public_key}</code></small><br>
                    <small class="text-success">Add the public key to your remote WireGuard server</small>
                </div>
            `;
            $('#wg_config').prepend(infoHtml);
        } else {
            $('#wg_manual_public_key').val('');
            alert('Error generating public key: ' + (response.message || 'Invalid private key'));
        }
    })
    .fail(function(xhr, status, error) {
        console.error('Public key generation failed:', xhr, status, error);
        console.error('Response text:', xhr.responseText);
        $('#wg_manual_public_key').val('');
        alert('Error generating public key: ' + (xhr.responseText || 'Invalid private key format'));
    });
}

function generatePreSharedKey() {
    console.log('Generating PreShared Key...');
    
    $.ajax({
        url: '{{.basePath}}/api/tunnel/generate-preshared-key',
        method: 'POST',
        contentType: 'application/json'
    })
    .done(function(response) {
        console.log('PreShared key response:', response);
        if (response.success) {
            $('#wg_preshared_key').val(response.preshared_key);
        } else {
            alert('Error generating PreShared key: ' + (response.message || 'Unknown error'));
        }
    })
    .fail(function(xhr, status, error) {
        console.error('PreShared key generation failed:', xhr, status, error);
        alert('Error generating PreShared key');
    });
}

function loadClientList() {
    console.log('Loading client list...');
    $.ajax({
        url: '{{.basePath}}/api/clients',
        method: 'GET'
    })
    .done(function(response) {        
        let clientHtml = '';
        console.log('Client list response:', response);
        
        // GetClients API response structure: {success: true, data: [{Client: {...}, QRCode: "..."}, ...]}
        let clientsData = [];
        if (response && response.success && Array.isArray(response.data)) {
            clientsData = response.data;
            console.log('Found', clientsData.length, 'client data objects');
        } else {
            console.error('Unexpected API response structure:', response);
            $('#client_list').html('<div class="alert alert-warning">Unexpected API response structure</div>');
            return;
        }
        
        if (!clientsData || clientsData.length === 0) {
            $('#client_list').html('<div class="alert alert-info">No clients available. Please create some clients first in the <a href="/">Wireguard Clients</a> section.</div>');
            return;
        }
        
        clientsData.forEach(function(clientDataObj, index) {
            console.log('Processing client data object', index, ':', clientDataObj);
            
            // ClientData structure: {Client: {...}, QRCode: "..."}
            // کلیدها با حروف بزرگ هستن: Client نه client
            const client = clientDataObj.Client || clientDataObj.client;
            
            if (client && client.id && client.name) {
                const ips = client.allocated_ips || client.AllocatedIPs || [];
                const ipStr = Array.isArray(ips) ? ips.join(', ') : (typeof ips === 'string' ? ips : 'N/A');
                const clientName = client.name || client.Name || 'Unnamed Client';
                
                clientHtml += `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="client_ids" value="${client.id}" id="client_${client.id}">
                        <label class="form-check-label" for="client_${client.id}">
                            <strong>${clientName}</strong><br>
                            <small class="text-muted">IPs: ${ipStr}</small>
                        </label>
                    </div>
                `;
                console.log('Added client:', clientName, 'with ID:', client.id, 'and IPs:', ipStr);
            } else {
                console.warn('Invalid client data in object', index, ':', clientDataObj);
                console.warn('Client object found:', client);
            }
        });
        
        if (clientHtml === '') {
            $('#client_list').html('<div class="alert alert-warning">No valid clients found. Please check if you have created any clients in the <a href="/">Wireguard Clients</a> section.</div>');
            console.warn('No valid clients processed from', clientsData.length, 'client data objects');
        } else {
            $('#client_list').html(clientHtml);
            console.log('Successfully processed and displayed clients');
        }
    })
    .fail(function(xhr, status, error) {
        console.error('Failed to load clients:', xhr, status, error);
        console.error('Response text:', xhr.responseText);
        $('#client_list').html('<div class="alert alert-danger">Failed to load clients: ' + (xhr.responseText || error) + '<br>Please check if you have created any clients in the <a href="/">Wireguard Clients</a> section.</div>');
    });
}

function editTunnel(tunnelId) {
    // Load tunnel data
    $.ajax({
        url: '{{.basePath}}/api/tunnel/' + tunnelId,
        method: 'GET'
    })
    .done(function(tunnel) {
        // Populate basic fields
        $('#tunnel_name').val(tunnel.name);
        $('#tunnel_type').val(tunnel.type);
        $('#description').val(tunnel.description);
        
        // Show config for this tunnel type
        showTunnelConfig();
        
        // Populate type-specific fields
        if (tunnel.type === 'wg-to-wg' && tunnel.wg_config) {
            $('#wg_remote_endpoint').val(tunnel.wg_config.remote_endpoint);
            $('#wg_remote_public_key').val(tunnel.wg_config.remote_public_key);
            $('#wg_tunnel_ip').val(tunnel.wg_config.tunnel_ip);
            if (tunnel.wg_config.allowed_ips && Array.isArray(tunnel.wg_config.allowed_ips)) {
                $('#wg_allowed_ips').val(tunnel.wg_config.allowed_ips.join(', '));
            }
            
            // Load private/public key if available
            if (tunnel.wg_config.local_private_key) {
                $('#wg_manual_private_key').val(tunnel.wg_config.local_private_key);
                $('#manual_key_section').show();
            }
            if (tunnel.wg_config.local_public_key) {
                $('#wg_manual_public_key').val(tunnel.wg_config.local_public_key);
            }
            
            // Load PreShared Key if available
            if (tunnel.wg_config.preshared_key) {
                $('#wg_preshared_key').val(tunnel.wg_config.preshared_key);
            }
            
            // Store keys for form submission
            $('#wg_config').data('private-key', tunnel.wg_config.local_private_key || '');
            $('#wg_config').data('public-key', tunnel.wg_config.local_public_key || '');
        } else if (tunnel.type === 'wg-to-dokodemo' && tunnel.dokodemo_config) {
            $('#dokodemo_address').val(tunnel.dokodemo_config.address);
            $('#dokodemo_port').val(tunnel.dokodemo_config.port);
            $('#dokodemo_network').val(tunnel.dokodemo_config.network);
            $('#dokodemo_timeout').val(tunnel.dokodemo_config.timeout || 300);
            $('#dokodemo_domain_strategy').val(tunnel.dokodemo_config.domain_strategy || 'AsIs');
            $('#dokodemo_follow_redirect').prop('checked', tunnel.dokodemo_config.follow_redirect || false);
        } else if (tunnel.type === 'port-forward' && tunnel.port_forward_config) {
            $('#pf_protocol').val(tunnel.port_forward_config.protocol);
            $('#pf_local_port').val(tunnel.port_forward_config.local_bind_port);
            $('#pf_remote_host').val(tunnel.port_forward_config.remote_host);
            $('#pf_remote_port').val(tunnel.port_forward_config.remote_port);
            $('#pf_transparent').prop('checked', tunnel.port_forward_config.transparent);
        }
        
        // Set client routing
        if (tunnel.route_all) {
            $('input[name="client_routing"][value="all"]').prop('checked', true);
        } else {
            $('input[name="client_routing"][value="selected"]').prop('checked', true);
            $('#client_selection').show();
            // Mark selected clients (will be loaded via loadClientList)
        }
        
        // Change modal title, button text and store tunnel ID
        $('#modal_new_tunnel .modal-title').text('Edit Tunnel');
        $('#frm_new_tunnel button[type="submit"]').text('Update Tunnel');
        $('#modal_new_tunnel').data('tunnel-id', tunnelId);
        
        // Load and mark selected clients
        loadClientList();
        setTimeout(function() {
            if (tunnel.client_ids && tunnel.client_ids.length > 0) {
                tunnel.client_ids.forEach(function(clientId) {
                    $(`#client_${clientId}`).prop('checked', true);
                });
            }
        }, 500);
        
        $('#modal_new_tunnel').modal('show');
    })
    .fail(function() {
        alert('Error loading tunnel data');
    });
}

function deleteTunnel(tunnelId) {
    if (confirm('Are you sure you want to delete this tunnel? This will affect client routing.')) {
        $.ajax({
            url: '{{.basePath}}/api/tunnel/' + tunnelId,
            method: 'DELETE',
            contentType: 'application/json'
        })
        .done(function(response) {
            if (response.success) {
                location.reload();
            } else {
                alert('Error: ' + response.message);
            }
        })
        .fail(function() {
            alert('Error deleting tunnel');
        });
    }
}

function startTunnel(tunnelId) {
    console.log('Starting tunnel:', tunnelId);
    
    // Disable button and show loading
    const startBtn = event.target;
    const originalText = startBtn.innerHTML;
    startBtn.disabled = true;
    startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
    
    $.ajax({
        url: '{{.basePath}}/api/tunnel/' + tunnelId + '/start',
        method: 'POST',
        contentType: 'application/json',
        timeout: 60000, // 60 seconds timeout
        beforeSend: function() {
            console.log('Sending start tunnel request...');
        }
    })
    .done(function(response) {
        console.log('Start tunnel response:', response);
        if (response.success) {
            alert('Tunnel started successfully!');
            location.reload();
        } else {
            alert('Error: ' + (response.message || 'Unknown error'));
        }
    })
    .fail(function(xhr, status, error) {
        console.error('Start tunnel failed:', {
            status: xhr.status,
            statusText: xhr.statusText,
            responseText: xhr.responseText,
            error: error
        });
        
        let errorMessage = 'Error starting tunnel';
        if (status === 'timeout') {
            errorMessage = 'Request timeout - tunnel start is taking too long';
        } else if (xhr.responseText) {
            try {
                const response = JSON.parse(xhr.responseText);
                errorMessage = response.message || errorMessage;
            } catch(e) {
                errorMessage = xhr.responseText || errorMessage;
            }
        }
        
        alert(errorMessage);
    })
    .always(function() {
        // Re-enable button
        startBtn.disabled = false;
        startBtn.innerHTML = originalText;
    });
}

function stopTunnel(tunnelId) {
    console.log('Stopping tunnel:', tunnelId);
    
    // Disable button and show loading
    const stopBtn = event.target;
    const originalText = stopBtn.innerHTML;
    stopBtn.disabled = true;
    stopBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Stopping...';
    
    $.ajax({
        url: '{{.basePath}}/api/tunnel/' + tunnelId + '/stop',
        method: 'POST',
        contentType: 'application/json',
        timeout: 30000, // 30 seconds timeout
        beforeSend: function() {
            console.log('Sending stop tunnel request...');
        }
    })
    .done(function(response) {
        console.log('Stop tunnel response:', response);
        if (response.success) {
            alert('Tunnel stopped successfully!');
            location.reload();
        } else {
            alert('Error: ' + (response.message || 'Unknown error'));
        }
    })
    .fail(function(xhr, status, error) {
        console.error('Stop tunnel failed:', {
            status: xhr.status,
            statusText: xhr.statusText,
            responseText: xhr.responseText,
            error: error
        });
        
        let errorMessage = 'Error stopping tunnel';
        if (status === 'timeout') {
            errorMessage = 'Request timeout - tunnel stop is taking too long';
        } else if (xhr.responseText) {
            try {
                const response = JSON.parse(xhr.responseText);
                errorMessage = response.message || errorMessage;
            } catch(e) {
                errorMessage = xhr.responseText || errorMessage;
            }
        }
        
        alert(errorMessage);
    })
    .always(function() {
        // Re-enable button
        stopBtn.disabled = false;
        stopBtn.innerHTML = originalText;
    });
}

function cleanupTunnels() {
    if (confirm('Are you sure you want to cleanup corrupted tunnels? This action cannot be undone!')) {
        $.ajax({
            url: '{{.basePath}}/api/tunnel/cleanup',
            method: 'POST',
            contentType: 'application/json'
        })
        .done(function(response) {
            if (response.success) {
                alert('Tunnel cleanup completed successfully!');
                $('#modal_cleanup_tunnels').modal('hide');
                location.reload();
            } else {
                alert('Error: ' + response.message);
            }
        })
        .fail(function(xhr, status, error) {
            console.error('Cleanup failed:', xhr, status, error);
            alert('Error cleaning up tunnels: ' + (xhr.responseText || error));
        });
    }
}

function deleteAllTunnels() {
    if (confirm('⚠️ WARNING: This will delete ALL tunnels permanently!\n\nThis action cannot be undone. Are you sure?')) {
        if (confirm('⚠️ FINAL CONFIRMATION: Delete ALL tunnel records?')) {
            $.ajax({
                url: '{{.basePath}}/api/tunnel/cleanup/all',
                method: 'DELETE',
                contentType: 'application/json'
            })
            .done(function(response) {
                if (response.success) {
                    alert('All tunnels deleted successfully!');
                    $('#modal_cleanup_tunnels').modal('hide');
                    location.reload();
                } else {
                    alert('Error: ' + response.message);
                }
            })
            .fail(function(xhr, status, error) {
                console.error('Delete all failed:', xhr, status, error);
                alert('Error deleting tunnels: ' + (xhr.responseText || error));
            });
        }
    }
}

// Format bytes to human readable format
function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Start auto-refresh for tunnel statistics
function startTunnelStatsRefresh() {
    // Refresh stats every 30 seconds for active tunnels
    setInterval(function() {
        refreshActiveTunnelStats();
    }, 30000);
}

// Refresh statistics for active tunnels
function refreshActiveTunnelStats() {
    $('.badge-success').each(function() {
        const card = $(this).closest('.card');
        const tunnelId = card.find('[data-tunnel-id]').first().attr('data-tunnel-id');
        
        if (tunnelId) {
            $.ajax({
                url: '{{.basePath}}/api/tunnel/' + tunnelId + '/stats',
                method: 'GET',
                dataType: 'json'
            })
            .done(function(stats) {
                // Update bytes in
                card.find('[data-stat="bytes_in"]').text(formatBytes(stats.bytes_in));
                // Update bytes out
                card.find('[data-stat="bytes_out"]').text(formatBytes(stats.bytes_out));
                // Update last seen
                if (stats.last_seen) {
                    const lastSeen = new Date(stats.last_seen).toLocaleString();
                    card.find('[data-stat="last_seen"]').text(lastSeen);
                }
            })
            .fail(function(xhr, status, error) {
                console.error('Failed to refresh tunnel stats for ' + tunnelId + ':', error);
            });
        }
    });
}

// Manual refresh button for tunnel stats
function refreshTunnelStats(tunnelId) {
    $.ajax({
        url: '{{.basePath}}/api/tunnel/' + tunnelId + '/stats',
        method: 'GET',
        dataType: 'json'
    })
    .done(function(stats) {
        const card = $('[data-tunnel-id="' + tunnelId + '"]').closest('.card');
        card.find('[data-stat="bytes_in"]').text(formatBytes(stats.bytes_in));
        card.find('[data-stat="bytes_out"]').text(formatBytes(stats.bytes_out));
        if (stats.last_seen) {
            const lastSeen = new Date(stats.last_seen).toLocaleString();
            card.find('[data-stat="last_seen"]').text(lastSeen);
        }
        console.log('Tunnel stats refreshed for', tunnelId);
    })
    .fail(function(xhr, status, error) {
        console.error('Failed to refresh tunnel stats:', error);
        alert('Failed to refresh tunnel statistics');
    });
}
</script>
{{end}} 