{{define "title"}}
<span data-translate="Tunnels">Tunnels</span>
{{end}}

{{define "top_css"}}
{{end}}

{{define "username"}}
{{ .username }}
{{end}}

{{define "page_title"}}
<span data-translate="Tunnels">Tunnels</span>
{{end}}

{{define "page_content"}}
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
            <div class="flex-1">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
                    <i class="fas fa-exchange-alt text-primary-500 mr-2 rtl:mr-0 rtl:ml-2"></i>
                    <span data-translate="Tunnels">Tunnels</span>
                </h2>
                <p class="text-gray-600 dark:text-gray-400">
                    <span data-translate="Manage network tunnels and routing">Manage network tunnels and routing</span>
                </p>
            </div>
            <div class="flex space-x-3 rtl:space-x-reverse mt-4 sm:mt-0">
                <button onclick="openNewTunnelModal()" 
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-xl text-white bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-200">
                    <i class="fas fa-plus mr-2 rtl:mr-0 rtl:ml-2"></i>
                    <span data-translate="New Tunnel">New Tunnel</span>
                </button>
                <button onclick="openCleanupModal()" 
                        class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-dark-600 text-sm font-medium rounded-xl text-gray-700 dark:text-gray-300 bg-white dark:bg-dark-700 hover:bg-gray-50 dark:hover:bg-dark-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all duration-200">
                    <i class="fas fa-broom mr-2 rtl:mr-0 rtl:ml-2"></i>
                    <span data-translate="Cleanup">Cleanup</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Warning Alerts -->
    <div class="space-y-4 mb-8">
        <!-- Routing Setup Alert -->
        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-200 dark:border-blue-800 p-6">
            <div class="flex items-start space-x-3 rtl:space-x-reverse">
                <div class="flex-shrink-0">
                    <i class="fas fa-info-circle text-blue-600 dark:text-blue-400 text-xl"></i>
                </div>
                <div class="flex-1">
                    <h3 class="text-lg font-medium text-blue-900 dark:text-blue-200 mb-2">
                        <span data-translate="Tunnel Routing Setup Required">Tunnel Routing Setup Required</span>
                    </h3>
                    <div class="text-blue-800 dark:text-blue-300 space-y-2">
                        <p data-translate="For tunnels to work properly, you need to set up routing rules on your server. Run this command as root:">For tunnels to work properly, you need to set up routing rules on your server. Run this command as root:</p>
                        <div class="bg-blue-100 dark:bg-blue-800/50 rounded-lg p-3 font-mono text-sm">
                            sudo bash setup_tunnel_routing.sh
                        </div>
                        <p class="text-sm" data-translate="This will configure iptables rules for traffic forwarding and enable IP forwarding.">This will configure iptables rules for traffic forwarding and enable IP forwarding.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Important Notes Alert -->
        <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-xl border border-yellow-200 dark:border-yellow-800 p-6">
            <div class="flex items-start space-x-3 rtl:space-x-reverse">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-yellow-600 dark:text-yellow-400 text-xl"></i>
                </div>
                <div class="flex-1">
                    <h3 class="text-lg font-medium text-yellow-900 dark:text-yellow-200 mb-3">
                        <span data-translate="Important Notes">Important Notes</span>
                    </h3>
                    <div class="text-yellow-800 dark:text-yellow-300 space-y-2 text-sm">
                        <div class="flex items-start space-x-2 rtl:space-x-reverse">
                            <i class="fas fa-shield-alt text-yellow-600 dark:text-yellow-400 mt-0.5"></i>
                            <div>
                                <strong data-translate="Safe Routing:">Safe Routing:</strong> 
                                <span data-translate="AllowedIPs of">AllowedIPs of</span> 
                                <code class="bg-yellow-100 dark:bg-yellow-800/50 px-1 rounded">0.0.0.0/0</code> 
                                <span data-translate="is automatically replaced with private networks to prevent server disconnection">is automatically replaced with private networks to prevent server disconnection</span>
                            </div>
                        </div>
                        <div class="flex items-start space-x-2 rtl:space-x-reverse">
                            <i class="fas fa-edit text-yellow-600 dark:text-yellow-400 mt-0.5"></i>
                            <div>
                                <strong data-translate="Edit Restriction:">Edit Restriction:</strong> 
                                <span data-translate="Active tunnels cannot be edited - stop the tunnel first">Active tunnels cannot be edited - stop the tunnel first</span>
                            </div>
                        </div>
                        <div class="flex items-start space-x-2 rtl:space-x-reverse">
                            <i class="fas fa-network-wired text-yellow-600 dark:text-yellow-400 mt-0.5"></i>
                            <div>
                                <strong data-translate="Interface Names:">Interface Names:</strong> 
                                <span data-translate="Tunnel interfaces use format">Tunnel interfaces use format</span> 
                                <code class="bg-yellow-100 dark:bg-yellow-800/50 px-1 rounded">wg{suffix}</code> (e.g., wg123)
                            </div>
                        </div>
                        <div class="flex items-start space-x-2 rtl:space-x-reverse">
                            <i class="fas fa-route text-yellow-600 dark:text-yellow-400 mt-0.5"></i>
                            <div>
                                <strong data-translate="Traffic Forwarding:">Traffic Forwarding:</strong> 
                                <span data-translate="Ensure your server has proper iptables rules for traffic forwarding">Ensure your server has proper iptables rules for traffic forwarding</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tunnels Grid -->
    <div id="tunnel-list">
        {{if .tunnels}}
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            {{range .tunnels}}
            <div class="bg-white dark:bg-dark-800 rounded-2xl shadow-soft border border-gray-200 dark:border-dark-700 overflow-hidden card-hover">
                <!-- Tunnel Header -->
                <div class="p-6 border-b border-gray-200 dark:border-dark-700">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-3 rtl:space-x-reverse">
                            <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center">
                                <i class="fas fa-exchange-alt text-white text-sm"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white truncate">{{.Name}}</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">{{.Type}}</p>
                            </div>
                        </div>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium {{if eq .Status "active"}}bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-300{{else}}bg-gray-100 text-gray-800 dark:bg-gray-900/20 dark:text-gray-300{{end}}">
                            <i class="fas fa-circle mr-1 rtl:mr-0 rtl:ml-1 text-xs"></i>
                            {{.Status}}
                        </span>
                    </div>
                </div>

                <!-- Tunnel Details -->
                <div class="p-6 space-y-4">
                    <!-- Configuration Details -->
                    <div class="space-y-3">
                        {{if eq .Type "wg-to-wg"}}
                            {{if .WGConfig}}
                            <div class="flex items-center space-x-2 rtl:space-x-reverse text-sm">
                                <i class="fas fa-globe text-gray-400 w-4"></i>
                                <span class="text-gray-600 dark:text-gray-400" data-translate="Remote">Remote:</span>
                                <span class="text-gray-900 dark:text-white font-mono">{{.WGConfig.RemoteEndpoint}}</span>
                            </div>
                            <div class="flex items-center space-x-2 rtl:space-x-reverse text-sm">
                                <i class="fas fa-network-wired text-gray-400 w-4"></i>
                                <span class="text-gray-600 dark:text-gray-400" data-translate="Tunnel IP">Tunnel IP:</span>
                                <span class="text-gray-900 dark:text-white font-mono">{{.WGConfig.TunnelIP}}</span>
                            </div>
                            {{end}}
                        {{else if eq .Type "wg-to-dokodemo"}}
                            {{if .DokodemoConfig}}
                            <div class="flex items-center space-x-2 rtl:space-x-reverse text-sm">
                                <i class="fas fa-bullseye text-gray-400 w-4"></i>
                                <span class="text-gray-600 dark:text-gray-400" data-translate="Target">Target:</span>
                                <span class="text-gray-900 dark:text-white font-mono">{{.DokodemoConfig.Address}}:{{.DokodemoConfig.Port}}</span>
                            </div>
                            <div class="flex items-center space-x-2 rtl:space-x-reverse text-sm">
                                <i class="fas fa-layer-group text-gray-400 w-4"></i>
                                <span class="text-gray-600 dark:text-gray-400" data-translate="Protocol">Protocol:</span>
                                <span class="text-gray-900 dark:text-white">{{.DokodemoConfig.Network}}</span>
                            </div>
                            {{end}}
                        {{else if eq .Type "port-forward"}}
                            {{if .PortForwardConfig}}
                            <div class="flex items-center space-x-2 rtl:space-x-reverse text-sm">
                                <i class="fas fa-layer-group text-gray-400 w-4"></i>
                                <span class="text-gray-600 dark:text-gray-400" data-translate="Protocol">Protocol:</span>
                                <span class="text-gray-900 dark:text-white">{{.PortForwardConfig.Protocol}}</span>
                            </div>
                            <div class="flex items-center space-x-2 rtl:space-x-reverse text-sm">
                                <i class="fas fa-bullseye text-gray-400 w-4"></i>
                                <span class="text-gray-600 dark:text-gray-400" data-translate="Target">Target:</span>
                                <span class="text-gray-900 dark:text-white font-mono">{{.PortForwardConfig.RemoteHost}}:{{.PortForwardConfig.RemotePort}}</span>
                            </div>
                            {{end}}
                        {{end}}
                        
                        <div class="flex items-center space-x-2 rtl:space-x-reverse text-sm">
                            <i class="fas fa-users text-gray-400 w-4"></i>
                            <span class="text-gray-600 dark:text-gray-400" data-translate="Clients">Clients:</span>
                            <span class="text-gray-900 dark:text-white">
                                {{if .RouteAll}}<span data-translate="All Clients">All Clients</span>{{else}}{{len .ClientIDs}} <span data-translate="Selected">Selected</span>{{end}}
                            </span>
                        </div>
                    </div>

                    {{if .Description}}
                    <div class="p-3 bg-gray-50 dark:bg-dark-700 rounded-lg">
                        <p class="text-sm text-gray-700 dark:text-gray-300">{{.Description}}</p>
                    </div>
                    {{end}}

                    <!-- Traffic Statistics -->
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-lg p-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center">
                                <div class="flex items-center justify-center space-x-1 rtl:space-x-reverse mb-1">
                                    <i class="fas fa-download text-green-500 text-xs"></i>
                                    <span class="text-xs text-gray-600 dark:text-gray-400" data-translate="In">In</span>
                                </div>
                                <div class="text-sm font-semibold text-gray-900 dark:text-white" data-tunnel-id="{{.ID}}" data-stat="bytes_in">
                                    {{.BytesIn | formatBytes}}
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="flex items-center justify-center space-x-1 rtl:space-x-reverse mb-1">
                                    <i class="fas fa-upload text-blue-500 text-xs"></i>
                                    <span class="text-xs text-gray-600 dark:text-gray-400" data-translate="Out">Out</span>
                                </div>
                                <div class="text-sm font-semibold text-gray-900 dark:text-white" data-tunnel-id="{{.ID}}" data-stat="bytes_out">
                                    {{.BytesOut | formatBytes}}
                                </div>
                            </div>
                        </div>
                        {{if eq .Status "active"}}
                        <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
                            <div class="flex items-center justify-center space-x-1 rtl:space-x-reverse">
                                <i class="fas fa-clock text-gray-400 text-xs"></i>
                                <span class="text-xs text-gray-600 dark:text-gray-400" data-translate="Last seen">Last seen:</span>
                                <span class="text-xs text-gray-900 dark:text-white" data-tunnel-id="{{.ID}}" data-stat="last_seen">
                                    {{if .LastSeen.IsZero}}<span data-translate="Never">Never</span>{{else}}{{.LastSeen.Format "2006-01-02 15:04:05"}}{{end}}
                                </span>
                            </div>
                        </div>
                        {{end}}
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="px-6 pb-6">
                    <div class="flex space-x-2 rtl:space-x-reverse">
                        {{if eq .Status "active"}}
                        <button onclick="stopTunnel('{{.ID}}')" 
                                class="flex-1 inline-flex items-center justify-center px-3 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all duration-200">
                            <i class="fas fa-stop mr-2 rtl:mr-0 rtl:ml-2"></i>
                            <span data-translate="Stop">Stop</span>
                        </button>
                        {{else}}
                        <button onclick="startTunnel('{{.ID}}')" 
                                class="flex-1 inline-flex items-center justify-center px-3 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-200">
                            <i class="fas fa-play mr-2 rtl:mr-0 rtl:ml-2"></i>
                            <span data-translate="Start">Start</span>
                        </button>
                        {{end}}
                        
                        {{if eq .Status "active"}}
                        <button disabled 
                                title="Stop tunnel first to edit"
                                class="inline-flex items-center justify-center px-3 py-2 border border-gray-300 dark:border-dark-600 text-sm font-medium rounded-lg text-gray-400 dark:text-gray-500 bg-gray-100 dark:bg-dark-600 cursor-not-allowed">
                            <i class="fas fa-edit"></i>
                        </button>
                        {{else}}
                        <button onclick="editTunnel('{{.ID}}')" 
                                class="inline-flex items-center justify-center px-3 py-2 border border-gray-300 dark:border-dark-600 text-sm font-medium rounded-lg text-gray-700 dark:text-gray-300 bg-white dark:bg-dark-700 hover:bg-gray-50 dark:hover:bg-dark-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all duration-200">
                            <i class="fas fa-edit"></i>
                        </button>
                        {{end}}
                        
                        <button onclick="deleteTunnel('{{.ID}}')" 
                                class="inline-flex items-center justify-center px-3 py-2 border border-red-300 dark:border-red-700 text-sm font-medium rounded-lg text-red-700 dark:text-red-400 bg-white dark:bg-dark-700 hover:bg-red-50 dark:hover:bg-red-900/20 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all duration-200">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            {{end}}
        </div>
        {{else}}
        <!-- Empty State -->
        <div class="text-center py-12">
            <div class="w-16 h-16 bg-gradient-to-br from-gray-400 to-gray-500 rounded-2xl flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-exchange-alt text-white text-xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">
                <span data-translate="No tunnels configured">No tunnels configured</span>
            </h3>
            <p class="text-gray-600 dark:text-gray-400 mb-6">
                <span data-translate="Add a new tunnel to get started.">Add a new tunnel to get started.</span>
            </p>
            <button onclick="openNewTunnelModal()" 
                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-xl text-white bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-200">
                <i class="fas fa-plus mr-2 rtl:mr-0 rtl:ml-2"></i>
                <span data-translate="New Tunnel">New Tunnel</span>
            </button>
        </div>
        {{end}}
    </div>
</div>
    </div>
</section>

<!-- New Tunnel Modal -->
<div class="modal fade" id="modal_new_tunnel">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                                        <h4 class="modal-title" data-translate="New Tunnel">New Tunnel</h4>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="frm_new_tunnel">
                <div class="modal-body">
                    <!-- Basic Information -->
                    <div class="form-group">
                        <label for="tunnel_name" data-translate="Tunnel Name">Tunnel Name</label>
                        <input type="text" class="form-control" id="tunnel_name" name="name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="tunnel_type" data-translate="Tunnel Type">Tunnel Type</label>
                        <select class="form-control" id="tunnel_type" name="type" required onchange="showTunnelConfig()">
                            <option value="" data-translate="Select tunnel type">Select tunnel type</option>
                            <option value="wg-to-wg" data-translate="WireGuard to WireGuard">WireGuard to WireGuard</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="description" data-translate="Description (Optional)">Description (Optional)</label>
                        <textarea class="form-control" id="description" name="description" rows="2"></textarea>
                    </div>

                    <!-- Client Selection -->
                    <div class="form-group">
                        <label data-translate="Client Routing">Client Routing</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="client_routing" id="route_all" value="all" checked>
                            <label class="form-check-label" for="route_all" data-translate="Route all clients through this tunnel">
                                Route all clients through this tunnel
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="client_routing" id="route_selected" value="selected">
                            <label class="form-check-label" for="route_selected" data-translate="Route only selected clients">
                                Route only selected clients
                            </label>
                        </div>
                    </div>

                    <div class="form-group" id="client_selection" style="display:none;">
                        <label data-translate="Select Clients">Select Clients</label>
                        <div id="client_list">
                            <!-- Will be populated via AJAX -->
                        </div>
                    </div>

                    <!-- WireGuard Configuration -->
                    <div id="wg_config" style="display:none;">
                        <h5 data-translate="WireGuard Configuration">WireGuard Configuration</h5>
                        
                        <!-- Key Generation Section -->
                        <div class="form-group">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-info btn-sm" onclick="generateWireGuardKeys()">
                                    <i class="fas fa-key"></i> <span data-translate="Generate Keypair">Generate Keypair</span>
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="showManualKeyEntry()">
                                    <i class="fas fa-edit"></i> <span data-translate="Manual Entry">Manual Entry</span>
                                </button>
                            </div>
                            <small class="form-text text-muted" data-translate="Generate or manually enter your keypair">Generate or manually enter your keypair</small>
                        </div>
                        
                        <!-- Manual Key Entry -->
                        <div id="manual_key_section" style="display:none;">
                            <div class="form-group">
                                <label for="wg_manual_private_key" data-translate="Local Private Key">Local Private Key</label>
                                <textarea class="form-control" id="wg_manual_private_key" rows="2" placeholder="Enter your WireGuard private key" onblur="generatePublicKeyFromPrivate()"></textarea>
                                <small class="form-text text-muted" data-translate="Enter your private key and public key will be auto-generated">Enter your private key and public key will be auto-generated</small>
                            </div>
                            <div class="form-group">
                                <label for="wg_manual_public_key" data-translate="Local Public Key (Auto-generated)">Local Public Key (Auto-generated)</label>
                                <input type="text" class="form-control" id="wg_manual_public_key" readonly placeholder="Will be generated from private key">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="wg_remote_endpoint" data-translate="Remote Endpoint (IP:Port)">Remote Endpoint (IP:Port)</label>
                                    <input type="text" class="form-control" id="wg_remote_endpoint" placeholder="1.2.3.4:51820">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="wg_tunnel_ip" data-translate="Our Tunnel IP">Our Tunnel IP</label>
                                    <input type="text" class="form-control" id="wg_tunnel_ip" placeholder="10.0.1.2/24">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="wg_remote_public_key" data-translate="Remote Public Key">Remote Public Key</label>
                            <textarea class="form-control" id="wg_remote_public_key" rows="2" placeholder="Remote WireGuard server's public key"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="wg_allowed_ips" data-translate="Allowed IPs (comma separated)">Allowed IPs (comma separated)</label>
                            <input type="text" class="form-control" id="wg_allowed_ips" value="10.0.0.0/8,172.16.0.0/12,192.168.0.0/16" placeholder="10.0.0.0/8,172.16.0.0/12,192.168.0.0/16">
                            <small class="form-text text-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong data-translate="WARNING:">WARNING:</strong> <span data-translate="Using 0.0.0.0/0 will route ALL traffic through tunnel and may disconnect your server! Use private networks only for safety.">Using 0.0.0.0/0 will route ALL traffic through tunnel and may disconnect your server! Use private networks only for safety.</span>
                            </small>
                        </div>
                        
                        <!-- PreShared Key (Optional) -->
                        <div class="form-group">
                            <label for="wg_preshared_key" data-translate="PreShared Key (Optional)">PreShared Key (Optional)</label>
                            <div class="input-group">
                                <textarea class="form-control" id="wg_preshared_key" rows="2" placeholder="Leave empty or enter PreShared Key for extra security"></textarea>
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-outline-secondary" onclick="generatePreSharedKey()">
                                        <i class="fas fa-key"></i> <span data-translate="Generate">Generate</span>
                                    </button>
                                </div>
                            </div>
                            <small class="form-text text-muted" data-translate="Optional: Adds an extra layer of symmetric-key cryptography">Optional: Adds an extra layer of symmetric-key cryptography</small>
                        </div>
                    </div>

                    <!-- Dokodemo Door Configuration -->
                    <div id="dokodemo_config" style="display:none;">
                        <h5>Dokodemo Door Configuration</h5>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label for="dokodemo_address">Target Address</label>
                                    <input type="text" class="form-control" id="dokodemo_address" placeholder="example.com or 1.2.3.4">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="dokodemo_port">Target Port</label>
                                    <input type="number" class="form-control" id="dokodemo_port" placeholder="80">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="dokodemo_network">Network Protocol</label>
                                    <select class="form-control" id="dokodemo_network">
                                        <option value="tcp">TCP</option>
                                        <option value="udp">UDP</option>
                                        <option value="tcp,udp">TCP + UDP</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="dokodemo_timeout">Timeout (seconds)</label>
                                    <input type="number" class="form-control" id="dokodemo_timeout" value="300" placeholder="300">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="dokodemo_domain_strategy">Domain Strategy</label>
                            <select class="form-control" id="dokodemo_domain_strategy">
                                <option value="AsIs">As Is (default)</option>
                                <option value="UseIP">Use IP</option>
                                <option value="UseIPv4">Use IPv4</option>
                                <option value="UseIPv6">Use IPv6</option>
                            </select>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dokodemo_follow_redirect">
                            <label class="form-check-label" for="dokodemo_follow_redirect">
                                Follow HTTP Redirects  
                            </label>
                        </div>
                    </div>

                    <!-- Port Forward Configuration -->
                    <div id="port_forward_config" style="display:none;">
                        <h5>Port Forward Configuration (Dokodemo Door)</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="pf_protocol">Protocol</label>
                                    <select class="form-control" id="pf_protocol">
                                        <option value="tcp">TCP</option>
                                        <option value="udp">UDP</option>
                                        <option value="both">Both (TCP + UDP)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="pf_local_port">Local Bind Port</label>
                                    <input type="number" class="form-control" id="pf_local_port" placeholder="8080">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label for="pf_remote_host">Target Host</label>
                                    <input type="text" class="form-control" id="pf_remote_host" placeholder="google.com">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="pf_remote_port">Target Port</label>
                                    <input type="number" class="form-control" id="pf_remote_port" placeholder="80">
                                </div>
                            </div>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="pf_transparent">
                            <label class="form-check-label" for="pf_transparent">
                                Transparent Proxy Mode
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary" data-translate="Create Tunnel">Create Tunnel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Cleanup Modal -->
<div class="modal fade" id="modal_cleanup_tunnels" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" data-translate="Cleanup Corrupted Tunnels">Cleanup Corrupted Tunnels</h4>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p data-translate="This will remove any corrupted tunnel records that cannot be loaded properly.">This will remove any corrupted tunnel records that cannot be loaded properly.</p>
                <p><strong data-translate="Warning:">Warning:</strong> <span data-translate="This action cannot be undone!">This action cannot be undone!</span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" data-translate="Cancel">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="cleanupTunnels()" data-translate="Smart Cleanup">Smart Cleanup</button>
                <button type="button" class="btn btn-danger" onclick="deleteAllTunnels()" data-translate="Delete All">Delete All</button>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "bottom_js"}}
<script>
// Modern modal system for tunnels page
function openNewTunnelModal() {
    // Create modal HTML
    const modalHTML = `
        <div id="newTunnelModal" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
            <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" onclick="closeNewTunnelModal()"></div>
                
                <div class="inline-block w-full max-w-2xl p-6 my-8 overflow-hidden text-left align-middle transition-all transform bg-white dark:bg-dark-800 shadow-xl rounded-2xl">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">
                            <i class="fas fa-plus-circle text-primary-500 mr-2 rtl:mr-0 rtl:ml-2"></i>
                            <span data-translate="New Tunnel">New Tunnel</span>
                        </h3>
                        <button onclick="closeNewTunnelModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <form id="frm_new_tunnel" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" data-translate="Tunnel Name">Tunnel Name</label>
                            <input type="text" id="tunnel_name" name="name" required
                                   class="w-full px-4 py-2 border border-gray-300 dark:border-dark-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent bg-white dark:bg-dark-700 text-gray-900 dark:text-white">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" data-translate="Tunnel Type">Tunnel Type</label>
                            <select id="tunnel_type" name="type" required onchange="showTunnelConfig()"
                                    class="w-full px-4 py-2 border border-gray-300 dark:border-dark-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent bg-white dark:bg-dark-700 text-gray-900 dark:text-white">
                                <option value="" data-translate="Select tunnel type">Select tunnel type</option>
                                <option value="wg-to-wg" data-translate="WireGuard to WireGuard">WireGuard to WireGuard</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" data-translate="Description (Optional)">Description (Optional)</label>
                            <textarea id="description" name="description" rows="2"
                                      class="w-full px-4 py-2 border border-gray-300 dark:border-dark-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent bg-white dark:bg-dark-700 text-gray-900 dark:text-white resize-none"></textarea>
                        </div>
                        
                        <div class="flex space-x-3 rtl:space-x-reverse pt-4">
                            <button type="button" onclick="closeNewTunnelModal()"
                                    class="flex-1 px-4 py-2 border border-gray-300 dark:border-dark-600 rounded-lg text-gray-700 dark:text-gray-300 bg-white dark:bg-dark-700 hover:bg-gray-50 dark:hover:bg-dark-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all duration-200">
                                <span data-translate="Cancel">Cancel</span>
                            </button>
                            <button type="submit"
                                    class="flex-1 px-4 py-2 border border-transparent rounded-lg text-white bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all duration-200">
                                <span data-translate="Create Tunnel">Create Tunnel</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Show modal
    document.getElementById('newTunnelModal').style.display = 'block';
    
    // Translate modal content
    if (window.langManager) {
        window.langManager.translatePage();
    }
}

function closeNewTunnelModal() {
    const modal = document.getElementById('newTunnelModal');
    if (modal) {
        modal.remove();
    }
}

function openCleanupModal() {
    const modalHTML = `
        <div id="cleanupModal" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
            <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" onclick="closeCleanupModal()"></div>
                
                <div class="inline-block w-full max-w-md p-6 my-8 overflow-hidden text-left align-middle transition-all transform bg-white dark:bg-dark-800 shadow-xl rounded-2xl">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">
                            <i class="fas fa-broom text-yellow-500 mr-2 rtl:mr-0 rtl:ml-2"></i>
                            <span data-translate="Cleanup Corrupted Tunnels">Cleanup Corrupted Tunnels</span>
                        </h3>
                        <button onclick="closeCleanupModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-4">
                            <div class="flex items-start space-x-3 rtl:space-x-reverse">
                                <i class="fas fa-exclamation-triangle text-yellow-600 dark:text-yellow-400 mt-0.5"></i>
                                <div class="text-sm text-yellow-800 dark:text-yellow-200">
                                    <p data-translate="This will remove any corrupted tunnel records that cannot be loaded properly.">This will remove any corrupted tunnel records that cannot be loaded properly.</p>
                                    <p class="mt-2 font-medium" data-translate="Warning: This action cannot be undone!">Warning: This action cannot be undone!</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3 rtl:space-x-reverse">
                            <button onclick="closeCleanupModal()"
                                    class="flex-1 px-4 py-2 border border-gray-300 dark:border-dark-600 rounded-lg text-gray-700 dark:text-gray-300 bg-white dark:bg-dark-700 hover:bg-gray-50 dark:hover:bg-dark-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all duration-200">
                                <span data-translate="Cancel">Cancel</span>
                            </button>
                            <button onclick="cleanupTunnels()"
                                    class="px-4 py-2 border border-transparent rounded-lg text-white bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 transition-all duration-200">
                                <span data-translate="Smart Cleanup">Smart Cleanup</span>
                            </button>
                            <button onclick="deleteAllTunnels()"
                                    class="px-4 py-2 border border-transparent rounded-lg text-white bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all duration-200">
                                <span data-translate="Delete All">Delete All</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    document.getElementById('cleanupModal').style.display = 'block';
    
    if (window.langManager) {
        window.langManager.translatePage();
    }
}

function closeCleanupModal() {
    const modal = document.getElementById('cleanupModal');
    if (modal) {
        modal.remove();
    }
}

// Smart translation for tunnels page - only when Persian is selected
function smartTranslateTunnels() {
    // Check if current language is Persian
    const currentLang = localStorage.getItem('language') || 'en';
    if (currentLang !== 'fa') {
        console.log('Not Persian language, skipping additional translation');
        return;
    }
    
    console.log('Smart translating tunnels page for Persian...');
    
    // First try to use the global translation system
    if (typeof applyTranslations === 'function') {
        console.log('Using global applyTranslations function');
        applyTranslations();
    } else if (window.translations && window.translations.fa) {
        console.log('Using manual translation with window.translations');
        // Manual translation fallback
        const faTranslations = window.translations.fa;
        document.querySelectorAll('[data-translate]').forEach(element => {
            const key = element.getAttribute('data-translate');
            if (faTranslations[key]) {
                console.log('Translating:', key, '->', faTranslations[key]);
                element.textContent = faTranslations[key];
            }
        });
    } else {
        console.log('No translation system available, using hardcoded translations');
        // Hardcoded translations as last resort
        const hardcodedTranslations = {
            'Tunnels': 'تانل‌ها',
            'Home': 'خانه',
            'New Tunnel': 'تانل جدید',
            'Cleanup': 'پاکسازی',
            'Type': 'نوع',
            'Remote': 'راه دور',
            'Tunnel IP': 'آی‌پی تانل',
            'Target': 'هدف',
            'Protocol': 'پروتکل',
            'Clients': 'کلاینت‌ها',
            'All Clients': 'همه کلاینت‌ها',
            'Selected': 'انتخاب شده',
            'In': 'ورودی',
            'Out': 'خروجی',
            'Last seen': 'آخرین مشاهده',
            'Never': 'هرگز',
            'Stop': 'توقف',
            'Start': 'شروع',
            'Edit': 'ویرایش',
            'Delete': 'حذف',
            'Tunnel Name': 'نام تانل',
            'Tunnel Type': 'نوع تانل',
            'Select tunnel type': 'نوع تانل را انتخاب کنید',
            'WireGuard to WireGuard': 'WireGuard به WireGuard',
            'Description (Optional)': 'توضیحات (اختیاری)',
            'Client Routing': 'مسیریابی کلاینت',
            'Route all clients through this tunnel': 'همه کلاینت‌ها را از طریق این تانل مسیریابی کن',
            'Route only selected clients': 'فقط کلاینت‌های انتخاب شده را مسیریابی کن',
            'Select Clients': 'انتخاب کلاینت‌ها',
            'WireGuard Configuration': 'پیکربندی WireGuard',
            'Generate Keypair': 'تولید جفت کلید',
            'Manual Entry': 'ورود دستی',
            'Generate or manually enter your keypair': 'جفت کلید خود را تولید کنید یا به صورت دستی وارد کنید',
            'Local Private Key': 'کلید خصوصی محلی',
            'Enter your private key and public key will be auto-generated': 'کلید خصوصی خود را وارد کنید و کلید عمومی به طور خودکار تولید می‌شود',
            'Local Public Key (Auto-generated)': 'کلید عمومی محلی (تولید خودکار)',
            'Remote Endpoint (IP:Port)': 'نقطه پایانی راه دور (IP:Port)',
            'Our Tunnel IP': 'آی‌پی تانل ما',
            'Remote Public Key': 'کلید عمومی راه دور',
            'Allowed IPs (comma separated)': 'آی‌پی‌های مجاز (جدا شده با کاما)',
            'WARNING:': 'هشدار:',
            'PreShared Key (Optional)': 'کلید از پیش تعیین شده (اختیاری)',
            'Generate': 'تولید',
            'Optional: Adds an extra layer of symmetric-key cryptography': 'اختیاری: یک لایه اضافی از رمزنگاری کلید متقارن اضافه می‌کند',
            'Cancel': 'لغو',
            'Create Tunnel': 'ایجاد تانل',
            'Cleanup Corrupted Tunnels': 'پاکسازی تانل‌های خراب',
            'This will remove any corrupted tunnel records that cannot be loaded properly.': 'این عمل تمام رکوردهای تانل خراب که نمی‌توانند به درستی بارگذاری شوند را حذف می‌کند.',
            'Warning:': 'هشدار:',
            'This action cannot be undone!': 'این عمل قابل برگشت نیست!',
            'Smart Cleanup': 'پاکسازی هوشمند',
            'Delete All': 'حذف همه',
            'No tunnels configured. Add a new tunnel to get started.': 'هیچ تانلی پیکربندی نشده است. برای شروع یک تانل جدید اضافه کنید.',
            'Manage network tunnels and routing': 'مدیریت تانل‌های شبکه و مسیریابی',
            'Tunnel Routing Setup Required': 'راه‌اندازی مسیریابی تانل مورد نیاز است',
            'For tunnels to work properly, you need to set up routing rules on your server. Run this command as root:': 'برای کارکرد صحیح تانل‌ها، باید قوانین مسیریابی را روی سرور خود تنظیم کنید. این دستور را به عنوان root اجرا کنید:',
            'This will configure iptables rules for traffic forwarding and enable IP forwarding.': 'این کار قوانین iptables را برای انتقال ترافیک پیکربندی کرده و IP forwarding را فعال می‌کند.',
            'Important Notes': 'نکات مهم',
            'Safe Routing:': 'مسیریابی امن:',
            'AllowedIPs of': 'آی‌پی‌های مجاز',
            'is automatically replaced with private networks to prevent server disconnection': 'به طور خودکار با شبکه‌های خصوصی جایگزین می‌شود تا از قطع اتصال سرور جلوگیری شود',
            'Edit Restriction:': 'محدودیت ویرایش:',
            'Active tunnels cannot be edited - stop the tunnel first': 'تانل‌های فعال قابل ویرایش نیستند - ابتدا تانل را متوقف کنید',
            'Interface Names:': 'نام‌های رابط:',
            'Tunnel interfaces use format': 'رابط‌های تانل از فرمت استفاده می‌کنند',
            'Traffic Forwarding:': 'انتقال ترافیک:',
            'Ensure your server has proper iptables rules for traffic forwarding': 'اطمینان حاصل کنید که سرور شما قوانین iptables مناسب برای انتقال ترافیک دارد',
            'Stop tunnel first to edit': 'برای ویرایش ابتدا تانل را متوقف کنید',
            'Using 0.0.0.0/0 will route ALL traffic through tunnel and may disconnect your server! Use private networks only for safety.': 'استفاده از 0.0.0.0/0 تمام ترافیک را از طریق تانل مسیریابی می‌کند و ممکن است سرور شما را قطع کند! برای امنیت فقط از شبکه‌های خصوصی استفاده کنید.'
        };
        
        document.querySelectorAll('[data-translate]').forEach(element => {
            const key = element.getAttribute('data-translate');
            if (hardcodedTranslations[key]) {
                console.log('Hardcoded translating:', key, '->', hardcodedTranslations[key]);
                element.textContent = hardcodedTranslations[key];
            }
        });
    }
    
    // Additional translations for elements that might not be caught by the main system
    const additionalTranslations = {
        'test': 'تست',
        'wg-to-wg': 'WG به WG',
        'active': 'فعال',
        'inactive': 'غیرفعال',
        'B': 'بایت'
    };
    
    // Apply additional translations only to specific elements that need it
    document.querySelectorAll('.badge, .card-title').forEach(element => {
        const text = element.textContent.trim();
        if (additionalTranslations[text]) {
            element.textContent = additionalTranslations[text];
        }
    });
    
    console.log('Smart translation completed');
}

// Run smart translation when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Tunnels page DOM loaded');
    
    // Wait for the main translation system to load first
    setTimeout(function() {
        console.log('Running translation check...');
        console.log('Current language:', localStorage.getItem('language'));
        console.log('langManager exists:', typeof window.langManager);
        console.log('translatePage exists:', window.langManager && typeof window.langManager.translatePage);
        console.log('applyTranslations exists:', typeof applyTranslations);
        console.log('window.translations exists:', typeof window.translations);
        
        // Apply main translation system
        if (window.langManager && window.langManager.translatePage) {
            console.log('Applying main translation system');
            window.langManager.translatePage();
        } else {
            console.log('Main translation system not available, trying manual approach');
            // Fallback: manually call translation if langManager is not ready
            if (typeof applyTranslations === 'function') {
                applyTranslations();
            }
        }
        
        // Then apply additional translations
        smartTranslateTunnels();
    }, 200);
    
    // Also try earlier
    setTimeout(function() {
        console.log('Early translation attempt...');
        smartTranslateTunnels();
    }, 50);
    
    // Also run translation when modals are opened
    $('.modal').on('shown.bs.modal', function() {
        setTimeout(function() {
            if (window.langManager && window.langManager.translatePage) {
                window.langManager.translatePage();
            }
            smartTranslateTunnels();
        }, 100);
    });
    
    // Run translation when AJAX requests complete
    $(document).ajaxComplete(function() {
        setTimeout(function() {
            if (window.langManager && window.langManager.translatePage) {
                window.langManager.translatePage();
            }
            smartTranslateTunnels();
        }, 100);
    });
});
</script>
<script>
$(document).ready(function() {
    // Load client list on modal open
    $('#modal_new_tunnel').on('shown.bs.modal', function() {
        loadClientList();
        // Ensure tunnel config is shown if type is already selected
        setTimeout(function() {
            if ($('#tunnel_type').val()) {
                showTunnelConfig();
            }
        }, 100);
    });

    // Handle client routing radio button changes
    $('input[name="client_routing"]').change(function() {
        if ($(this).val() === 'selected') {
            $('#client_selection').show();
            loadClientList();
        } else {
            $('#client_selection').hide();
        }
    });

    // Start auto-refresh for tunnel statistics
    startTunnelStatsRefresh();
    
    // Test jQuery and elements
    console.log('jQuery loaded:', typeof $ !== 'undefined');
    console.log('tunnel_type element exists:', $('#tunnel_type').length > 0);
    console.log('wg_config element exists:', $('#wg_config').length > 0);

    // Handle tunnel form submission (create/edit)
    $('#frm_new_tunnel').on('submit', function(e) {
        e.preventDefault();
        
        console.log('Form submitted!');
        
        const tunnelId = $('#modal_new_tunnel').data('tunnel-id');
        const isEdit = !!tunnelId;
        
        const tunnelType = $('#tunnel_type').val();
        const formData = {
            name: $('#tunnel_name').val(),
            type: tunnelType,
            description: $('#description').val(),
            route_all: $('input[name="client_routing"]:checked').val() === 'all',
            client_ids: []
        };

        console.log('Form data before validation:', formData);

        // Validate required fields
        if (!formData.name) {
            alert('Please enter tunnel name');
            return;
        }
        if (!formData.type) {
            alert('Please select tunnel type');
            return;
        }

        // Get selected clients if not routing all
        if (!formData.route_all) {
            $('input[name="client_ids"]:checked').each(function() {
                formData.client_ids.push($(this).val());
            });
        }

        // Add type-specific configuration
        if (tunnelType === 'wg-to-wg') {
            if (!$('#wg_remote_endpoint').val() || !$('#wg_remote_public_key').val()) {
                alert('Please fill all WireGuard configuration fields');
                return;
            }
            
            // Get keys from either generated or manual entry
            let localPrivateKey = $('#wg_config').data('private-key') || $('#wg_manual_private_key').val();
            let localPublicKey = $('#wg_config').data('public-key') || $('#wg_manual_public_key').val();
            
            if (!localPrivateKey || !localPublicKey) {
                alert('Please generate a keypair or enter private key manually');
                return;
            }
            
            formData.wg_config = {
                remote_endpoint: $('#wg_remote_endpoint').val(),
                remote_public_key: $('#wg_remote_public_key').val(),
                tunnel_ip: $('#wg_tunnel_ip').val(),
                allowed_ips: $('#wg_allowed_ips').val().split(',').map(ip => ip.trim()),
                local_private_key: localPrivateKey,
                local_public_key: localPublicKey,
                preshared_key: $('#wg_preshared_key').val()
            };
        } else if (tunnelType === 'wg-to-dokodemo') {
            if (!$('#dokodemo_address').val() || !$('#dokodemo_port').val()) {
                alert('Please fill all Dokodemo configuration fields');
                return;
            }
            formData.dokodemo_config = {
                address: $('#dokodemo_address').val(),
                port: parseInt($('#dokodemo_port').val()),
                network: $('#dokodemo_network').val(),
                timeout: parseInt($('#dokodemo_timeout').val()) || 300,
                domain_strategy: $('#dokodemo_domain_strategy').val(),
                follow_redirect: $('#dokodemo_follow_redirect').is(':checked')
            };
        } else if (tunnelType === 'port-forward') {
            if (!$('#pf_remote_host').val() || !$('#pf_remote_port').val()) {
                alert('Please fill all Port Forward configuration fields');
                return;
            }
            formData.port_forward_config = {
                protocol: $('#pf_protocol').val(),
                local_bind_port: parseInt($('#pf_local_port').val()),
                remote_host: $('#pf_remote_host').val(),
                remote_port: parseInt($('#pf_remote_port').val()),
                transparent: $('#pf_transparent').is(':checked')
            };
        }
        
        console.log('Final form data:', formData);
        
        // Determine URL and method based on create/edit mode
        const url = isEdit ? `{{.basePath}}/api/tunnel/${tunnelId}` : '{{.basePath}}/api/tunnel';
        const method = isEdit ? 'PUT' : 'POST';
        const action = isEdit ? 'updated' : 'created';
        
        $.ajax({
            url: url,
            method: method,
            contentType: 'application/json',
            data: JSON.stringify(formData)
        })
        .done(function(response) {
            console.log('API Response:', response);
            if (response.success) {
                alert(`Tunnel ${action} successfully!`);
                $('#modal_new_tunnel').modal('hide');
                setTimeout(function() {
                    location.reload();
                }, 500);
            } else {
                alert('Error: ' + (response.message || 'Unknown error'));
            }
        })
        .fail(function(xhr, status, error) {
            console.error('API Error:', xhr, status, error);
            console.error('Response Text:', xhr.responseText);
            alert(`Error ${action.replace('ed', 'ing')} tunnel: ` + (xhr.responseText || error));
        });
    });
    
    // Reset form when modal is closed
    $('#modal_new_tunnel').on('hidden.bs.modal', function() {
        $('#frm_new_tunnel')[0].reset();
        $('#wg_config, #dokodemo_config, #port_forward_config, #manual_key_section').hide();
        $('#wg_config .alert').remove();
        $('#wg_manual_private_key, #wg_manual_public_key, #wg_preshared_key').val('');
        $('#wg_config').removeData('private-key public-key');
        $('#client_selection').hide();
        $('input[name="client_routing"][value="all"]').prop('checked', true);
        
        // Reset modal for create mode
        $('#modal_new_tunnel').removeData('tunnel-id');
        $('#modal_new_tunnel .modal-title').text('New Tunnel');
        $('#frm_new_tunnel button[type="submit"]').text('Create Tunnel');
    });
});

function showTunnelConfig() {
    const tunnelType = $('#tunnel_type').val();
    console.log('showTunnelConfig called with type:', tunnelType);
    
    // Reset all required attributes first
    $('#wg_remote_endpoint, #wg_remote_public_key, #dokodemo_address, #dokodemo_port, #pf_remote_host, #pf_remote_port').removeAttr('required');
    
    // Hide all config sections
    $('#wg_config, #dokodemo_config, #port_forward_config').hide();
    
    // Show relevant config section and set required fields
    if (tunnelType === 'wg-to-wg') {
        console.log('Showing WireGuard config section');
        $('#wg_config').show();
        $('#wg_remote_endpoint, #wg_remote_public_key').attr('required', 'required');
        
        // Run translation after showing the config
        setTimeout(smartTranslateTunnels, 100);
    } else if (tunnelType === 'wg-to-dokodemo') {
        console.log('Showing Dokodemo config section');
        $('#dokodemo_config').show();
        $('#dokodemo_address, #dokodemo_port').attr('required', 'required');
    } else if (tunnelType === 'port-forward') {
        console.log('Showing Port Forward config section');
        $('#port_forward_config').show();
        $('#pf_remote_host, #pf_remote_port').attr('required', 'required');
    }
}

function generateWireGuardKeys() {
    console.log('Generating WireGuard keypair...');
    
    // Hide manual key section
    $('#manual_key_section').hide();
    
    $.ajax({
        url: '{{.basePath}}/api/tunnel/generate-keypair',
        method: 'POST',
        contentType: 'application/json'
    })
    .done(function(response) {
        console.log('Keypair response:', response);
        if (response.success) {
            // Store the private key (will be used when creating tunnel)
            $('#wg_config').data('private-key', response.private_key);
            $('#wg_config').data('public-key', response.public_key);
            
            // Remove any existing alerts
            $('#wg_config .alert').remove();
            
            // Show info to user
            const infoHtml = `
                <div class="alert alert-success">
                    <strong>✓ Keypair Generated!</strong><br>
                    <small>Private Key: <code>${response.private_key}</code></small><br>
                    <small>Public Key: <code>${response.public_key}</code></small><br>
                    <small class="text-success">Add the public key to your remote WireGuard server</small>
                </div>
            `;
            $('#wg_config').prepend(infoHtml);
        } else {
            alert('Error generating keypair: ' + (response.message || 'Unknown error'));
        }
    })
    .fail(function(xhr, status, error) {
        console.error('Keypair generation failed:', xhr, status, error);
        console.error('Response text:', xhr.responseText);
        alert('Error generating keypair: ' + (xhr.responseText || error));
    });
}

function showManualKeyEntry() {
    console.log('Showing manual key entry...');
    
    // Remove any existing alerts
    $('#wg_config .alert').remove();
    
    // Show manual key section
    $('#manual_key_section').show();
    
    // Clear stored keys
    $('#wg_config').removeData('private-key public-key');
    
    // Focus on private key field
    $('#wg_manual_private_key').focus();
}

function generatePublicKeyFromPrivate() {
    const privateKey = $('#wg_manual_private_key').val().trim();
    
    if (!privateKey) {
        $('#wg_manual_public_key').val('');
        return;
    }
    
    console.log('Generating public key from private key:', privateKey);
    
    $.ajax({
        url: '{{.basePath}}/api/tunnel/generate-keypair',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            private_key: privateKey
        })
    })
    .done(function(response) {
        console.log('Public key response:', response);
        if (response.success) {
            $('#wg_manual_public_key').val(response.public_key);
            
            // Store keys for form submission
            $('#wg_config').data('private-key', response.private_key);
            $('#wg_config').data('public-key', response.public_key);
            
            // Show success message
            $('#wg_config .alert').remove();
            const infoHtml = `
                <div class="alert alert-success">
                    <strong>✓ Public Key Generated!</strong><br>
                    <small>Private Key: <code>${response.private_key}</code></small><br>
                    <small>Public Key: <code>${response.public_key}</code></small><br>
                    <small class="text-success">Add the public key to your remote WireGuard server</small>
                </div>
            `;
            $('#wg_config').prepend(infoHtml);
        } else {
            $('#wg_manual_public_key').val('');
            alert('Error generating public key: ' + (response.message || 'Invalid private key'));
        }
    })
    .fail(function(xhr, status, error) {
        console.error('Public key generation failed:', xhr, status, error);
        console.error('Response text:', xhr.responseText);
        $('#wg_manual_public_key').val('');
        alert('Error generating public key: ' + (xhr.responseText || 'Invalid private key format'));
    });
}

function generatePreSharedKey() {
    console.log('Generating PreShared Key...');
    
    $.ajax({
        url: '{{.basePath}}/api/tunnel/generate-preshared-key',
        method: 'POST',
        contentType: 'application/json'
    })
    .done(function(response) {
        console.log('PreShared key response:', response);
        if (response.success) {
            $('#wg_preshared_key').val(response.preshared_key);
        } else {
            alert('Error generating PreShared key: ' + (response.message || 'Unknown error'));
        }
    })
    .fail(function(xhr, status, error) {
        console.error('PreShared key generation failed:', xhr, status, error);
        alert('Error generating PreShared key');
    });
}

function loadClientList() {
    console.log('Loading client list...');
    $.ajax({
        url: '{{.basePath}}/api/clients',
        method: 'GET'
    })
    .done(function(response) {        
        let clientHtml = '';
        console.log('Client list response:', response);
        
        // GetClients API response structure: {success: true, data: [{Client: {...}, QRCode: "..."}, ...]}
        let clientsData = [];
        if (response && response.success && Array.isArray(response.data)) {
            clientsData = response.data;
            console.log('Found', clientsData.length, 'client data objects');
        } else {
            console.error('Unexpected API response structure:', response);
            $('#client_list').html('<div class="alert alert-warning">Unexpected API response structure</div>');
            return;
        }
        
        if (!clientsData || clientsData.length === 0) {
            $('#client_list').html('<div class="alert alert-info">No clients available. Please create some clients first in the <a href="/">Wireguard Clients</a> section.</div>');
            return;
        }
        
        clientsData.forEach(function(clientDataObj, index) {
            console.log('Processing client data object', index, ':', clientDataObj);
            
            // ClientData structure: {Client: {...}, QRCode: "..."}
            // کلیدها با حروف بزرگ هستن: Client نه client
            const client = clientDataObj.Client || clientDataObj.client;
            
            if (client && client.id && client.name) {
                const ips = client.allocated_ips || client.AllocatedIPs || [];
                const ipStr = Array.isArray(ips) ? ips.join(', ') : (typeof ips === 'string' ? ips : 'N/A');
                const clientName = client.name || client.Name || 'Unnamed Client';
                
                clientHtml += `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="client_ids" value="${client.id}" id="client_${client.id}">
                        <label class="form-check-label" for="client_${client.id}">
                            <strong>${clientName}</strong><br>
                            <small class="text-muted">IPs: ${ipStr}</small>
                        </label>
                    </div>
                `;
                console.log('Added client:', clientName, 'with ID:', client.id, 'and IPs:', ipStr);
            } else {
                console.warn('Invalid client data in object', index, ':', clientDataObj);
                console.warn('Client object found:', client);
            }
        });
        
        if (clientHtml === '') {
            $('#client_list').html('<div class="alert alert-warning">No valid clients found. Please check if you have created any clients in the <a href="/">Wireguard Clients</a> section.</div>');
            console.warn('No valid clients processed from', clientsData.length, 'client data objects');
        } else {
            $('#client_list').html(clientHtml);
            console.log('Successfully processed and displayed clients');
        }
    })
    .fail(function(xhr, status, error) {
        console.error('Failed to load clients:', xhr, status, error);
        console.error('Response text:', xhr.responseText);
        $('#client_list').html('<div class="alert alert-danger">Failed to load clients: ' + (xhr.responseText || error) + '<br>Please check if you have created any clients in the <a href="/">Wireguard Clients</a> section.</div>');
    });
}

function editTunnel(tunnelId) {
    // Load tunnel data
    $.ajax({
        url: '{{.basePath}}/api/tunnel/' + tunnelId,
        method: 'GET'
    })
    .done(function(tunnel) {
        // Populate basic fields
        $('#tunnel_name').val(tunnel.name);
        $('#tunnel_type').val(tunnel.type);
        $('#description').val(tunnel.description);
        
        // Show config for this tunnel type
        showTunnelConfig();
        
        // Populate type-specific fields
        if (tunnel.type === 'wg-to-wg' && tunnel.wg_config) {
            $('#wg_remote_endpoint').val(tunnel.wg_config.remote_endpoint);
            $('#wg_remote_public_key').val(tunnel.wg_config.remote_public_key);
            $('#wg_tunnel_ip').val(tunnel.wg_config.tunnel_ip);
            if (tunnel.wg_config.allowed_ips && Array.isArray(tunnel.wg_config.allowed_ips)) {
                $('#wg_allowed_ips').val(tunnel.wg_config.allowed_ips.join(', '));
            }
            
            // Load private/public key if available
            if (tunnel.wg_config.local_private_key) {
                $('#wg_manual_private_key').val(tunnel.wg_config.local_private_key);
                $('#manual_key_section').show();
            }
            if (tunnel.wg_config.local_public_key) {
                $('#wg_manual_public_key').val(tunnel.wg_config.local_public_key);
            }
            
            // Load PreShared Key if available
            if (tunnel.wg_config.preshared_key) {
                $('#wg_preshared_key').val(tunnel.wg_config.preshared_key);
            }
            
            // Store keys for form submission
            $('#wg_config').data('private-key', tunnel.wg_config.local_private_key || '');
            $('#wg_config').data('public-key', tunnel.wg_config.local_public_key || '');
        } else if (tunnel.type === 'wg-to-dokodemo' && tunnel.dokodemo_config) {
            $('#dokodemo_address').val(tunnel.dokodemo_config.address);
            $('#dokodemo_port').val(tunnel.dokodemo_config.port);
            $('#dokodemo_network').val(tunnel.dokodemo_config.network);
            $('#dokodemo_timeout').val(tunnel.dokodemo_config.timeout || 300);
            $('#dokodemo_domain_strategy').val(tunnel.dokodemo_config.domain_strategy || 'AsIs');
            $('#dokodemo_follow_redirect').prop('checked', tunnel.dokodemo_config.follow_redirect || false);
        } else if (tunnel.type === 'port-forward' && tunnel.port_forward_config) {
            $('#pf_protocol').val(tunnel.port_forward_config.protocol);
            $('#pf_local_port').val(tunnel.port_forward_config.local_bind_port);
            $('#pf_remote_host').val(tunnel.port_forward_config.remote_host);
            $('#pf_remote_port').val(tunnel.port_forward_config.remote_port);
            $('#pf_transparent').prop('checked', tunnel.port_forward_config.transparent);
        }
        
        // Set client routing
        if (tunnel.route_all) {
            $('input[name="client_routing"][value="all"]').prop('checked', true);
        } else {
            $('input[name="client_routing"][value="selected"]').prop('checked', true);
            $('#client_selection').show();
            // Mark selected clients (will be loaded via loadClientList)
        }
        
        // Change modal title, button text and store tunnel ID
        $('#modal_new_tunnel .modal-title').text('Edit Tunnel');
        $('#frm_new_tunnel button[type="submit"]').text('Update Tunnel');
        $('#modal_new_tunnel').data('tunnel-id', tunnelId);
        
        // Load and mark selected clients
        loadClientList();
        setTimeout(function() {
            if (tunnel.client_ids && tunnel.client_ids.length > 0) {
                tunnel.client_ids.forEach(function(clientId) {
                    $(`#client_${clientId}`).prop('checked', true);
                });
            }
        }, 500);
        
        $('#modal_new_tunnel').modal('show');
    })
    .fail(function() {
        alert('Error loading tunnel data');
    });
}

function deleteTunnel(tunnelId) {
    if (confirm('Are you sure you want to delete this tunnel? This will affect client routing.')) {
        $.ajax({
            url: '{{.basePath}}/api/tunnel/' + tunnelId,
            method: 'DELETE',
            contentType: 'application/json'
        })
        .done(function(response) {
            if (response.success) {
                location.reload();
            } else {
                alert('Error: ' + response.message);
            }
        })
        .fail(function() {
            alert('Error deleting tunnel');
        });
    }
}

function startTunnel(tunnelId) {
    console.log('Starting tunnel:', tunnelId);
    
    // Disable button and show loading
    const startBtn = event.target;
    const originalText = startBtn.innerHTML;
    startBtn.disabled = true;
    startBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2 rtl:mr-0 rtl:ml-2"></i><span data-translate="Starting...">Starting...</span>';
    
    // Create AbortController for timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 seconds timeout
    
    fetch('{{.basePath}}/api/tunnel/' + tunnelId + '/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        signal: controller.signal
    })
    .then(response => {
        clearTimeout(timeoutId);
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Show success toast
            if (typeof toastr !== 'undefined') {
                toastr.success('Tunnel started successfully!');
            } else {
                alert('Tunnel started successfully!');
            }
            location.reload();
        } else {
            throw new Error(data.message || 'Unknown error');
        }
    })
    .catch(error => {
        clearTimeout(timeoutId);
        console.error('Start tunnel failed:', error);
        
        let errorMessage = 'Error starting tunnel';
        if (error.name === 'AbortError') {
            errorMessage = 'Request timeout - tunnel start is taking too long';
        } else if (error.message) {
            errorMessage = error.message;
        }
        
        // Show error toast
        if (typeof toastr !== 'undefined') {
            toastr.error(errorMessage);
        } else {
            alert(errorMessage);
        }
    })
    .finally(() => {
        // Re-enable button
        startBtn.disabled = false;
        startBtn.innerHTML = originalText;
    });
}

function stopTunnel(tunnelId) {
    console.log('Stopping tunnel:', tunnelId);
    
    // Disable button and show loading
    const stopBtn = event.target;
    const originalText = stopBtn.innerHTML;
    stopBtn.disabled = true;
    stopBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2 rtl:mr-0 rtl:ml-2"></i><span data-translate="Stopping...">Stopping...</span>';
    
    // Create AbortController for timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 seconds timeout
    
    fetch('{{.basePath}}/api/tunnel/' + tunnelId + '/stop', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        signal: controller.signal
    })
    .then(response => {
        clearTimeout(timeoutId);
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Show success toast
            if (typeof toastr !== 'undefined') {
                toastr.success('Tunnel stopped successfully!');
            } else {
                alert('Tunnel stopped successfully!');
            }
            location.reload();
        } else {
            throw new Error(data.message || 'Unknown error');
        }
    })
    .catch(error => {
        clearTimeout(timeoutId);
        console.error('Stop tunnel failed:', error);
        
        let errorMessage = 'Error stopping tunnel';
        if (error.name === 'AbortError') {
            errorMessage = 'Request timeout - tunnel stop is taking too long';
        } else if (error.message) {
            errorMessage = error.message;
        }
        
        // Show error toast
        if (typeof toastr !== 'undefined') {
            toastr.error(errorMessage);
        } else {
            alert(errorMessage);
        }
    })
    .finally(() => {
        // Re-enable button
        stopBtn.disabled = false;
        stopBtn.innerHTML = originalText;
    });
}

function cleanupTunnels() {
    if (confirm('Are you sure you want to cleanup corrupted tunnels? This action cannot be undone!')) {
        fetch('{{.basePath}}/api/tunnel/cleanup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success toast
                if (typeof toastr !== 'undefined') {
                    toastr.success('Tunnel cleanup completed successfully!');
                } else {
                    alert('Tunnel cleanup completed successfully!');
                }
                closeCleanupModal();
                location.reload();
            } else {
                throw new Error(data.message || 'Unknown error');
            }
        })
        .catch(error => {
            console.error('Cleanup failed:', error);
            if (typeof toastr !== 'undefined') {
                toastr.error('Error cleaning up tunnels: ' + error.message);
            } else {
                alert('Error cleaning up tunnels: ' + error.message);
            }
        });
    }
}

function deleteAllTunnels() {
    if (confirm('⚠️ WARNING: This will delete ALL tunnels permanently!\n\nThis action cannot be undone. Are you sure?')) {
        if (confirm('⚠️ FINAL CONFIRMATION: Delete ALL tunnel records?')) {
            fetch('{{.basePath}}/api/tunnel/cleanup/all', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success toast
                    if (typeof toastr !== 'undefined') {
                        toastr.success('All tunnels deleted successfully!');
                    } else {
                        alert('All tunnels deleted successfully!');
                    }
                    closeCleanupModal();
                    location.reload();
                } else {
                    throw new Error(data.message || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Delete all failed:', error);
                if (typeof toastr !== 'undefined') {
                    toastr.error('Error deleting tunnels: ' + error.message);
                } else {
                    alert('Error deleting tunnels: ' + error.message);
                }
            });
        }
    }
}

// Format bytes to human readable format
function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Start auto-refresh for tunnel statistics
function startTunnelStatsRefresh() {
    // Refresh stats every 30 seconds for active tunnels
    setInterval(function() {
        refreshActiveTunnelStats();
    }, 30000);
}

// Refresh statistics for active tunnels
function refreshActiveTunnelStats() {
    // Find all active tunnel elements (those with green status badges)
    document.querySelectorAll('.bg-green-100, .dark\\:bg-green-900\\/20').forEach(badge => {
        const tunnelCard = badge.closest('[data-tunnel-id]') || badge.closest('div').querySelector('[data-tunnel-id]');
        if (tunnelCard) {
            const tunnelId = tunnelCard.getAttribute('data-tunnel-id');
            
            if (tunnelId) {
                fetch('{{.basePath}}/api/tunnel/' + tunnelId + '/stats', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(stats => {
                    // Find the parent card container
                    const card = tunnelCard.closest('.bg-white, .dark\\:bg-dark-800');
                    if (card) {
                        // Update bytes in
                        const bytesInElement = card.querySelector('[data-stat="bytes_in"]');
                        if (bytesInElement) {
                            bytesInElement.textContent = formatBytes(stats.bytes_in);
                        }
                        
                        // Update bytes out
                        const bytesOutElement = card.querySelector('[data-stat="bytes_out"]');
                        if (bytesOutElement) {
                            bytesOutElement.textContent = formatBytes(stats.bytes_out);
                        }
                        
                        // Update last seen
                        if (stats.last_seen) {
                            const lastSeenElement = card.querySelector('[data-stat="last_seen"]');
                            if (lastSeenElement) {
                                const lastSeen = new Date(stats.last_seen).toLocaleString();
                                lastSeenElement.textContent = lastSeen;
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Failed to refresh tunnel stats for ' + tunnelId + ':', error);
                });
            }
        }
    });
}

// Manual refresh button for tunnel stats
function refreshTunnelStats(tunnelId) {
    fetch('{{.basePath}}/api/tunnel/' + tunnelId + '/stats', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(stats => {
        // Find the tunnel card
        const tunnelElement = document.querySelector('[data-tunnel-id="' + tunnelId + '"]');
        if (tunnelElement) {
            const card = tunnelElement.closest('.bg-white, .dark\\:bg-dark-800');
            if (card) {
                // Update bytes in
                const bytesInElement = card.querySelector('[data-stat="bytes_in"]');
                if (bytesInElement) {
                    bytesInElement.textContent = formatBytes(stats.bytes_in);
                }
                
                // Update bytes out
                const bytesOutElement = card.querySelector('[data-stat="bytes_out"]');
                if (bytesOutElement) {
                    bytesOutElement.textContent = formatBytes(stats.bytes_out);
                }
                
                // Update last seen
                if (stats.last_seen) {
                    const lastSeenElement = card.querySelector('[data-stat="last_seen"]');
                    if (lastSeenElement) {
                        const lastSeen = new Date(stats.last_seen).toLocaleString();
                        lastSeenElement.textContent = lastSeen;
                    }
                }
            }
        }
        console.log('Tunnel stats refreshed for', tunnelId);
    })
    .catch(error => {
        console.error('Failed to refresh tunnel stats:', error);
        if (typeof toastr !== 'undefined') {
            toastr.error('Failed to refresh tunnel statistics');
        } else {
            alert('Failed to refresh tunnel statistics');
        }
    });
}
</script>
{{end}} 