{{define "title"}}System Monitor{{end}}

{{define "top_css"}}
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    body {
        overflow-y: auto;
        height: 100vh;
    }
    .content {
        min-height: calc(100vh - 64px);
        overflow-y: auto;
    }
    .metric-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        margin-bottom: 15px;
        height: 100%;
    }
    .status-tag {
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 14px;
        display: inline-block;
        margin: 2px;
    }
    .status-running { background: #e6f4ea; color: #137333; }
    .status-version { background: #f3e8ff; color: #7e22ce; }
    .metric-value { font-size: 24px; font-weight: 600; }
    .chart-container {
        position: relative;
        height: 200px;
        width: 100%;
    }
</style>
{{end}}

{{define "page_title"}}System Monitor{{end}}

{{define "page_content"}}
<div class="content">
    <div class="container mx-auto p-6">
        <!-- System Resource Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="metric-card">
                <div class="chart-container">
                    <canvas id="cpuChart"></canvas>
                </div>
                <div class="text-center mt-4">
                    <div class="text-gray-600">CPU</div>
                    <div class="metric-value cpu-usage">0%</div>
                    <div class="text-sm text-gray-500 cores-info">6 Cores</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="chart-container">
                    <canvas id="ramChart"></canvas>
                </div>
                <div class="text-center mt-4">
                    <div class="text-gray-600">RAM</div>
                    <div class="metric-value ram-usage">0 GB</div>
                    <div class="text-sm text-gray-500 ram-total">Total: 0 GB</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="chart-container">
                    <canvas id="swapChart"></canvas>
                </div>
                <div class="text-center mt-4">
                    <div class="text-gray-600">Swap</div>
                    <div class="metric-value swap-usage">0 MB</div>
                    <div class="text-sm text-gray-500 swap-total">Total: 0 GB</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="chart-container">
                    <canvas id="diskChart"></canvas>
                </div>
                <div class="text-center mt-4">
                    <div class="text-gray-600">Disk</div>
                    <div class="metric-value disk-usage">0 GB</div>
                    <div class="text-sm text-gray-500 disk-total">Total: 0 GB</div>
                </div>
            </div>
        </div>

        <!-- System Info & Status -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="metric-card">
                <h3 class="text-lg font-semibold mb-3">System Status</h3>
                <div class="mb-4">
                    <span class="status-tag status-version">vWireguard</span>
                    <span class="status-tag status-running">Running</span>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <div class="text-sm text-gray-600">System Load</div>
                        <div class="system-load">0 | 0 | 0</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600">Uptime</div>
                        <div class="uptime">0h 0m</div>
                    </div>
                </div>
            </div>
            
            <div class="metric-card">
                <h3 class="text-lg font-semibold mb-3">Network</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <div class="text-sm text-gray-600">Upload</div>
                        <div class="upload-speed">0 KB/s</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600">Download</div>
                        <div class="download-speed">0 KB/s</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600">Total Out</div>
                        <div class="total-out">0 MB</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600">Total In</div>
                        <div class="total-in">0 GB</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "bottom_js"}}
<script>
    let charts = {
        cpu: null,
        ram: null,
        swap: null,
        disk: null
    };

    // Function to create circular charts
    function createChart(elementId, value, color) {
        if (charts[elementId]) {
            charts[elementId].destroy();
        }

        const ctx = document.getElementById(elementId + 'Chart').getContext('2d');
        charts[elementId] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [value, 100 - value],
                    backgroundColor: [color, '#f3f4f6'],
                    borderWidth: 0
                }]
            },
            options: {
                cutout: '80%',
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 500
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
        return charts[elementId];
    }

    // Create initial charts
    createChart('cpu', 0, '#059669');
    createChart('ram', 0, '#059669');
    createChart('swap', 0, '#059669');
    createChart('disk', 0, '#f97316');

    // Function to format bytes to human readable format
    function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    let updateInProgress = false;

    // Function to update system metrics
    async function updateMetrics() {
        if (updateInProgress) return;
        updateInProgress = true;

        try {
            const response = await fetch('{{.baseData.BasePath}}/api/system-metrics');
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const data = await response.json();

            // Update CPU
            document.querySelector('.cpu-usage').textContent = data.cpu.usage.toFixed(1) + '%';
            document.querySelector('.cores-info').textContent = data.cpu.cores + ' Cores';
            createChart('cpu', data.cpu.usage, '#059669');

            // Update RAM
            const ramUsedGB = data.ram.used / (1024 * 1024 * 1024);
            const ramTotalGB = data.ram.total / (1024 * 1024 * 1024);
            document.querySelector('.ram-usage').textContent = ramUsedGB.toFixed(1) + ' GB';
            document.querySelector('.ram-total').textContent = 'Total: ' + ramTotalGB.toFixed(1) + ' GB';
            createChart('ram', data.ram.usage, '#059669');

            // Update Swap
            const swapUsedMB = data.swap.used / (1024 * 1024);
            const swapTotalGB = data.swap.total / (1024 * 1024 * 1024);
            document.querySelector('.swap-usage').textContent = swapUsedMB.toFixed(1) + ' MB';
            document.querySelector('.swap-total').textContent = 'Total: ' + swapTotalGB.toFixed(1) + ' GB';
            createChart('swap', data.swap.usage, '#059669');

            // Update Disk
            const diskUsedGB = data.disk.used / (1024 * 1024 * 1024);
            const diskTotalGB = data.disk.total / (1024 * 1024 * 1024);
            document.querySelector('.disk-usage').textContent = diskUsedGB.toFixed(1) + ' GB';
            document.querySelector('.disk-total').textContent = 'Total: ' + diskTotalGB.toFixed(1) + ' GB';
            createChart('disk', data.disk.usage, '#f97316');
            
            // Update system info
            document.querySelector('.system-load').textContent = data.systemLoad;
            document.querySelector('.uptime').textContent = data.uptime;
            
            // Update network info
            document.querySelector('.upload-speed').textContent = data.network.uploadSpeed.toFixed(1) + ' KB/s';
            document.querySelector('.download-speed').textContent = data.network.downloadSpeed.toFixed(1) + ' KB/s';
            document.querySelector('.total-out').textContent = formatBytes(data.network.totalOut * 1024 * 1024);
            document.querySelector('.total-in').textContent = formatBytes(data.network.totalIn * 1024 * 1024);
        } catch (error) {
            console.error('Error fetching system metrics:', error);
        } finally {
            updateInProgress = false;
        }
    }

    // Update metrics every 2 seconds
    const updateInterval = setInterval(updateMetrics, 2000);

    // Initial update
    updateMetrics();

    // Cleanup on page unload
    window.addEventListener('unload', () => {
        clearInterval(updateInterval);
    });
</script>
{{end}}
