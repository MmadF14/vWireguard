{{define "title"}}System Monitor{{end}}

{{define "top_css"}}
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    html, body {
        height: 100%;
        overflow: hidden;
        position: fixed;
        width: 100%;
    }
    .content {
        height: 100vh;
        overflow-y: auto;
        position: fixed;
        width: 100%;
        top: 0;
        left: 0;
    }
    .metric-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        margin-bottom: 15px;
    }
    .status-tag {
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 14px;
        display: inline-block;
        margin: 2px;
    }
    .status-running { background: #e6f4ea; color: #137333; }
    .status-version { background: #f3e8ff; color: #7e22ce; }
    .metric-value { font-size: 24px; font-weight: 600; }
</style>
{{end}}

{{define "page_title"}}System Monitor{{end}}

{{define "page_content"}}
<section class="content">
    <div class="container mx-auto p-6">
        <!-- System Resource Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="metric-card">
                <canvas id="cpuChart" class="mb-2"></canvas>
                <div class="text-center">
                    <div class="text-gray-600">CPU</div>
                    <div class="metric-value cpu-usage">0%</div>
                    <div class="text-sm text-gray-500 cores-info">6 Cores</div>
                </div>
            </div>
            <div class="metric-card">
                <canvas id="ramChart" class="mb-2"></canvas>
                <div class="text-center">
                    <div class="text-gray-600">RAM</div>
                    <div class="metric-value ram-usage">0 GB</div>
                    <div class="text-sm text-gray-500 ram-total">Total: 0 GB</div>
                </div>
            </div>
            <div class="metric-card">
                <canvas id="swapChart" class="mb-2"></canvas>
                <div class="text-center">
                    <div class="text-gray-600">Swap</div>
                    <div class="metric-value swap-usage">0 MB</div>
                    <div class="text-sm text-gray-500 swap-total">Total: 0 GB</div>
                </div>
            </div>
            <div class="metric-card">
                <canvas id="diskChart" class="mb-2"></canvas>
                <div class="text-center">
                    <div class="text-gray-600">Disk</div>
                    <div class="metric-value disk-usage">0 GB</div>
                    <div class="text-sm text-gray-500 disk-total">Total: 0 GB</div>
                </div>
            </div>
        </div>

        <!-- System Info & Status -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="metric-card">
                <h3 class="text-lg font-semibold mb-3">System Status</h3>
                <div class="mb-4">
                    <span class="status-tag status-version">vWireguard</span>
                    <span class="status-tag status-running">Running</span>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <div class="text-sm text-gray-600">System Load</div>
                        <div class="system-load">0 | 0 | 0</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600">Uptime</div>
                        <div class="uptime">0h 0m</div>
                    </div>
                </div>
            </div>
            
            <div class="metric-card">
                <h3 class="text-lg font-semibold mb-3">Network</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <div class="text-sm text-gray-600">Upload</div>
                        <div class="upload-speed">0 KB/s</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600">Download</div>
                        <div class="download-speed">0 KB/s</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600">Total Out</div>
                        <div class="total-out">0 MB</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600">Total In</div>
                        <div class="total-in">0 GB</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{{end}}

{{define "bottom_js"}}
<script>
    let metricsInterval = null;

    // Function to create circular charts
    function createChart(elementId, value, color) {
        const ctx = document.getElementById(elementId).getContext('2d');
        return new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [value, 100 - value],
                    backgroundColor: [color, '#f3f4f6'],
                    borderWidth: 0
                }]
            },
            options: {
                cutout: '80%',
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    // Create initial charts
    const cpuChart = createChart('cpuChart', 0, '#059669');
    const ramChart = createChart('ramChart', 0, '#059669');
    const swapChart = createChart('swapChart', 0, '#059669');
    const diskChart = createChart('diskChart', 0, '#f97316');

    // Function to update system metrics
    async function updateMetrics() {
        try {
            const response = await fetch('{{.baseData.BasePath}}/api/system-metrics');
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();

            // Update CPU
            document.querySelector('.cpu-usage').textContent = data.cpu.usage.toFixed(1) + '%';
            document.querySelector('.cores-info').textContent = data.cpu.cores + ' Cores';
            cpuChart.data.datasets[0].data = [data.cpu.usage, 100 - data.cpu.usage];
            cpuChart.update('none');

            // Update RAM
            const ramUsedGB = data.ram.used / (1024 * 1024 * 1024);
            const ramTotalGB = data.ram.total / (1024 * 1024 * 1024);
            document.querySelector('.ram-usage').textContent = ramUsedGB.toFixed(1) + ' GB';
            document.querySelector('.ram-total').textContent = 'Total: ' + ramTotalGB.toFixed(1) + ' GB';
            ramChart.data.datasets[0].data = [data.ram.usage, 100 - data.ram.usage];
            ramChart.update('none');

            // Update Swap
            const swapUsedMB = data.swap.used / (1024 * 1024);
            const swapTotalGB = data.swap.total / (1024 * 1024 * 1024);
            document.querySelector('.swap-usage').textContent = swapUsedMB.toFixed(1) + ' MB';
            document.querySelector('.swap-total').textContent = 'Total: ' + swapTotalGB.toFixed(1) + ' GB';
            swapChart.data.datasets[0].data = [data.swap.usage, 100 - data.swap.usage];
            swapChart.update('none');

            // Update Disk
            const diskUsedGB = data.disk.used / (1024 * 1024 * 1024);
            const diskTotalGB = data.disk.total / (1024 * 1024 * 1024);
            document.querySelector('.disk-usage').textContent = diskUsedGB.toFixed(1) + ' GB';
            document.querySelector('.disk-total').textContent = 'Total: ' + diskTotalGB.toFixed(1) + ' GB';
            diskChart.data.datasets[0].data = [data.disk.usage, 100 - data.disk.usage];
            diskChart.update('none');
            
            // Update system info
            document.querySelector('.system-load').textContent = data.systemLoad;
            document.querySelector('.uptime').textContent = data.uptime;
            
            // Update network info
            document.querySelector('.upload-speed').textContent = data.network.uploadSpeed.toFixed(1) + ' KB/s';
            document.querySelector('.download-speed').textContent = data.network.downloadSpeed.toFixed(1) + ' KB/s';
            document.querySelector('.total-out').textContent = data.network.totalOut + ' MB';
            document.querySelector('.total-in').textContent = data.network.totalIn + ' GB';
        } catch (error) {
            console.error('Error fetching system metrics:', error);
            // در صورت خطا، اینتروال را متوقف می‌کنیم
            if (metricsInterval) {
                clearInterval(metricsInterval);
                metricsInterval = null;
            }
        }
    }

    // Start updates only if not already started
    function startMetricsUpdate() {
        if (!metricsInterval) {
            // Initial update
            updateMetrics();
            // Update metrics every 2 seconds
            metricsInterval = setInterval(updateMetrics, 2000);
        }
    }

    // Stop updates
    function stopMetricsUpdate() {
        if (metricsInterval) {
            clearInterval(metricsInterval);
            metricsInterval = null;
        }
    }

    // Start updates when the page loads
    document.addEventListener('DOMContentLoaded', startMetricsUpdate);

    // Cleanup when the page is hidden or unloaded
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            stopMetricsUpdate();
        } else {
            startMetricsUpdate();
        }
    });

    window.addEventListener('unload', stopMetricsUpdate);
</script>
{{end}}
